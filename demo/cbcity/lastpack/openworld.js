/*! open.js v1.0.0 | (c) kohunglee | MIT License */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.openworld=t():e.openworld=t()}(this,()=>{var i={"./src/common/hooks.js":
/*!*****************************!*\
  !*** ./src/common/hooks.js ***!
  \*****************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={_hookQueues:new Map,on(e,t,i=100){if("function"!=typeof t)throw new TypeError("Callback must be function");var r=this._hookQueues.get(e)||[];r.push({func:t,priority:i}),r._isSorted=!1,this._hookQueues.set(e,r)},off(e,t){var i,r=this._hookQueues.get(e);r&&(0===(i=r.filter(e=>e.func!==t)).length?this._hookQueues.delete(e):i.length<r.length&&(i._isSorted=!1,this._hookQueues.set(e,i)))},_getSortedCallbacks(e){e=this._hookQueues.get(e);return e?(e._isSorted||(e.sort((e,t)=>t.priority-e.priority),e._isSorted=!0),[...e]):[]},async emit(t,...i){var e=this._getSortedCallbacks(t).map(e=>e.func).map(async e=>{try{return await e(...i)}catch(e){throw console.error(`[Async]Hook ${t} error:`,e),e}});return Promise.allSettled(e)},emitSync(t,...e){var i,r=[];for({func:i}of this._getSortedCallbacks(t))try{var o=i(...e);if(r.push({status:"fulfilled",value:o}),!1===o)break}catch(e){console.error(`[Sync]Hook ${t} error:`,e),r.push({status:"rejected",reason:e})}return r}}},"./src/core/animate.js":
/*!*****************************!*\
  !*** ./src/core/animate.js ***!
  \*****************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const a of this.currentlyActiveIndices){var e,t,i,r,o,s=8*a;0<this.positionsStatus[7+s]&&(o=(e=this.indexToArgs.get(a)).cannonBody)&&(r=o.position.x-this.positionsStatus[s],i=o.position.y-this.positionsStatus[1+s],t=o.position.z-this.positionsStatus[2+s],r=Math.sqrt(r*r+i*i+t*t),this.positionsStatus[s]=o.position.x,this.positionsStatus[1+s]=o.position.y,this.positionsStatus[2+s]=o.position.z,this.positionsStatus[3+s]=o.quaternion.x,this.positionsStatus[4+s]=o.quaternion.y,this.positionsStatus[5+s]=o.quaternion.z,this.positionsStatus[6+s]=o.quaternion.w,!1!==e.isVisualMode)&&this.W.next["T"+a]&&1e-4<r&&(i=this.quaternionToEuler(o.quaternion),this.W.move({n:"T"+a,x:this.positionsStatus[s],y:this.positionsStatus[1+s],z:this.positionsStatus[2+s],rx:i.rX,ry:i.rY,rz:i.rZ}),.01<r)&&500<performance.now()-this.gridKeyCurrentTime&&(t=e.gridkey||0,i=`${o=this.physicsProps[4+s]}_${Math.floor(this.positionsStatus[s]/this.gridsize[o])}_`+Math.floor(this.positionsStatus[2+s]/this.gridsize[o]),t&&i!==t&&((r=this.spatialGrid.get(t))&&-1<(s=r.indexOf(a))&&(r.splice(s,1),this.spatialGrid.set(t,r)),(o=(o=this.spatialGrid.get(i))||[]).push(a),this.spatialGrid.set(i,o)),e.gridkey=i,this.gridKeyCurrentTime=performance.now())}},cannonAni:function(){this.world.step(1/60)},animate:function(){var e=this;function t(){e.cannonAni(),e.updataBodylist(),e.mainVPlayerMove(e.mainVPlayer),e.hooks.emit("animatePreFrame",e),requestAnimationFrame(t)}t()}}},"./src/core/main.js":
/*!**************************!*\
  !*** ./src/core/main.js ***!
  \**************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",displayViewTime:.9,world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(e){this.canvas=window.document.getElementById(e),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate()},initW:function(e){var t=this.W;e.width=window.innerWidth*this.displayViewTime,e.height=window.innerHeight*this.displayViewTime,t.reset(e),t.ambient(.7),t.light({x:.5,y:-.3,z:.5}),t.clearColor(this.colorClear),t.camera({n:"camera",fov:this.fov}),t.group({n:"posZero",x:0,y:1,z:0}),t.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),t.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),t.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),t.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),t.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),t.pyramid({g:"posZero",size:1,z:10,rx:90,b:"44f"}),t.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}}},"./src/obj/addobj.js":
/*!***************************!*\
  !*** ./src/obj/addobj.js ***!
  \***************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(i=1e6){this.positionsStatus=new Float32Array(8*i),this.physicsProps=new Float32Array(8*i),this.freeSlots=new Array(i).fill(0).map((e,t)=>i-1-t)},addTABox:function({DPZ:e=3,X:t=5,Y:i=5,Z:r=5,quat:o={x:0,y:0,z:0,w:1},mass:s=0,width:a=1,depth:n=1,height:l=1,size:d=1,rX:c=0,rY:u=0,rZ:h=0}={}){var m=Array.from(arguments)[0];if(1!==d&&(a=n=l=d),(c||u||h)&&(o=this.eulerToQuaternion({rX:c,rY:u,rZ:h})),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;var p=this.freeSlots.pop(),f=8*p,f=(this.positionsStatus[f]=t,this.positionsStatus[1+f]=i,this.positionsStatus[2+f]=r,this.positionsStatus[3+f]=o.x,this.positionsStatus[4+f]=o.y,this.positionsStatus[5+f]=o.z,this.positionsStatus[6+f]=o.w,this.positionsStatus[7+f]=s,this.physicsProps[f]=s,this.physicsProps[1+f]=a,this.physicsProps[2+f]=l,this.physicsProps[3+f]=n,`${this.physicsProps[4+f]=e}_${Math.floor(t/this.gridsize[e])}_`+Math.floor(r/this.gridsize[e]));let g=this.spatialGrid.get(f);(g=g||[]).push(p),this.spatialGrid.set(f,g),this.indexToArgs.set(p,m)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1,isInvisible:!1},argsObj:{},activeTABox:function(t){var e,i,r,o=8*t,s=this.positionsStatus.subarray(o,8+o),o=this.physicsProps.subarray(o,4+o),a=this.indexToArgs.get(t);this.argsObj={...this.defaultBoxArgs,...a};const n=this.argsObj;n.isPhysical&&((i=new CANNON.Body).mass=o[0],i.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,e="sphere"===n.shape?new CANNON.Sphere(o[1]/2):(e=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2),new CANNON.Box(e)),i.addShape(e),i.position.set(s[0],s[1],s[2]),i.material=this.cannonDefaultContactMaterial,i.updateMassProperties(),i.wakeUp(),i.collisionFilterGroup=n.colliGroup,e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum},i.collisionFilterMask=e[n.colliGroup],this.world.addBody(i),i.quaternion.set(s[3],s[4],s[5],s[6]),a.cannonBody=i),!1!==n.isVisualMode&&(e=n.tiling,0!==s[3]&&(a=this.quaternionToEuler({x:s[3],y:s[4],z:s[5],w:s[6]}),n.rX=a.x,n.rY=a.y,n.rZ=a.z),"number"==typeof e&&(e=[e,e]),i=n.isFictBody?.1:0,a=!1,"string"==typeof n.texture?void 0!==window[n.texture]||this.textureMap.has(n.texture)?r=this.textureMap.has(n.texture)?this.textureMap.get(n.texture):window[n.texture]:a=!(r=null):r=n.texture,this.W[n.shape]({n:"T"+t,w:o[1]-i,d:o[3]-i,h:o[2]-i,x:s[0],y:s[1],z:s[2],t:r,s:n.smooth,tile:e,rx:n.rX,ry:n.rY,rz:n.rZ,b:n.background,mix:n.mixValue,shadow:n.isShadow,hidden:n.isInvisible}),a)&&(s=40*(o[1]-i),r=40*(o[2]-i),this.loadTexture([{func:this.errorTexture,id:n.texture,type:"png",width:s,height:r,index:t}]).then(e=>{this.W[n.shape]({n:"T"+t,t:this.textureMap.get(n.texture),mix:n.mixValue})}))},hiddenTABox:function(e){var t=this.indexToArgs.get(e);!1!==t.isPhysical&&void 0!==t.cannonBody&&this.world.removeBody(t.cannonBody),!1!==t.isVisualMode&&this.W.delete("T"+e)},addBox:function({DPZ:e=2,isPhysical:t=!0,isVisualMode:i=!0,kk:r=0,colliGroup:o=2,name:s="k"+this.bodyObjName++,X:a=5,Y:n=5,Z:l=5,quat:d=null,isShadow:c=0,tiling:u=[1,1],shape:h="cube",mass:m=0,width:p=1,depth:f=1,height:g=1,size:y=1,texture:v=null,smooth:x=0,background:w="#888",mixValue:b=.71,rX:M=0,rY:A=0,rZ:S=0}={}){var _,k=Array.from(arguments),B=this.calPosID(a,n,l,e),P=(1!==y&&(p=f=g=y),null),L=(t&&(_="sphere"===h?new CANNON.Sphere(p/2):(_=new CANNON.Vec3(p/2,g/2,f/2),new CANNON.Box(_)),(P=new CANNON.Body({mass:m,shape:_,position:new CANNON.Vec3(a,n,l),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=o,_={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum},P.collisionFilterMask=_[o],this.world.addBody(P),d&&P.quaternion.set(d.x,d.y,d.z,d.w),d=P.quaternion),i&&this.W[h]({n:s,w:p,d:f,h:g,x:a,y:n,z:l,t:v,s:x,tile:u="number"==typeof u?[u,u]:u,rx:M,ry:A,rz:S,b:w,mix:b,shadow:c}),{name:s,body:P,X:a,Y:n,Z:l,rX:M,rY:A,rZ:S,isVisualMode:i,myargs:k,posID:B,DPZ:e,quat:d});switch(!0){case!1===t:this.bodylistNotPys.push(L);break;case 0===m:this.bodylistMass0.push(L);break;default:this.bodylist.push(L)}return L}}},"./src/obj/chunkManager.js":
/*!*********************************!*\
  !*** ./src/obj/chunkManager.js ***!
  \*********************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={calPosID:function(e,t,i,r){var o,s,a={2:100,3:100,4:40}[r]||0;return 2===r&&(r=""),0===a?0:(o=-1===Math.sign(e)?"X":"D",s=-1===Math.sign(i)?"B":"N",r+o+Math.ceil(e/a*Math.sign(e))+s+Math.ceil(i/a*Math.sign(i)))},gridsize:new Uint16Array([1e4,1e3,100,20,5]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";var e=this.mainVPlayer,r=[];for(let i=0;i<this.gridsize.length;i++){var o=Math.floor(e.X/this.gridsize[i]),s=Math.floor(e.Z/this.gridsize[i]);for(let t=-1;t<=1;t++)for(let e=-1;e<=1;e++)r.push(`${i}_${o+t}_`+(s+e))}var t,i=new Set,a=new Set(this.currentlyActiveIndices);for(const d of r){var n=this.spatialGrid.get(d);if(n)for(const c of n)Math.abs(this.positionsStatus[8*c+1]-e.Y)<this.gridsize[this.physicsProps[8*c+4]]&&i.add(c)}for(const u of i)a.delete(u);for(const h of i)this.currentlyActiveIndices.has(h)||(t=8*h,this.positionsStatus[7+t]=this.physicsProps[t],this.activeTABox(h));for(const m of a){var l=8*m;this.positionsStatus[7+l]=-1,this.hiddenTABox(m)}this.currentlyActiveIndices=i,0<this.activationQueue.length&&!this.isActivationScheduled&&(this.isActivationScheduled=!0)}}},"./src/obj/texture.js":
/*!****************************!*\
  !*** ./src/obj/texture.js ***!
  \****************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={textureMap:new Map,loadTextureIndex:1,rasterizeCanvas:document.createElement("canvas"),loadTexture:function(e){for(var t,i=[],r=0;r<e.length;r++){const s=e[r];!0===this.textureMap.has(s.id)?i.push(Promise.resolve(this.textureMap.get(s.id))):(t=new Promise(r=>{if("svg-rasterize"===s.type){const o=new Image;o.onload=()=>{var e=this.rasterizeCanvas,t=(e.width=s.width||400,e.height=s.height||400,e.getContext("2d")),t=(t.clearRect(0,0,e.width,e.height),t.drawImage(o,0,0,e.width,e.height),e.toDataURL("image/png"));const i=new Image;i.onload=()=>{this.textureMap.set(s.id,i),r(i)},i.id=s.id,i.src=t};var e=new Blob([s.svgCode],{type:"image/svg+xml"});o.src=URL.createObjectURL(e)}else{const t=new Image;t.onload=()=>{this.textureMap.set(s.id,t),this.loadTextureIndex++,r(t)},t.id=s.id+"-"+this.loadTextureIndex,t.src=this.dToBase64(s)}}),i.push(t))}return Promise.all(i)},canvasObj:document.createElement("canvas"),dToBase64:function(e){var t,i;return"svg"===e.type?(t=e.svgCode.replace(/#/g,"%23"),"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(t)):((t=this.canvasObj).width=e.width||400,t.height=e.height||400,t.style.webkitFontSmoothing="antialiased",t.style.mozOsxFontSmoothing="grayscale",i=t.getContext("2d"),"png"===e.type?(e.func(i,t.width,t.height,e,this),t.toDataURL("image/png")):"jpg"===e.type?(i.fillStyle="white",i.fillRect(0,0,t.width,t.height),e.func(i,t.width,t.height,e,this),i=e.quality||.7,t.toDataURL("image/jpeg",i)):void 0)},errorTexture:function(e,t,i,r,o){o.hooks.emitSync("errorTexture_diy",e,t,i,r,o)}}},"./src/player/control.js":
/*!*******************************!*\
  !*** ./src/player/control.js ***!
  \*******************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var t=this,i=!1;document.addEventListener("keydown",function(e){t._handleKey(e,1)}),document.addEventListener("keyup",function(e){t._handleKey(e,0)}),document.addEventListener("mousemove",function(e){i&&(t.keys.turnRight-=.1*e.movementX,t.keys.turnUp-=.1*e.movementY)}),this.canvas.addEventListener("click",e=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),i=!0,document.pointerLockElement&&t.hooks.emitSync("pointer_lock_click",t,e)}),this.lockChangeAlert=function(){i=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()})},_handleKey:function(e,t){var i;this.isPointerLock()&&((i=this.keyMap[e.key.toLowerCase()])&&(this.keys[i]=t),32!==e.keyCode&&"e"!==e.key.toLowerCase()||null===this.mainVPlayer||(0===this.keys.jumping&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=t),16!==e.keyCode&&"q"!==e.key.toLowerCase()||(this.isShiftPress=t))},forwardAcc:0,displayPOS:function(){var e=document.getElementById("posInfo");if(!e)return 0;null!==this.mainVPlayer&&(e.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(e,t,i,r,o,s){var a,n=this.keys;return(n.viewForward||n.viewBackward)&&(a=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01),this.hooks.emit("forwardBackward",this,a),i+=(-n.viewForward+n.viewBackward)*Math.cos(o*Math.PI/180)/a,e+=(-n.viewForward+n.viewBackward)*Math.sin(o*Math.PI/180)/a,this.displayPOS()),(n.viewLeft||n.viewRight)&&(i+=(-n.viewLeft+n.viewRight)*Math.cos((o+90)*Math.PI/180)/10,e+=(-n.viewLeft+n.viewRight)*Math.sin((o+90)*Math.PI/180)/10,this.displayPOS()),o=this.keys.turnRight,{x:e,y:t,z:i,rx:this.keys.turnUp,ry:o,rz:s}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(e){var t,i,r;if(null!==e)return r=this.mainCamera,!1===this.isMVPInit&&(r.groupName=e.name,this.isMVPInit=!0),i=e.body.position,t=e.body.quaternion,i=this.calMovePara(i.x,i.y,i.z,r.qua.rx,r.qua.ry,r.qua.rz),e.body.position.x=i.x,e.body.position.y=i.y,e.body.position.z=i.z,r.qua=i,t.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*i.ry),this.W.camera({g:e.name,x:r.pos.x,y:r.pos.y,z:r.pos.z,rx:r.qua.rx,rz:r.qua.rz}),t=e.body.position,i=e.body.quaternion,r=this.quaternionToEuler(i),e.quat=i,e.rX=r.rX,e.rY=r.rY,e.rZ=r.rZ,e.X=t.x,e.Y=t.y,e.Z=t.z,this.W.move({n:e.name,x:e.X,y:e.Y,z:e.Z,rx:e.rX,ry:e.rY,rz:e.rZ}),e.posID=this.calPosID(e.X,e.Y,e.Z,2),0}}},"./src/utils/tool.js":
/*!***************************!*\
  !*** ./src/utils/tool.js ***!
  \***************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>r});const r={quaternionToEuler:function(e){var{x:e,y:t,z:i,w:r}=e,o=Math.atan2(2*(r*e+t*i),1-2*(e*e+t*t)),s=Math.asin(Math.max(-1,Math.min(1,2*(r*t-i*e)))),r=Math.atan2(2*(r*i+e*t),1-2*(t*t+i*i)),e=e=>e*(180/Math.PI);return{rX:e(o),rY:e(s),rZ:e(r)}},eulerToQuaternion:function(e){var{rX:e,rY:t,rZ:i}=e,r=e=>e*(Math.PI/180),e=.5*r(e),t=.5*r(t),r=.5*r(i),i=Math.sin(e),e=Math.cos(e),o=Math.sin(t),t=Math.cos(t),s=Math.sin(r),r=Math.cos(r);return{x:i*t*r-e*o*s,y:e*o*r+i*t*s,z:e*t*s-i*o*r,w:e*t*r+i*o*s}},genPR:function(e,t){let i=Math.abs(e)||1;i=1664525*i+1013904223|0;var r=new Float32Array(t);for(let e=0;e<t;e++)i=(i=(i^=i<<13)^i>>17)^i<<5,r[e]=(i>>>0)*(1/4294967296);return r},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})}},"./src/wjs/w_ins_lab.js":
/*!******************************!*\
  !*** ./src/wjs/w_ins_lab.js ***!
  \******************************/(e,t,i)=>{i.r(t),i.d(t,{default:()=>h});const w={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i(/*! ../common/hooks.js */"./src/common/hooks.js").default,reset:e=>{w.canvas=e,w.objs=0,w.current={},w.next={},w.textures={},w.viewLimit=5e3,w.gl=e.getContext("webgl2"),w.gl.blendFunc(770,771),w.gl.activeTexture(33984),w.program=w.gl.createProgram(),w.gl.enable(2884),w.instanceColorBuffers={},w.lastFrame=0,w.drawTime=0,w.lastReportTime=0,w.gl.shaderSource(e=w.gl.createShader(35633),`#version 300 es
          precision lowp float;                        
          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...
          in mat4 instanceModelMatrix;                  // 实例化模型的 模型
          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵
          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]
          out vec4 v_pos, v_col, v_uv, v_normal;
          uniform bool isInstanced;              // 是不是实例化绘制
          void main() {
            mat4 currentModelMatrix;             // 当前的模型矩阵
            if (isInstanced) {
              currentModelMatrix = instanceModelMatrix;
            } else {
              currentModelMatrix = m;
            }
            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos
              v_pos = bb.z > 0.                         
              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌
              : currentModelMatrix * pos               
            );
            v_col = col;
            v_uv = uv;
            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵
          }`),w.gl.compileShader(e),w.gl.attachShader(w.program,e),w.gl.shaderSource(e=w.gl.createShader(35632),`#version 300 es
          precision lowp float;
          in vec4 v_pos, v_col, v_uv, v_normal;
          uniform vec3 light;
          uniform vec2 tiling;
          uniform vec4 o;
          uniform sampler2D sampler;
          out vec4 c;
          void main() {
            vec2 final_uv = v_uv.xy;  //+ 新增纹理面修正逻辑，修复纹理面翻转问题
            if (!gl_FrontFacing) {
              final_uv.x = 1.0 - final_uv.x;
            }
            c = mix(texture(sampler, final_uv * tiling), v_col, o[3]);
            if(o[1] > 0.){
              c = vec4(
                c.rgb * (max(0., dot(light, -normalize(
                  o[0] > 0.
                  ? vec3(v_normal.xyz)
                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))
                )))
                + o[2]),
                c.a
              );
            }
          }`),w.gl.compileShader(e),w.gl.attachShader(w.program,e),w.gl.linkProgram(w.program),w.gl.useProgram(w.program),w.clearColor=e=>w.gl.clearColor(...w.col(e)),w.wjsHooks.emitSync("reset_ok",w),w.uniformLocations={pv:w.gl.getUniformLocation(w.program,"pv"),eye:w.gl.getUniformLocation(w.program,"eye"),m:w.gl.getUniformLocation(w.program,"m"),im:w.gl.getUniformLocation(w.program,"im"),bb:w.gl.getUniformLocation(w.program,"bb"),isInstanced:w.gl.getUniformLocation(w.program,"isInstanced"),o:w.gl.getUniformLocation(w.program,"o"),light:w.gl.getUniformLocation(w.program,"light"),tiling:w.gl.getUniformLocation(w.program,"tiling"),sampler:w.gl.getUniformLocation(w.program,"sampler"),u_MvpMatrixFromLight:w.gl.getUniformLocation(w.program,"u_MvpMatrixFromLight"),u_ShadowMap:w.gl.getUniformLocation(w.program,"u_ShadowMap")},w.attribLocations={pos:w.gl.getAttribLocation(w.program,"pos"),col:w.gl.getAttribLocation(w.program,"col"),uv:w.gl.getAttribLocation(w.program,"uv"),normal:w.gl.getAttribLocation(w.program,"normal"),instanceModelMatrix:w.gl.getAttribLocation(w.program,"instanceModelMatrix")},w.clearColor("fff"),w.gl.enable(2929),w.light({y:-1}),w.camera({fov:30}),setTimeout(w.draw,16)},setState:(e,t,i,r,o=[],s,a,n,l,d,c,u,h)=>{if(e.n||="o"+w.objs++,e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!w.textures[e.t.id]&&(i=w.gl.createTexture(),w.gl.pixelStorei(37441,!1),w.gl.bindTexture(3553,i),w.gl.pixelStorei(37440,1),w.gl.texImage2D(3553,0,6408,6408,5121,e.t),w.gl.generateMipmap(3553),w.textures[e.t.id]=i),e.instances&&Array.isArray(e.instances)){e.isInstanced=!0,e.numInstances=e.instances.length;var m=[],p=[];for(const v of e.instances){var f=new DOMMatrix;f.translateSelf((v.x||0)+(e.x||0),(v.y||0)+(e.y||0),(v.z||0)+(e.z||0)).rotateSelf(v.rx||0,v.ry||0,v.rz||0).scaleSelf(v.w||1,v.h||1,v.d||1),m.push(...f.toFloat32Array())}for(const x of e.instances)p.push(...w.col(x.b||"888"));var g=new Float32Array(m),y=w.gl.createBuffer();w.gl.bindBuffer(w.gl.ARRAY_BUFFER,y),w.gl.bufferData(w.gl.ARRAY_BUFFER,g,w.gl.DYNAMIC_DRAW),w.instanceMatrixBuffers[e.n]=y,w.gl.bindBuffer(w.gl.ARRAY_BUFFER,w.instanceColorBuffers[e.n]=w.gl.createBuffer()),w.gl.bufferData(w.gl.ARRAY_BUFFER,new Float32Array(p),w.gl.DYNAMIC_DRAW)}else e.isInstanced=!1;e.fov&&(g=w.viewLimit,w.projection=new DOMMatrix([1/Math.tan(e.fov*Math.PI/180)/(w.canvas.width/w.canvas.height),0,0,0,0,1/Math.tan(e.fov*Math.PI/180),0,0,0,0,-(g+.1)/(g-.1),-1,0,0,-2*g*.1/(g-.1),0])),e={type:t,...w.current[e.n]=w.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0,hidden:!1,uncullface:0,smooth:0,t:e.t,texture:i,normal:o,A:s,B:a,C:n,Ai:l,Bi:d,Ci:c,AB:u,BC:h,...e},...e,f:0},w.models[e.type]?.vertices&&!w.models?.[e.type].verticesBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].verticesBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].vertices),35044),!w.models[e.type].normals&&w.smooth&&w.smooth(e),w.models[e.type].normals)&&(w.gl.bindBuffer(34962,w.models[e.type].normalsBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].normals.flat()),35044)),w.models[e.type]?.uv&&!w.models[e.type].uvBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].uvBuffer=w.gl.createBuffer()),w.gl.bufferData(34962,new Float32Array(w.models[e.type].uv),35044)),w.models[e.type]?.indices&&!w.models[e.type].indicesBuffer&&(w.gl.bindBuffer(34963,w.models[e.type].indicesBuffer=w.gl.createBuffer()),w.gl.bufferData(34963,new Uint16Array(w.models[e.type].indices),35044)),e.t?e.mix||(e.mix=0):e.mix=1,w.next[e.n]=e},draw:(e,t,i,r,o=[])=>{var s=performance.now();if(t=e-w.lastFrame,w.lastFrame=e,requestAnimationFrame(w.draw),w.debugFBO)renderFBOToCanvas();else{for(r in w.next.camera.g&&w.render(w.next[w.next.camera.g],t,1),i=w.animation("camera"),w.next?.camera?.g&&i.preMultiplySelf(w.next[w.next.camera.g].M||w.next[w.next.camera.g].m),w.gl.uniformMatrix4fv(w.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(w.projection),w.gl.uniformMatrix4fv(w.uniformLocations.pv,!1,i.toFloat32Array()),w.wjsHooks.emitSync("shadow_draw",w),w.gl.clear(16640),w.next){var a=w.next[r];!0!==a.hidden&&(a.isInstanced||a.t||1!=w.col(a.b)[3]?o.push(a):w.render(a,t))}o.sort((e,t)=>w.dist(t)-w.dist(e)),w.gl.enable(3042),w.gl.depthMask(1);for(r of o)r.isInstanced&&w.render(r,t);for(r of o)r.isInstanced||w.render(r,t);w.gl.depthMask(1),w.gl.disable(3042),w.gl.uniform3f(w.uniformLocations.light,w.lerp("light","x"),w.lerp("light","y"),w.lerp("light","z")),1e3<=e-w.lastReportTime&&(w.drawTime=(performance.now()-s).toFixed(2)+"ms",w.lastReportTime=e)}},render:(e,t,i=["camera","light","group"].includes(e.type),r)=>{if(e.t&&(w.gl.activeTexture(w.gl.TEXTURE0),w.gl.bindTexture(3553,w.textures[e.t.id]),w.gl.uniform1i(w.uniformLocations.sampler,0),w.gl.uniform2f(w.uniformLocations.tiling,e.tile?.[0]||1,e.tile?.[1]||1)),e.isInstanced||(e.f<e.a&&(e.f+=t),e.a<e.f&&(e.f=e.a),w.next[e.n].m=w.animation(e.n),w.next[e.g]&&w.next[e.n].m.preMultiplySelf(w.next[e.g].M||w.next[e.g].m),i)||(w.gl.uniformMatrix4fv(w.uniformLocations.m,!1,(w.next[e.n].M||w.next[e.n].m).toFloat32Array()),w.gl.uniformMatrix4fv(w.uniformLocations.im,!1,new DOMMatrix(w.next[e.n].M||w.next[e.n].m).invertSelf().toFloat32Array())),!i){if(!w.models[e.type]?.verticesBuffer)return 0;if(w.gl.bindBuffer(34962,w.models[e.type].verticesBuffer),w.gl.vertexAttribPointer(r=w.attribLocations.pos,3,5126,!1,0,0),w.gl.enableVertexAttribArray(r),w.gl.vertexAttribDivisor(r,0),w.models[e.type].uvBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].uvBuffer),w.gl.vertexAttribPointer(r=w.attribLocations.uv,2,5126,!1,0,0),w.gl.enableVertexAttribArray(r),w.gl.vertexAttribDivisor(r,0)),(e.s||w.models[e.type].customNormals)&&w.models[e.type].normalsBuffer&&(w.gl.bindBuffer(34962,w.models[e.type].normalsBuffer),w.gl.vertexAttribPointer(r=w.attribLocations.normal,3,5126,!1,0,0),w.gl.enableVertexAttribArray(r),w.gl.vertexAttribDivisor(r,0)),w.gl.uniform1i(w.uniformLocations.isInstanced,e.isInstanced?1:0),e.isInstanced&&w.instanceMatrixBuffers[e.n]){var t=w.instanceMatrixBuffers[e.n],o=(w.gl.bindBuffer(w.gl.ARRAY_BUFFER,t),w.attribLocations.instanceModelMatrix),s=16*Float32Array.BYTES_PER_ELEMENT;for(let e=0;e<4;++e){var a=o+e;w.gl.enableVertexAttribArray(a),w.gl.vertexAttribPointer(a,4,w.gl.FLOAT,!1,s,4*e*Float32Array.BYTES_PER_ELEMENT),w.gl.vertexAttribDivisor(a,1)}}w.gl.uniform4f(w.uniformLocations.o,e.s,(3<e.mode||3<w.gl[e.mode])&&!e.ns?1:0,w.ambientLight||.2,e.mix),w.gl.uniform4f(w.uniformLocations.bb,e.w,e.h,"billboard"==e.type,0);i=w.attribLocations.col;if(e.isInstanced?(w.gl.enableVertexAttribArray(i),w.gl.bindBuffer(w.gl.ARRAY_BUFFER,w.instanceColorBuffers[e.n]),w.gl.vertexAttribPointer(i,4,w.gl.FLOAT,!1,0,0),w.gl.vertexAttribDivisor(i,1)):w.gl.vertexAttrib4fv(i,w.col(e.b||"888")),e.uncullface?(w.gl.disable(2884),w.cullface=!1):!0!==w.cullface&&(w.gl.enable(2884),w.cullface=!0),w.models[e.type].indicesBuffer?(w.gl.bindBuffer(34963,w.models[e.type].indicesBuffer),e.isInstanced?w.gl.drawElementsInstanced(+e.mode||w.gl[e.mode],w.models[e.type].indices.length,w.gl.UNSIGNED_SHORT,0,e.numInstances):w.gl.drawElements(+e.mode||w.gl[e.mode],w.models[e.type].indices.length,5123,0)):e.isInstanced?w.gl.drawArraysInstanced(+e.mode||w.gl[e.mode],0,w.models[e.type].vertices.length/3,e.numInstances):w.gl.drawArrays(+e.mode||w.gl[e.mode],0,w.models[e.type].vertices.length/3),e.isInstanced){var n=w.attribLocations.instanceModelMatrix;for(let e=0;e<4;++e)w.gl.vertexAttribDivisor(n+e,0),w.gl.disableVertexAttribArray(n+e);w.gl.vertexAttribDivisor(i,0),w.gl.disableVertexAttribArray(i)}}},lerp:(e,t)=>w.next[e]?.a?w.current[e][t]+(w.next[e][t]-w.current[e][t])*(w.next[e].f/w.next[e].a):w.next[e][t],animation:(e,t=new DOMMatrix)=>w.next[e]?t.translateSelf(w.lerp(e,"x"),w.lerp(e,"y"),w.lerp(e,"z")).rotateSelf(w.lerp(e,"rx"),w.lerp(e,"ry"),w.lerp(e,"rz")).scaleSelf(w.lerp(e,"w"),w.lerp(e,"h"),w.lerp(e,"d")):t,dist:(e,t=w.next.camera)=>e?.m&&t?.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>w.ambientLight=e,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{(w.models[t]=e).normals&&(w.models[t].customNormals=1),w[t]=e=>w.setState(e,t)},resetView:(e=1)=>{w.gl.viewport(0,0,w.gl.canvas.width*e,w.gl.canvas.height*e),w.setState({n:"camera",fov:w.next.camera.fov})},group:e=>w.setState(e,"group"),move:(e,t)=>setTimeout(()=>{w.setState(e)},t||1),delete:(e,t)=>setTimeout(()=>{delete w.next[e]},t||1),camera:(e,t)=>setTimeout(()=>{w.setState(e,e.n="camera")},t||1),light:(e,t)=>t?setTimeout(()=>{w.setState(e,e.n="light")},t):w.setState(e,e.n="light"),cullface:!0,smooth:(e,t={},i=[],r,o,s,a,n,l,d,c,u,h,m)=>{for(w.models[e.type].normals=[],s=0;s<w.models[e.type].vertices.length;s+=3)i.push(w.models[e.type].vertices.slice(s,s+3));for(o=(r=w.models[e.type].indices)?1:(r=i,0),s=0;s<2*r.length;s+=3){a=s%r.length,n=i[c=o?w.models[e.type].indices[a]:a],l=i[u=o?w.models[e.type].indices[1+a]:1+a],d=i[h=o?w.models[e.type].indices[2+a]:2+a];var p=[l[0]-n[0],l[1]-n[1],l[2]-n[2]],f=[d[0]-l[0],d[1]-l[1],d[2]-l[2]];m=a<s?[0,0,0]:[p[1]*f[2]-p[2]*f[1],p[2]*f[0]-p[0]*f[2],p[0]*f[1]-p[1]*f[0]],t[n[0]+"_"+n[1]+"_"+n[2]]||=[0,0,0],t[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],t[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],w.models[e.type].normals[c]=t[n[0]+"_"+n[1]+"_"+n[2]]=t[n[0]+"_"+n[1]+"_"+n[2]].map((e,t)=>e+m[t]),w.models[e.type].normals[u]=t[l[0]+"_"+l[1]+"_"+l[2]]=t[l[0]+"_"+l[1]+"_"+l[2]].map((e,t)=>e+m[t]),w.models[e.type].normals[h]=t[d[0]+"_"+d[1]+"_"+d[2]]=t[d[0]+"_"+d[1]+"_"+d[2]].map((e,t)=>e+m[t])}}};w.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),w.add("billboard",w.models.plane),w.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),w.cube=e=>w.setState(e,"cube"),w.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]});var[r,o,s,a,n,l,d=[],c=[],u=[]]=[];for(s=0;s<=20;s++)for(a=s*Math.PI/20,r=0;r<=20;r++)o=2*r*Math.PI/20,d.push(+(Math.sin(o)*Math.sin(a)/2).toFixed(6),+(Math.cos(a)/2).toFixed(6),+(Math.cos(o)*Math.sin(a)/2).toFixed(6)),u.push(3.5*Math.sin(r/20),-Math.sin(s/20)),r<20&&s<20&&c.push(n=21*s+r,l=n+21,n+1,n+1,l,l+1);w.add("sphere",{vertices:d,uv:u,indices:c});const h=w}},r={};function o(e){var t=r[e];return void 0!==t||(t=r[e]={exports:{}},i[e](t,t.exports,o)),t.exports}o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var e={};{
/*!**************************!*\
  !*** ./src/openworld.js ***!
  \**************************/
o.r(e),o.d(e,{default:()=>m});var t=o(/*! ./common/hooks.js */"./src/common/hooks.js"),s=o(/*! ./utils/tool.js */"./src/utils/tool.js"),a=o(/*! ./wjs/w_ins_lab.js */"./src/wjs/w_ins_lab.js"),n=o(/*! ./core/main.js */"./src/core/main.js"),l=o(/*! ./obj/texture.js */"./src/obj/texture.js"),d=o(/*! ./player/control.js */"./src/player/control.js"),c=o(/*! ./obj/chunkManager.js */"./src/obj/chunkManager.js"),u=o(/*! ./obj/addobj.js */"./src/obj/addobj.js"),h=o(/*! ./core/animate.js */"./src/core/animate.js"),t={hooks:t.default,W:a.default,...s.default,...n.default,...l.default,...d.default,...c.default,...u.default,...h.default};const m=window.openworldJS=t}return e});