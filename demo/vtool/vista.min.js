/*! vista.js v1.0.0 | (c) github.com/kohunglee/visita-js | www.ccgxk.com | MIT License */
/**
 * 本文件源代码可见本目录的 vista.js 或 github.com/kohunglee/visita-js
 */

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.vista=t():e.vista=t()}(this,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>S});const n={_hookQueues:new Map,on(e,t,n=100){if("function"!=typeof t)throw new TypeError("Callback must be function");const i=this._hookQueues.get(e)||[];i.push({func:t,priority:n}),i._isSorted=!1,this._hookQueues.set(e,i)},off(e,t){const n=this._hookQueues.get(e);if(!n)return;const i=n.filter((e=>e.func!==t));0===i.length?this._hookQueues.delete(e):i.length<n.length&&(i._isSorted=!1,this._hookQueues.set(e,i))},_getSortedCallbacks(e){let t=this._hookQueues.get(e);return t?(t._isSorted||(t.sort(((e,t)=>t.priority-e.priority)),t._isSorted=!0),[...t]):[]},async emit(e,...t){const n=this._getSortedCallbacks(e).map((e=>e.func)).map((async e=>{try{return await e(...t)}catch(e){throw e}}));return Promise.allSettled(n)},emitSync(e,...t){const n=[];for(const{func:i}of this._getSortedCallbacks(e))try{const e=i(...t);if(n.push({status:"fulfilled",value:e}),!1===e)break}catch(e){n.push({status:"rejected",reason:e})}return n}},i={quaternionToEuler:function(e){const{x:t,y:n,z:i,w:r}=e,o=Math.atan2(2*(r*t+n*i),1-2*(t*t+n*n)),s=2*(r*n-i*t),a=Math.asin(Math.max(-1,Math.min(1,s))),l=Math.atan2(2*(r*i+t*n),1-2*(n*n+i*i)),c=e=>e*(180/Math.PI);return{rX:c(o),rY:c(a),rZ:c(l)}},genPR:function(e,t){let n=Math.abs(e)||1;n=1664525*n+1013904223|0;const i=new Float32Array(t),r=1/4294967296;for(let e=0;e<t;e++)n^=n<<13,n^=n>>17,n^=n<<5,i[e]=(n>>>0)*r;return i},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})},r={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:n,reset:e=>{var t;r.canvas=e,r.objs=0,r.current={},r.next={},r.textures={},r.viewLimit=5e3,r.gl=e.getContext("webgl2"),r.gl.blendFunc(770,771),r.gl.activeTexture(33984),r.program=r.gl.createProgram(),r.gl.enable(2884),r.instanceColorBuffers={},r.lastFrame=0,r.drawTime=0,r.lastReportTime=0,r.gl.shaderSource(t=r.gl.createShader(35633),"#version 300 es\n          precision lowp float;                        \n          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...\n          in mat4 instanceModelMatrix;                  // 实例化模型的 模型\n          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵\n          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]\n          out vec4 v_pos, v_col, v_uv, v_normal;\n          uniform bool isInstanced;              // 是不是实例化绘制\n          void main() {\n            mat4 currentModelMatrix;             // 当前的模型矩阵\n            if (isInstanced) {\n              currentModelMatrix = instanceModelMatrix;\n            } else {\n              currentModelMatrix = m;\n            }\n            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos\n              v_pos = bb.z > 0.                         \n              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌\n              : currentModelMatrix * pos               \n            );\n            v_col = col;\n            v_uv = uv;\n            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵\n          }"),r.gl.compileShader(t),r.gl.attachShader(r.program,t),r.gl.shaderSource(t=r.gl.createShader(35632),"#version 300 es\n          precision lowp float;\n          in vec4 v_pos, v_col, v_uv, v_normal;\n          uniform vec3 light;\n          uniform vec2 tiling;\n          uniform vec4 o;\n          uniform sampler2D sampler;\n          out vec4 c;\n          void main() {\n            vec2 final_uv = v_uv.xy;  //+ 新增纹理面修正逻辑，修复纹理面翻转问题\n            if (!gl_FrontFacing) {\n              final_uv.x = 1.0 - final_uv.x;\n            }\n            c = mix(texture(sampler, final_uv * tiling), v_col, o[3]);\n            if(o[1] > 0.){\n              c = vec4(\n                c.rgb * (max(0., dot(light, -normalize(\n                  o[0] > 0.\n                  ? vec3(v_normal.xyz)\n                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))\n                )))\n                + o[2]),\n                c.a\n              );\n            }\n          }"),r.gl.compileShader(t),r.gl.attachShader(r.program,t),r.gl.linkProgram(r.program),r.gl.useProgram(r.program),r.clearColor=e=>r.gl.clearColor(...r.col(e)),r.wjsHooks.emitSync("reset_ok",r),r.uniformLocations={pv:r.gl.getUniformLocation(r.program,"pv"),eye:r.gl.getUniformLocation(r.program,"eye"),m:r.gl.getUniformLocation(r.program,"m"),im:r.gl.getUniformLocation(r.program,"im"),bb:r.gl.getUniformLocation(r.program,"bb"),isInstanced:r.gl.getUniformLocation(r.program,"isInstanced"),o:r.gl.getUniformLocation(r.program,"o"),light:r.gl.getUniformLocation(r.program,"light"),tiling:r.gl.getUniformLocation(r.program,"tiling"),sampler:r.gl.getUniformLocation(r.program,"sampler"),u_MvpMatrixFromLight:r.gl.getUniformLocation(r.program,"u_MvpMatrixFromLight"),u_ShadowMap:r.gl.getUniformLocation(r.program,"u_ShadowMap")},r.attribLocations={pos:r.gl.getAttribLocation(r.program,"pos"),col:r.gl.getAttribLocation(r.program,"col"),uv:r.gl.getAttribLocation(r.program,"uv"),normal:r.gl.getAttribLocation(r.program,"normal"),instanceModelMatrix:r.gl.getAttribLocation(r.program,"instanceModelMatrix")},r.clearColor("fff"),r.gl.enable(2929),r.light({y:-1}),r.camera({fov:30}),setTimeout(r.draw,16)},setState:(e,t,n,i,o=[],s,a,l,c,d,u,f,h)=>{if(e.n||="o"+r.objs++,e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!r.textures[e.t.id]&&(n=r.gl.createTexture(),r.gl.pixelStorei(37441,!1),r.gl.bindTexture(3553,n),r.gl.pixelStorei(37440,1),r.gl.texImage2D(3553,0,6408,6408,5121,e.t),r.gl.generateMipmap(3553),r.textures[e.t.id]=n),e.instances&&Array.isArray(e.instances)){e.isInstanced=!0,e.numInstances=e.instances.length;const t=[],n=[];for(const n of e.instances){const i=new DOMMatrix;i.translateSelf(n.x+(0|e.x)|0,n.y+(0|e.y)|0,n.z+(0|e.z)|0).rotateSelf(n.rx||0,n.ry||0,n.rz||0).scaleSelf(n.w||1,n.h||1,n.d||1),t.push(...i.toFloat32Array())}for(const t of e.instances)n.push(...r.col(t.b||"888"));const i=new Float32Array(t),o=r.gl.createBuffer();r.gl.bindBuffer(r.gl.ARRAY_BUFFER,o),r.gl.bufferData(r.gl.ARRAY_BUFFER,i,r.gl.DYNAMIC_DRAW),r.instanceMatrixBuffers[e.n]=o,r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.instanceColorBuffers[e.n]=r.gl.createBuffer()),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(n),r.gl.DYNAMIC_DRAW)}else e.isInstanced=!1;if(e.fov){var p=r.viewLimit;r.projection=new DOMMatrix([1/Math.tan(e.fov*Math.PI/180)/(r.canvas.width/r.canvas.height),0,0,0,0,1/Math.tan(e.fov*Math.PI/180),0,0,0,0,-(p+.1)/(p-.1),-1,0,0,-2*p*.1/(p-.1),0])}e={type:t,...r.current[e.n]=r.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0,hidden:!1,uncullface:0,smooth:0,t:e.t,texture:n,normal:o,A:s,B:a,C:l,Ai:c,Bi:d,Ci:u,AB:f,BC:h,...e},...e,f:0},r.models[e.type]?.vertices&&!r.models?.[e.type].verticesBuffer&&(r.gl.bindBuffer(34962,r.models[e.type].verticesBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[e.type].vertices),35044),!r.models[e.type].normals&&r.smooth&&r.smooth(e),r.models[e.type].normals&&(r.gl.bindBuffer(34962,r.models[e.type].normalsBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[e.type].normals.flat()),35044))),r.models[e.type]?.uv&&!r.models[e.type].uvBuffer&&(r.gl.bindBuffer(34962,r.models[e.type].uvBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[e.type].uv),35044)),r.models[e.type]?.indices&&!r.models[e.type].indicesBuffer&&(r.gl.bindBuffer(34963,r.models[e.type].indicesBuffer=r.gl.createBuffer()),r.gl.bufferData(34963,new Uint16Array(r.models[e.type].indices),35044)),e.t?e.t&&!e.mix&&(e.mix=0):e.mix=1,r.next[e.n]=e},draw:(e,t,n,i,o=[])=>{const s=performance.now();if(t=e-r.lastFrame,r.lastFrame=e,requestAnimationFrame(r.draw),r.debugFBO)renderFBOToCanvas();else{for(i in r.next.camera.g&&r.render(r.next[r.next.camera.g],t,1),n=r.animation("camera"),r.next?.camera?.g&&n.preMultiplySelf(r.next[r.next.camera.g].M||r.next[r.next.camera.g].m),r.gl.uniformMatrix4fv(r.uniformLocations.eye,!1,n.toFloat32Array()),n.invertSelf(),n.preMultiplySelf(r.projection),r.gl.uniformMatrix4fv(r.uniformLocations.pv,!1,n.toFloat32Array()),r.wjsHooks.emitSync("shadow_draw",r),r.gl.clear(16640),r.next){const e=r.next[i];!0!==e.hidden&&(e.isInstanced||e.t||1!=r.col(e.b)[3]?o.push(e):r.render(e,t))}for(i of(o.sort(((e,t)=>r.dist(t)-r.dist(e))),r.gl.enable(3042),r.gl.depthMask(1),o))i.isInstanced&&r.render(i,t);for(i of o)i.isInstanced||r.render(i,t);r.gl.depthMask(1),r.gl.disable(3042),r.gl.uniform3f(r.uniformLocations.light,r.lerp("light","x"),r.lerp("light","y"),r.lerp("light","z")),e-r.lastReportTime>=1e3&&(r.drawTime=(performance.now()-s).toFixed(2)+"ms",r.lastReportTime=e)}},render:(e,t,n=["camera","light","group"].includes(e.type),i)=>{if(e.t&&(r.gl.activeTexture(r.gl.TEXTURE0),r.gl.bindTexture(3553,r.textures[e.t.id]),r.gl.uniform1i(r.uniformLocations.sampler,0),r.gl.uniform2f(r.uniformLocations.tiling,e.tile?.[0]||1,e.tile?.[1]||1)),e.isInstanced||(e.f<e.a&&(e.f+=t),e.f>e.a&&(e.f=e.a),r.next[e.n].m=r.animation(e.n),r.next[e.g]&&r.next[e.n].m.preMultiplySelf(r.next[e.g].M||r.next[e.g].m),n||(r.gl.uniformMatrix4fv(r.uniformLocations.m,!1,(r.next[e.n].M||r.next[e.n].m).toFloat32Array()),r.gl.uniformMatrix4fv(r.uniformLocations.im,!1,new DOMMatrix(r.next[e.n].M||r.next[e.n].m).invertSelf().toFloat32Array()))),!n){if(!r.models[e.type]?.verticesBuffer)return 0;if(r.gl.bindBuffer(34962,r.models[e.type].verticesBuffer),r.gl.vertexAttribPointer(i=r.attribLocations.pos,3,5126,!1,0,0),r.gl.enableVertexAttribArray(i),r.gl.vertexAttribDivisor(i,0),r.models[e.type].uvBuffer&&(r.gl.bindBuffer(34962,r.models[e.type].uvBuffer),r.gl.vertexAttribPointer(i=r.attribLocations.uv,2,5126,!1,0,0),r.gl.enableVertexAttribArray(i),r.gl.vertexAttribDivisor(i,0)),(e.s||r.models[e.type].customNormals)&&r.models[e.type].normalsBuffer&&(r.gl.bindBuffer(34962,r.models[e.type].normalsBuffer),r.gl.vertexAttribPointer(i=r.attribLocations.normal,3,5126,!1,0,0),r.gl.enableVertexAttribArray(i),r.gl.vertexAttribDivisor(i,0)),r.gl.uniform1i(r.uniformLocations.isInstanced,e.isInstanced?1:0),e.isInstanced&&r.instanceMatrixBuffers[e.n]){const t=r.instanceMatrixBuffers[e.n];r.gl.bindBuffer(r.gl.ARRAY_BUFFER,t);const n=r.attribLocations.instanceModelMatrix,i=16*Float32Array.BYTES_PER_ELEMENT;for(let e=0;e<4;++e){const t=n+e;r.gl.enableVertexAttribArray(t),r.gl.vertexAttribPointer(t,4,r.gl.FLOAT,!1,i,4*e*Float32Array.BYTES_PER_ELEMENT),r.gl.vertexAttribDivisor(t,1)}}r.gl.uniform4f(r.uniformLocations.o,e.s,(e.mode>3||r.gl[e.mode]>3)&&!e.ns?1:0,r.ambientLight||.2,e.mix),r.gl.uniform4f(r.uniformLocations.bb,e.w,e.h,"billboard"==e.type,0);const t=r.attribLocations.col;if(e.isInstanced?(r.gl.enableVertexAttribArray(t),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.instanceColorBuffers[e.n]),r.gl.vertexAttribPointer(t,4,r.gl.FLOAT,!1,0,0),r.gl.vertexAttribDivisor(t,1)):r.gl.vertexAttrib4fv(t,r.col(e.b||"888")),e.uncullface?(r.gl.disable(2884),r.cullface=!1):!0!==r.cullface&&(r.gl.enable(2884),r.cullface=!0),r.models[e.type].indicesBuffer?(r.gl.bindBuffer(34963,r.models[e.type].indicesBuffer),e.isInstanced?r.gl.drawElementsInstanced(+e.mode||r.gl[e.mode],r.models[e.type].indices.length,r.gl.UNSIGNED_SHORT,0,e.numInstances):r.gl.drawElements(+e.mode||r.gl[e.mode],r.models[e.type].indices.length,5123,0)):e.isInstanced?r.gl.drawArraysInstanced(+e.mode||r.gl[e.mode],0,r.models[e.type].vertices.length/3,e.numInstances):r.gl.drawArrays(+e.mode||r.gl[e.mode],0,r.models[e.type].vertices.length/3),e.isInstanced){const e=r.attribLocations.instanceModelMatrix;for(let t=0;t<4;++t)r.gl.vertexAttribDivisor(e+t,0),r.gl.disableVertexAttribArray(e+t);r.gl.vertexAttribDivisor(t,0),r.gl.disableVertexAttribArray(t)}}},lerp:(e,t)=>r.next[e]?.a?r.current[e][t]+(r.next[e][t]-r.current[e][t])*(r.next[e].f/r.next[e].a):r.next[e][t],animation:(e,t=new DOMMatrix)=>r.next[e]?t.translateSelf(r.lerp(e,"x"),r.lerp(e,"y"),r.lerp(e,"z")).rotateSelf(r.lerp(e,"rx"),r.lerp(e,"ry"),r.lerp(e,"rz")).scaleSelf(r.lerp(e,"w"),r.lerp(e,"h"),r.lerp(e,"d")):t,dist:(e,t=r.next.camera)=>e?.m&&t?.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>r.ambientLight=e,col:e=>[...e.replace("#","").match(e.length<5?/./g:/../g).map((t=>("0x"+t)/(e.length<5?15:255))),1],add:(e,t)=>{r.models[e]=t,t.normals&&(r.models[e].customNormals=1),r[e]=t=>r.setState(t,e)},resetView:(e=1)=>{r.gl.viewport(0,0,r.gl.canvas.width*e,r.gl.canvas.height*e),r.setState({n:"camera",fov:r.next.camera.fov})},group:e=>r.setState(e,"group"),move:(e,t)=>setTimeout((()=>{r.setState(e)}),t||1),delete:(e,t)=>setTimeout((()=>{delete r.next[e]}),t||1),camera:(e,t)=>setTimeout((()=>{r.setState(e,e.n="camera")}),t||1),light:(e,t)=>t?setTimeout((()=>{r.setState(e,e.n="light")}),t):r.setState(e,e.n="light"),cullface:!0,smooth:(e,t={},n=[],i,o,s,a,l,c,d,u,f,h,p)=>{for(r.models[e.type].normals=[],s=0;s<r.models[e.type].vertices.length;s+=3)n.push(r.models[e.type].vertices.slice(s,s+3));for((i=r.models[e.type].indices)?o=1:(i=n,o=0),s=0;s<2*i.length;s+=3){a=s%i.length,l=n[u=o?r.models[e.type].indices[a]:a],c=n[f=o?r.models[e.type].indices[a+1]:a+1],d=n[h=o?r.models[e.type].indices[a+2]:a+2];var g=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],m=[d[0]-c[0],d[1]-c[1],d[2]-c[2]];p=s>a?[0,0,0]:[g[1]*m[2]-g[2]*m[1],g[2]*m[0]-g[0]*m[2],g[0]*m[1]-g[1]*m[0]],t[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],t[c[0]+"_"+c[1]+"_"+c[2]]||=[0,0,0],t[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],r.models[e.type].normals[u]=t[l[0]+"_"+l[1]+"_"+l[2]]=t[l[0]+"_"+l[1]+"_"+l[2]].map(((e,t)=>e+p[t])),r.models[e.type].normals[f]=t[c[0]+"_"+c[1]+"_"+c[2]]=t[c[0]+"_"+c[1]+"_"+c[2]].map(((e,t)=>e+p[t])),r.models[e.type].normals[h]=t[d[0]+"_"+d[1]+"_"+d[2]]=t[d[0]+"_"+d[1]+"_"+d[2]].map(((e,t)=>e+p[t]))}}};r.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),r.add("billboard",r.models.plane),r.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),r.cube=e=>r.setState(e,"cube"),r.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]}),((e,t,n,i,o,s,a=[],l=[],c=[],d=20)=>{for(n=0;n<=d;n++)for(i=n*Math.PI/d,e=0;e<=d;e++)t=2*e*Math.PI/d,a.push(+(Math.sin(t)*Math.sin(i)/2).toFixed(6),+(Math.cos(i)/2).toFixed(6),+(Math.cos(t)*Math.sin(i)/2).toFixed(6)),c.push(3.5*Math.sin(e/d),-Math.sin(n/d)),e<d&&n<d&&l.push(o=n*(d+1)+e,s=o+(d+1),o+1,o+1,s,s+1);r.add("sphere",{vertices:a,uv:c,indices:l})})();const o=r,s={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",displayViewTime:.9,world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(e){this.canvas=window.document.getElementById(e),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate()},initW:function(e){const t=this.W;e.width=window.innerWidth*this.displayViewTime,e.height=window.innerHeight*this.displayViewTime,t.reset(e),t.ambient(.7),t.light({x:.5,y:-.3,z:.5}),t.clearColor(this.colorClear),t.camera({n:"camera",fov:this.fov}),t.group({n:"posZero",x:0,y:1,z:0}),t.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),t.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),t.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),t.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),t.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),t.pyramid({g:"posZero",size:1,z:10,rx:90,b:"44f"}),t.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}},a={textureMap:new Map,loadTextureIndex:1,rasterizeCanvas:document.createElement("canvas"),loadTexture:function(e){const t=[];for(var n=0;n<e.length;n++){const i=e[n];if(!0===this.textureMap.has(i.id)){t.push(Promise.resolve(this.textureMap.get(i.id)));continue}const r=new Promise((e=>{if("svg-rasterize"===i.type){const t=new Image;t.onload=()=>{const n=this.rasterizeCanvas;n.width=i.width||400,n.height=i.height||400;const r=n.getContext("2d");r.clearRect(0,0,n.width,n.height),r.drawImage(t,0,0,n.width,n.height);const o=n.toDataURL("image/png"),s=new Image;s.onload=()=>{this.textureMap.set(i.id,s),e(s)},s.src=o};const n=new Blob([i.svgCode],{type:"image/svg+xml"});t.src=URL.createObjectURL(n)}else{const t=new Image;t.onload=()=>{this.textureMap.set(i.id,t),this.loadTextureIndex++,e(t)},t.id=i.id+"-"+this.loadTextureIndex,t.src=this.dToBase64(i)}}));t.push(r)}return Promise.all(t)},canvasObj:document.createElement("canvas"),dToBase64:function(e){if("svg"===e.type){const t=e.svgCode.replace(/#/g,"%23");return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(t)}const t=this.canvasObj;t.width=e.width||400,t.height=e.height||400,t.style.webkitFontSmoothing="antialiased",t.style.mozOsxFontSmoothing="grayscale";const n=t.getContext("2d");if("png"===e.type)return e.func(n,t.width,t.height,e,this),t.toDataURL("image/png");if("jpg"===e.type){n.fillStyle="white",n.fillRect(0,0,t.width,t.height),e.func(n,t.width,t.height,e,this);var i=e.quality||.7;return t.toDataURL("image/jpeg",i)}},errorTexture:function(e,t,n,i,r){r.hooks.emitSync("errorTexture_diy",e,t,n,i,r)}},l={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var e=this,t=!1;document.addEventListener("keydown",(function(t){e._handleKey(t,1)})),document.addEventListener("keyup",(function(t){e._handleKey(t,0)})),document.addEventListener("mousemove",(function(n){t&&(e.keys.turnRight-=.1*n.movementX,e.keys.turnUp-=.1*n.movementY)})),this.canvas.addEventListener("click",(n=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),t=!0,document.pointerLockElement&&e.hooks.emitSync("pointer_lock_click",e,n)})),this.lockChangeAlert=function(){t=document.pointerLockElement===e.canvas||document.mozPointerLockElement===e.canvas||document.webkitPointerLockElement===e.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",(()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()}))},_handleKey:function(e,t){if(this.isPointerLock()){var n=this.keyMap[e.key.toLowerCase()];n&&(this.keys[n]=t),32!==e.keyCode&&"e"!==e.key.toLowerCase()||null===this.mainVPlayer||(0===this.keys.jumping&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=t),16!==e.keyCode&&"q"!==e.key.toLowerCase()||(this.isShiftPress=t)}},forwardAcc:0,displayPOS:function(){var e=document.getElementById("posInfo");if(!e)return 0;null!==this.mainVPlayer&&(e.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(e,t,n,i,r,o){const s=this.keys;if(s.viewForward||s.viewBackward){var a=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01);n+=(-s.viewForward+s.viewBackward)*Math.cos(r*Math.PI/180)/a,e+=(-s.viewForward+s.viewBackward)*Math.sin(r*Math.PI/180)/a,this.displayPOS()}return(s.viewLeft||s.viewRight)&&(n+=(-s.viewLeft+s.viewRight)*Math.cos((r+90)*Math.PI/180)/10,e+=(-s.viewLeft+s.viewRight)*Math.sin((r+90)*Math.PI/180)/10,this.displayPOS()),r=this.keys.turnRight,{x:e,y:t,z:n,rx:this.keys.turnUp,ry:r,rz:o}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(e){if(null===e)return;const t=this.mainCamera;!1===this.isMVPInit&&(t.groupName=e.name,this.isMVPInit=!0);const n=e.body.position,i=e.body.quaternion,r=this.calMovePara(n.x,n.y,n.z,t.qua.rx,t.qua.ry,t.qua.rz);e.body.position.x=r.x,e.body.position.y=r.y,e.body.position.z=r.z,t.qua=r,i.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*r.ry),this.W.camera({g:e.name,x:t.pos.x,y:t.pos.y,z:t.pos.z,rx:t.qua.rx,rz:t.qua.rz});const o=e.body.position,s=e.body.quaternion,a=this.quaternionToEuler(s);return e.quat=s,e.rX=a.rX,e.rY=a.rY,e.rZ=a.rZ,e.X=o.x,e.Y=o.y,e.Z=o.z,this.W.move({n:e.name,x:e.X,y:e.Y,z:e.Z,rx:e.rX,ry:e.rY,rz:e.rZ}),e.posID=this.calPosID(e.X,e.Y,e.Z,2),0}},c={calPosID:function(e,t,n,i){const r={2:100,3:100,4:40}[i]||0;if(2===i&&(i=""),0===r)return 0;var o=-1===Math.sign(e)?"X":"D",s=-1===Math.sign(n)?"B":"N";return i+o+Math.ceil(e/r*Math.sign(e))+s+Math.ceil(n/r*Math.sign(n))},gridsize:new Uint16Array([1e4,1e3,100,20,5]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";const e=this.mainVPlayer,t=[];for(let n=0;n<this.gridsize.length;n++){const i=Math.floor(e.X/this.gridsize[n]),r=Math.floor(e.Z/this.gridsize[n]);for(let e=-1;e<=1;e++)for(let o=-1;o<=1;o++)t.push(`${n}_${i+e}_${r+o}`)}const n=new Set,i=new Set(this.currentlyActiveIndices);for(const i of t){const t=this.spatialGrid.get(i);if(t)for(const i of t)Math.abs(this.positionsStatus[8*i+1]-e.Y)<this.gridsize[this.physicsProps[8*i+4]]&&n.add(i)}for(const e of n)i.delete(e);for(const e of n)if(!this.currentlyActiveIndices.has(e)){const t=8*e;this.positionsStatus[t+7]=this.physicsProps[t],this.activeTABox(e)}for(const e of i){const t=8*e;this.positionsStatus[t+7]=-1,this.hiddenTABox(e)}this.currentlyActiveIndices=n,this.activationQueue.length>0&&!this.isActivationScheduled&&(this.isActivationScheduled=!0)}},d={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(e=1e6){this.positionsStatus=new Float32Array(8*e),this.physicsProps=new Float32Array(8*e),this.freeSlots=new Array(e).fill(0).map(((t,n)=>e-1-n))},addTABox:function({DPZ:e=3,X:t=5,Y:n=5,Z:i=5,quat:r={x:0,y:0,z:0,w:1},mass:o=0,width:s=1,depth:a=1,height:l=1,size:c=1}={}){const d=Array.from(arguments)[0];if(1!==c&&(s=a=l=c),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;const u=this.freeSlots.pop(),f=8*u;this.positionsStatus[f]=t,this.positionsStatus[f+1]=n,this.positionsStatus[f+2]=i,this.positionsStatus[f+3]=r.x,this.positionsStatus[f+4]=r.y,this.positionsStatus[f+5]=r.z,this.positionsStatus[f+6]=r.w,this.positionsStatus[f+7]=o,this.physicsProps[f]=o,this.physicsProps[f+1]=s,this.physicsProps[f+2]=l,this.physicsProps[f+3]=a,this.physicsProps[f+4]=e;const h=`${e}_${Math.floor(t/this.gridsize[e])}_${Math.floor(i/this.gridsize[e])}`;let p=this.spatialGrid.get(h);p||(p=[]),p.push(u),this.spatialGrid.set(h,p),this.indexToArgs.set(u,d)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1,isInvisible:!1},argsObj:{},activeTABox:function(e){const t=8*e,n=this.positionsStatus.subarray(t,t+8),i=this.physicsProps.subarray(t,t+4),r=this.indexToArgs.get(e);this.argsObj={...this.defaultBoxArgs,...r};const o=this.argsObj;if(o.isPhysical){const e=new CANNON.Body;var s;if(e.mass=i[0],e.type=0===i[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,"sphere"===o.shape)s=new CANNON.Sphere(i[1]/2);else{const e=new CANNON.Vec3(i[1]/2,i[2]/2,i[3]/2);s=new CANNON.Box(e)}e.addShape(s),e.position.set(n[0],n[1],n[2]),e.material=this.cannonDefaultContactMaterial,e.updateMassProperties(),e.wakeUp(),e.collisionFilterGroup=o.colliGroup;const t={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};e.collisionFilterMask=t[o.colliGroup],this.world.addBody(e),e.quaternion.set(n[3],n[4],n[5],n[6]),r.cannonBody=e}if(!1!==o.isVisualMode){var a=o.tiling;if(0!==n[3]){var l=this.quaternionToEuler({x:n[3],y:n[4],z:n[5],w:n[6]});o.rX=l.x,o.rY=l.y,o.rZ=l.z}"number"==typeof a&&(a=[a,a]);const t=o.isFictBody?.1:0;var c,d=!1;if("string"==typeof o.texture?void 0!==window[o.texture]||this.textureMap.has(o.texture)?c=this.textureMap.has(o.texture)?this.textureMap.get(o.texture):window[o.texture]:(c=null,d=!0):c=o.texture,this.W[o.shape]({n:"T"+e,w:i[1]-t,d:i[3]-t,h:i[2]-t,x:n[0],y:n[1],z:n[2],t:c,s:o.smooth,tile:a,rx:o.rX,ry:o.rY,rz:o.rZ,b:o.background,mix:o.mixValue,shadow:o.isShadow,hidden:o.isInvisible}),d){const n=40,r=(i[1]-t)*n,s=(i[2]-t)*n;this.loadTexture([{func:this.errorTexture,id:o.texture,type:"png",width:r,height:s,index:e}]).then((t=>{this.W[o.shape]({n:"T"+e,t:this.textureMap.get(o.texture),mix:o.mixValue})}))}}},hiddenTABox:function(e){const t=this.indexToArgs.get(e);!1!==t.isPhysical&&void 0!==t.cannonBody&&this.world.removeBody(t.cannonBody),!1!==t.isVisualMode&&this.W.delete("T"+e)},addBox:function({DPZ:e=2,isPhysical:t=!0,isVisualMode:n=!0,kk:i=0,colliGroup:r=2,name:o="k"+this.bodyObjName++,X:s=5,Y:a=5,Z:l=5,quat:c=null,isShadow:d=0,tiling:u=[1,1],shape:f="cube",mass:h=0,width:p=1,depth:g=1,height:m=1,size:y=1,texture:x=null,smooth:v=0,background:b="#888",mixValue:w=.71,rX:M=0,rY:T=0,rZ:A=0}={}){var E=Array.from(arguments),S=this.calPosID(s,a,l,e);1!==y&&(p=g=m=y);var k=null;if(t){var B;if("sphere"===f)B=new CANNON.Sphere(p/2);else{const e=new CANNON.Vec3(p/2,m/2,g/2);B=new CANNON.Box(e)}(k=new CANNON.Body({mass:h,shape:B,position:new CANNON.Vec3(s,a,l),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=r;const e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};k.collisionFilterMask=e[r],this.world.addBody(k),c&&k.quaternion.set(c.x,c.y,c.z,c.w),c=k.quaternion}n&&("number"==typeof u&&(u=[u,u]),this.W[f]({n:o,w:p,d:g,h:m,x:s,y:a,z:l,t:x,s:v,tile:u,rx:M,ry:T,rz:A,b,mix:w,shadow:d}));var F={name:o,body:k,X:s,Y:a,Z:l,rX:M,rY:T,rZ:A,isVisualMode:n,myargs:E,posID:S,DPZ:e,quat:c};switch(!0){case!1===t:this.bodylistNotPys.push(F);break;case 0===h:this.bodylistMass0.push(F);break;default:this.bodylist.push(F)}return F}},u={};let f,h,p,g,m,y,x;function v(e,t,n){if(n)return e.width=0,void(e.height=0);0!==e.width&&1!==e.width||(e.width=20,e.height=20);const i=e.getContext("2d");t.W.getColorPickObj();const r=t.W.tempColor||[255,0,0,255],o=`rgba(${255-r[0]}, ${255-r[1]}, ${255-r[2]}, ${r[3]/255})`,s=65536*r[0]+256*r[1]+r[2];h.innerHTML=s,i.clearRect(0,0,e.width,e.height),0!==s?(t.hotPoint=s,i.beginPath(),i.strokeStyle=o,i.arc(e.width/2,e.height/2,9,0,2*Math.PI),i.lineWidth=2,i.stroke()):t.hotPoint&&(t.hotPoint=!1),i.beginPath(),i.arc(e.width/2,e.height/2,5,0,2*Math.PI),i.fillStyle=o,i.fill()}function b(){p.value="",g.value=0,m.value=0,y.value=0,u.indexHotCurr=-1}function w(){v(f,u.ccgxkObj,!0),clearInterval(u.ccgxkObj.centerPointColorUpdatax),u.ccgxkObj.centerPointColorUpdatax=null,u.ccgxkObj.mainCamera.pos={x:0,y:2,z:4}}function M(e){const t=JSON.parse(e);if(!Array.isArray(t))throw new Error("格式不正确。");u.ccgxkObj.currTextData=new Map(t);for(const e of u.ccgxkObj.currTextData)u.ccgxkObj.indexToArgs.get(Number(e[0].substring(1))).texture=e[0];for(const e of u.ccgxkObj.currentlyActiveIndices){const t="T"+e;u.ccgxkObj.currTextData.has(t)&&u.ccgxkObj.currentlyActiveIndices.delete(e)}myHUDModal.hidden=!0,T(),b(),alert("读取完成！")}function T(){const e=u.ccgxkObj.canvas;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock()}const A={hooks:n,W:o,...i,...s,...a,...l,...c,...d,gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const n of this.currentlyActiveIndices){const i=8*n;if(this.positionsStatus[i+7]>0){const r=this.indexToArgs.get(n),o=r.cannonBody;if(!o)continue;const s=o.position.x-this.positionsStatus[i],a=o.position.y-this.positionsStatus[i+1],l=o.position.z-this.positionsStatus[i+2],c=Math.sqrt(s*s+a*a+l*l);if(this.positionsStatus[i]=o.position.x,this.positionsStatus[i+1]=o.position.y,this.positionsStatus[i+2]=o.position.z,this.positionsStatus[i+3]=o.quaternion.x,this.positionsStatus[i+4]=o.quaternion.y,this.positionsStatus[i+5]=o.quaternion.z,this.positionsStatus[i+6]=o.quaternion.w,!1!==r.isVisualMode&&this.W.next["T"+n]&&c>1e-4){const s=this.quaternionToEuler(o.quaternion);if(this.W.move({n:"T"+n,x:this.positionsStatus[i],y:this.positionsStatus[i+1],z:this.positionsStatus[i+2],rx:s.rX,ry:s.rY,rz:s.rZ}),c>.01&&performance.now()-this.gridKeyCurrentTime>500){const o=r.gridkey||0,s=this.physicsProps[i+4],a=`${s}_${Math.floor(this.positionsStatus[i]/this.gridsize[s])}_${Math.floor(this.positionsStatus[i+2]/this.gridsize[s])}`;if(o&&a!==o){var e=this.spatialGrid.get(o);if(e){const t=e.indexOf(n);t>-1&&(e.splice(t,1),this.spatialGrid.set(o,e))}var t=this.spatialGrid.get(a);t||(t=[]),t.push(n),this.spatialGrid.set(a,t)}r.gridkey=a,this.gridKeyCurrentTime=performance.now()}}}}},cannonAni:function(){this.world.step(1/60)},animate:function(){var e=this;const t=function(){e.cannonAni(),e.updataBodylist(),e.mainVPlayerMove(e.mainVPlayer),e.hooks.emit("animatePreFrame",e),requestAnimationFrame(t)};t()}};var E;!function(e){const t=e.W;t.dynimicIns=!0,t.updateInstance=function(e,n,i){const r=t.next[e];if(!r?.isInstanced||!r.instances?.[n])return;const o=r.instances[n];Object.assign(o,i);const s=new DOMMatrix;s.translateSelf(o.x+(0|r.x)|0,o.y+(0|r.y)|0,o.z+(0|r.z)|0).rotateSelf(o.rx||0,o.ry||0,o.rz||0).scaleSelf(o.w||1,o.h||1,o.d||1);const a=t.instanceMatrixBuffers[e];if(t.gl.bindBuffer(t.gl.ARRAY_BUFFER,a),t.gl.bufferSubData(t.gl.ARRAY_BUFFER,16*n*4,s.toFloat32Array()),i.b){const r=t.instanceColorBuffers[e];t.gl.bindBuffer(t.gl.ARRAY_BUFFER,r),t.gl.bufferSubData(t.gl.ARRAY_BUFFER,4*n*4,new Float32Array(t.col(i.b)))}},t.deleteInstance=function(e,n){t.updateInstance(e,n,{w:.001,h:.001,d:.001})}}(A),function(e){const t=document.createElement("template");t.innerHTML='\n<style>\n    /* 使用一个独特的 ID 或 class 来限定样式作用域 */\n    #posMap {\n        position: fixed;\n        right: 50px;\n        bottom: 50px;\n        opacity: 0.8;\n        border: 1px solid #ccc; /* 增加边框以便看清 */\n        background-color: #f0f0f0; /* 增加背景色 */\n    }\n</style>\n<canvas id="posMap" width="100" height="100"></canvas>\n';const n=t.content.cloneNode(!0);document.body.appendChild(n),setInterval((()=>{!function(e,t){const n=t.mainVPlayer;if(!0!==t?.isMVPInit)return 0;const i=e.getContext("2d"),r=e.width/2,o=e.height/2;let s=n.X/5e3*r,a=n.Z/5e3*o;const l=e.width/10;i.clearRect(0,0,e.width,e.height),s=n.X/500*r,a=n.Z/500*o,i.fillStyle="#fff",i.fillRect(0,0,e.width,e.height),i.fillStyle="#F5F7FF";for(let e=0;e<10;e++)for(let t=0;t<10;t++)(e+t)%2==0&&i.fillRect(e*l,t*l,l,l);const c=r+s,d=o+a;i.beginPath(),i.arc(r,o,2,0,2*Math.PI),i.arc(c,d,1,0,2*Math.PI),i.fillStyle="red",i.fill(),i.strokeStyle="#9AFF4D",i.lineWidth=1,i.beginPath(),i.moveTo(c,d);const u=t.W.current.mainPlayer,f=function(e,t,n){e=-e*Math.PI/180,t=-t*Math.PI/180,n=n*Math.PI/180;var i=Math.cos(e),r=(e=Math.sin(e),Math.cos(t));t=Math.sin(t),Math.cos(n),Math.sin(n),n=t*i,t=-e,e=r*i,r=[0,0,1],i=e,t=Math.sqrt(Math.pow(n,2)+Math.pow(t,2)+Math.pow(e,2));let o=Math.acos(Math.min(1,Math.max(-1,i/t)));return(o=n*r[2]-e*r[0]<0?-o:o)>-Math.PI/2&&o<Math.PI/2?2*Math.PI-o:o}(u.rx,u.ry,u.rz),h=c-100*Math.sin(f),p=d-100*Math.cos(f);i.lineTo(h,p),i.stroke()}(posMap,e)}),50)}(A),E=A,setInterval((()=>{if(!0!==E?.isMVPInit)return 0;const e=E.mainVPlayer,t=e.body.position;!function(e,t){const n=encodeURIComponent(JSON.stringify(t));let i="";document.cookie=`lastPos_mvp=${n}${i}; path=/`}(0,{x:t.x,y:t.y,z:t.z,rX:e.rX,rY:e.rY,rZ:e.rZ})}),1e3),E.lastPos=function(){const e=document.cookie.split("; ");for(let t=0;t<e.length;t++){const n=e[t].split("=");if("lastPos_mvp"===n[0])return JSON.parse(decodeURIComponent(n[1]))}return null}(),function(e){e.svgTextureLib=[{id:"greenStoneTwo",type:"svg-rasterize",svgCode:'\n<svg width="1024" height="1024" xmlns="http://www.w3.org/2000/svg">\n  <filter id="ancient-wall" filterUnits="userSpaceOnUse" x="0" y="0" width="1024" height="1024">\n    <feTurbulence type="fractalNoise" baseFrequency="0.005" numOctaves="4" seed="10" result="base_plaster" />\n    <feDiffuseLighting in="base_plaster" surfaceScale="15" lighting-color="white" result="lit_plaster">\n      <feDistantLight azimuth="145" elevation="30" />\n    </feDiffuseLighting>\n    <feTurbulence type="turbulence" baseFrequency="0.04" numOctaves="3" seed="20" result="fine_grit" />\n    <feDisplacementMap in="lit_plaster" in2="fine_grit" scale="20" xChannelSelector="R" yChannelSelector="G" result="distressed_surface" />\n    <feComponentTransfer in="distressed_surface" result="colored_wall">\n      <feFuncR type="table" tableValues="0.0 0.1 0.7" />\n      <feFuncG type="table" tableValues="0.1 0.4 0.8" />\n      <feFuncB type="table" tableValues="0.1 0.4 0.75" />\n    </feComponentTransfer>\n    <feRadialGradient id="vignette" cx="25%" cy="25%" r="75%" fx="25%" fy="25%">\n        <stop offset="0%" stop-color="white" stop-opacity="1" />\n        <stop offset="100%" stop-color="black" stop-opacity="1" />\n    </feRadialGradient>\n    <feBlend in="colored_wall" in2="vignette" mode="multiply" />\n  </filter>\n  <rect width="100%" height="100%" filter="url(#ancient-wall)" />\n</svg>  \n'},{id:"greenStone",type:"svg-rasterize",svgCode:'\n<svg width="1024" height="1024" xmlns="http://www.w3.org/2000/svg">\n  <filter id="ancient-wall" filterUnits="userSpaceOnUse" x="-20" y="-20" width="1060" height="1060">\n    <feTurbulence type="fractalNoise" baseFrequency="0.005" numOctaves="4" seed="10" result="base_plaster" />\n    <feDiffuseLighting in="base_plaster" surfaceScale="15" lighting-color="white" result="lit_plaster">\n    <feDistantLight azimuth="145" elevation="30" />\n    </feDiffuseLighting>\n    <feTurbulence type="turbulence" baseFrequency="0.04" numOctaves="3" seed="20" result="fine_grit" />\n    <feDisplacementMap in="lit_plaster" in2="fine_grit" scale="20" xChannelSelector="R" yChannelSelector="G" result="distressed_surface" />\n    <feComponentTransfer in="distressed_surface" result="colored_wall">\n    <feFuncR type="table" tableValues="0.0 0.1 0.7" />\n    <feFuncG type="table" tableValues="0.1 0.4 0.8" />\n    <feFuncB type="table" tableValues="0.1 0.4 0.75" />\n    </feComponentTransfer>\n    <feRadialGradient id="vignette" cx="25%" cy="25%" r="75%" fx="25%" fy="25%">\n        <stop offset="0%" stop-color="white" stop-opacity="1" />\n        <stop offset="100%" stop-color="black" stop-opacity="1" />\n    </feRadialGradient>\n    <feBlend in="colored_wall" in2="vignette" mode="multiply" />\n  </filter>\n<rect width="100%" height="100%" filter="url(#ancient-wall)" />\n</svg>\n    '},{id:"greenStoneTest",type:"svg-rasterize",svgCode:'\n<svg width="1024" height="1024" xmlns="http://www.w3.org/2000/svg">\n  <filter id="ancient-wall" filterUnits="userSpaceOnUse" x="0" y="0" width="1024" height="1024">\n    <feTurbulence type="fractalNoise" baseFrequency="0.005" numOctaves="4" seed="10" result="base_plaster" />\n    <feDiffuseLighting in="base_plaster" surfaceScale="15" lighting-color="white" result="lit_plaster">\n      <feDistantLight azimuth="145" elevation="30" />\n    </feDiffuseLighting>\n    <feTurbulence type="turbulence" baseFrequency="0.04" numOctaves="3" seed="20" result="fine_grit" />\n    <feDisplacementMap in="lit_plaster" in2="fine_grit" scale="20" xChannelSelector="R" yChannelSelector="G" result="distressed_surface" />\n    <feComponentTransfer in="distressed_surface" result="colored_wall">\n      <feFuncR type="table" tableValues="0.0 0.1 0.7" />\n      <feFuncG type="table" tableValues="0.1 0.4 0.8" />\n      <feFuncB type="table" tableValues="0.1 0.4 0.75" />\n    </feComponentTransfer>\n    <feRadialGradient id="vignette" cx="25%" cy="25%" r="75%" fx="25%" fy="25%">\n        <stop offset="0%" stop-color="white" stop-opacity="1" />\n        <stop offset="100%" stop-color="black" stop-opacity="1" />\n    </feRadialGradient>\n    <feBlend in="colored_wall" in2="vignette" mode="multiply" />\n  </filter>\n  <rect width="100%" height="100%" filter="url(#ancient-wall)" />\n</svg>  \n'}]}(A),function(e){const t=document.createElement("template");t.innerHTML='\n<style>\n    .myHUD {\n        position: absolute;\n        bottom: 0;\n        padding: 0.3em;\n        color: #ffffff;\n    }\n</style>\n<div id="myHUD" class="myHUD">\n    <div id="fpsInfo"></div>\n    <span id="shiftInfo"></span>\n    <span id="posInfo"></span>\n    <span id="metrics"></span>\n    <span id="cpuInfo"></span>\n    <span id="modListCount"></span>\n    <span id="posIDMVP"></span>\n</div>\n';const n=t.content.cloneNode(!0);document.body.appendChild(n),shiftInfo.textContent="速度:0 | ",e.fpsFrameCount=0,e.lastTime=performance.now(),e.isFirstShowFPS=!0,e.showFPS1S=function(){var e=performance.now(),t=e-this.lastTime;if(this.fpsFrameCount++,t>1e3||this.isFirstShowFPS){this.isFirstShowFPS=!1;var n=this.fpsFrameCount/(t/1e3);this.fpsFrameCount=0,this.lastTime=e,this._showMemory(),this.displayPOS();const r=this.mainVPlayer;var i=this.calPosID(r?.X,r?.Y,r?.Z,2);posIDMVP.textContent=i.replace(/[Dd]/g,"东").replace(/[Xx]/g,"西").replace(/[Nn]/g,"南").replace(/[Bb]/g,"北"),fpsInfo.textContent="FPS："+n.toFixed(1)+"  ，渲染："+this.W.drawTime,modListCount.textContent="当前模型数："+this.bodylist.length+" - ❀"+this.bodylistNotPys.length+" - 口"+this.bodylistMass0.length+" - ⚡️ "+this.currentlyActiveIndices.size+`（can ${this.world.bodies.length} | w ${this._calWNotHidden()}）`+`（${this.indexToArgs.size}）`+`（纹理：${this.textureMap.size}） |`}},e._showMemory=function(){var e=document.getElementById("metrics");if(performance.memory){const t=performance.memory;e.textContent=`内存: ${(t.usedJSHeapSize/1048576).toFixed(1)}MB/${(t.jsHeapSizeLimit/1048576).toFixed(1)}MB | `}},e._calWNotHidden=function(){let e=0;for(var t in this.W.next)!0!==this.W.next[t].hidden&&e++;return e},e.hooks.on("animatePreFrame",(function(e){e.showFPS1S()}))}(A),function(e){((t,n,i=[],r=[])=>{e.W.add("prism",{vertices:i,uv:r})})(),e.W.add("Tetra",{vertices:[0,0,0,1,0,0,1,0,1,0,0,1],indices:[0,1,2,0,3,2]}),e.W.add("uvplane",{vertices:[1,1,0,0,1,0,0,0,0,1,0,0,1,1,2,0,1,2,0,0,2,1,0,2,2,1,1,2,0,1,1,1,2,1,0,2,0,1,2,0,0,2,-1,1,1,-1,0,1,0,1,0,0,0,0,-1,1,1,-1,0,1,1,1,0,1,0,0,2,1,1,2,0,1,1,1,0,0,1,0,-1,1,1,1,1,0,-1,1,1,0,1,2,1,1,0,0,1,2,2,1,1,2,1,1,0,1,2,1,1,2,1,0,0,0,0,0,-1,0,1,1,0,0,-1,0,1,0,0,2,1,0,0,0,0,2,2,0,1,2,0,1,0,0,2,1,0,2],uv:[0,1,1,1,1,0,0,0,1,1,0,1,0,0,1,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,0,1,0,0,1,1,1,0,1,1,1,0,0,1,0,0,.66,1,.33,1,0,.5,.66,1,0,.5,.33,0,.66,1,.33,0,1,.5,1,.5,.33,0,.66,0,.33,1,.66,1,1,.5,.33,1,1,.5,.66,0,.33,1,.66,0,0,.5,0,.5,.66,0,.33,0],indices:[1,0,2,2,0,3,4,5,6,4,6,7,8,10,11,8,11,9,12,14,15,12,15,13,18,16,19,19,16,17,20,22,23,20,23,21,24,25,26,27,28,29,30,31,32,33,34,35,36,38,37,39,41,40,42,44,43,45,47,46]})}(A),function(e){const t=document.createElement("template");t.innerHTML='\n<style>\n    /* 模态框 */\n    .myHUD-modal {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 100vw;\n        height: 100vh;\n        transform: translate(-50%, -50%);\n        z-index: 999;\n    }\n    .myHUD-modalPos {\n        margin-left: 50vw;\n        margin-top: 50vh;\n        transform: translate(-50%, -50%);\n        width: 700px;\n        text-align: center;\n        background-color: rgb(159 51 204 / 55%);\n        padding: 32px;\n        backdrop-filter: blur(2px);\n    }\n    .texture-editorBtn-lab {\n        display: inline-block;\n        background: rgb(32 32 32);\n        color: rgb(255, 255, 255);\n        padding: 5px 5px;\n        border: none;\n        cursor: pointer;\n        margin: 5px;\n        font-size: 14;\n        color: #bbbbbb;\n    }\n    .xCity {\n        font-size: 60px;\n        color: rgb(255, 255, 255);\n        position: fixed;\n        left: 50vw;\n        transform: translate(-50%);\n        width: max-content;\n        top: 30px;\n    }\n    .pointObjIndex {\n        position: fixed;\n        top: 50px;\n        left: 10px;\n    }\n</style>\n<div id="myHUDModal" class="myHUD-modal" hidden>\n    <div class="myHUD-modalPos">\n        <div>\n            左 <input type="number" id="textureEditorOffsetX" name="offsetX" min="0" max="1" step="0.1">\n            &nbsp;&nbsp;&nbsp;&nbsp;\n            右 <input type="number" id="textureEditorOffsetXR" name="offsetXR" min="0" max="1" step="0.1">\n            &nbsp;&nbsp;&nbsp;&nbsp;\n            下 <input type="number" id="textureEditorOffsetY" name="offsetY" min="0" max="1" step="0.1">\n            （偏移量，0 ~ 1）\n        </div>\n        <textarea rows="10" cols="50" class="tgeditor-texture" id="textureEditorTG"></textarea>\n        <div><br>\n            <div>\n                <span id="textureEditorInfo"></span><br>\n            </div>\n            <button class="texture-editorBtn" id="textureEditorSave">写入</button>\n            <button class="texture-editorBtn" id="textureEditorCancel">取消</button>\n            <button class="texture-editorBtn" id="textureEditorDownload">下载存档</button>\n            <label for="textureEditorReadfile" class="texture-editorBtn-lab">读取存档 </label>\n            <input  type="file" id="textureEditorReadfile" accept=".json" hidden>\n            <div>\n                <button class="texture-editorBtn" id="textureEditorClear">清空</button>\n                <button class="texture-editorBtn" id="textureEditorNumAux">数字行号辅</button>\n                <button class="texture-editorBtn" id="textureEditorNumAuxRemove">一键去除行号</button>\n            </div>\n            <hr>\n            <button class="texture-editorBtn" id="textureEditorRcover">从浏览器恢复</button>\n        </div>\n    </div>\n</div>\n<span id="currCityName" class="xCity">城市</span>\n<span id="pointObjIndex" class="pointObjIndex">城市</span>\n<canvas id="centerPoint" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);" width="1" height="1"></canvas>\n';const n=t.content.cloneNode(!0);document.body.appendChild(n),f=document.getElementById("centerPoint"),h=document.getElementById("pointObjIndex"),p=document.getElementById("textureEditorTG"),g=document.getElementById("textureEditorOffsetX"),m=document.getElementById("textureEditorOffsetXR"),y=document.getElementById("textureEditorOffsetY"),x=document.getElementById("textureEditorInfo"),u.ccgxkObj=e;const i=e.W;function r(e){if("f"===e.key){const e=u.ccgxkObj.mainVPlayer.body;0===e.mass?e.mass=50:(e.mass=0,e.velocity.set(0,0,0),e.angularVelocity.set(0,0,0),e.force.set(0,0,0),e.torque.set(0,0,0))}document.removeEventListener("keydown",r)}i.tempColor=new Uint8Array(4),i.makeFBO=()=>{i.pickingFBO=i.gl.createFramebuffer(),i.gl.bindFramebuffer(i.gl.FRAMEBUFFER,i.pickingFBO),i.pickingTexture=i.gl.createTexture(),i.gl.bindTexture(i.gl.TEXTURE_2D,i.pickingTexture),i.gl.texImage2D(i.gl.TEXTURE_2D,0,i.gl.RGBA,i.canvas.width,i.canvas.height,0,i.gl.RGBA,i.gl.UNSIGNED_BYTE,null),i.gl.framebufferTexture2D(i.gl.FRAMEBUFFER,i.gl.COLOR_ATTACHMENT0,i.gl.TEXTURE_2D,i.pickingTexture,0),i.pickingRenderbuffer=i.gl.createRenderbuffer(),i.gl.bindRenderbuffer(i.gl.RENDERBUFFER,i.pickingRenderbuffer),i.gl.renderbufferStorage(i.gl.RENDERBUFFER,i.gl.DEPTH_COMPONENT16,i.canvas.width,i.canvas.height),i.gl.framebufferRenderbuffer(i.gl.FRAMEBUFFER,i.gl.DEPTH_ATTACHMENT,i.gl.RENDERBUFFER,i.pickingRenderbuffer),i.gl.checkFramebufferStatus(i.gl.FRAMEBUFFER)!==i.gl.FRAMEBUFFER_COMPLETE||(i.makeFBOSucess=!0),i.whiteTexture=i.gl.createTexture(),i.gl.bindTexture(i.gl.TEXTURE_2D,i.whiteTexture),i.gl.texImage2D(i.gl.TEXTURE_2D,0,i.gl.RGBA,1,1,0,i.gl.RGBA,i.gl.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),i.gl.bindFramebuffer(i.gl.FRAMEBUFFER,null)},i.getColorPickObj=()=>{const t=i.next.mainPlayer;if(!t)return;i.gl.bindFramebuffer(i.gl.FRAMEBUFFER,i.pickingFBO),i.gl.clearColor(0,0,0,1),i.gl.clear(i.gl.COLOR_BUFFER_BIT|i.gl.DEPTH_BUFFER_BIT);for(const t of e.currentlyActiveIndices){const e=i.next["T"+t];if(e){var n={...e};n.b=t.toString(16).padStart(6,"0"),n.ns=1,n.mix=1,i.gl.activeTexture(i.gl.TEXTURE0),i.gl.bindTexture(i.gl.TEXTURE_2D,null),i.gl.activeTexture(i.gl.TEXTURE0+3),i.gl.bindTexture(i.gl.TEXTURE_2D,i.whiteTexture),i.render(n,0)}}var r={...t};r.b="#f00",r.ns=1,r.mix=1,i.gl.activeTexture(i.gl.TEXTURE0),i.gl.bindTexture(i.gl.TEXTURE_2D,null),i.gl.activeTexture(i.gl.TEXTURE0+3),i.gl.bindTexture(i.gl.TEXTURE_2D,i.whiteTexture),i.render(r,0);const o=new Uint8Array(4);i.gl.readPixels(i.gl.canvas.width/2,i.gl.canvas.height/2,1,1,i.gl.RGBA,i.gl.UNSIGNED_BYTE,o),i.gl.bindFramebuffer(i.gl.FRAMEBUFFER,null),i.clearColor(e.colorClear),i.tempColor=o},e.hooks.on("pointer_lock_click",(function(t,n){e.centerPointColorUpdatax||2===n.button?e.hotPoint&&2!==n.button?function(e){if(u.indexHotCurr=e.hotPoint+0,function(){if("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document){const e=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;e&&e.call(document)}}(),myHUDModal.hidden=!1,0===e.currTextData.size&&null!==localStorage.getItem("TGTOOL-backup")){const e="浏览器里有上次的备份存档，推荐您【从浏览器恢复】！（数据无价）";x.innerText=e,p.placeholder=e}p.value=e.currTextData.get("T"+u.indexHotCurr)?.content||"",g.value=e.currTextData.get("T"+u.indexHotCurr)?.x||0,m.value=e.currTextData.get("T"+u.indexHotCurr)?.xr||0,y.value=e.currTextData.get("T"+u.indexHotCurr)?.y||0}(e):(v(f,e,!0),clearInterval(e.centerPointColorUpdatax),e.centerPointColorUpdatax=null,e.mainCamera.pos={x:0,y:2,z:4}):(!0!==i.makeFBOSucess&&i.makeFBO(),v(f,e),e.centerPointColorUpdatax=setInterval((()=>{v(f,e)}),500),e.mainCamera.pos={x:0,y:.5,z:0})})),document.getElementById("textureEditorNumAux").addEventListener("click",(function(){p.value="0\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30"})),document.getElementById("textureEditorClear").addEventListener("click",(function(){p.value=""})),document.getElementById("textureEditorNumAuxRemove").addEventListener("click",(function(){p.value=p.value.replace(/^\d+$/gm,"")})),document.getElementById("textureEditorSave").addEventListener("click",(function(){myHUDModal.hidden=!0,T();const e={content:p.value,x:Number(g.value),xr:Number(m.value),y:Number(y.value)};!function(e,t={},n){const i="T"+e;if(!n?.indexToArgs?.get(e)?.TGtoolText)return 0;n.currTextData.set(i,{content:t?.content||"",x:t?.x||0,xr:t?.xr||0,y:t?.y||0}),n.textureMap.delete(i),window[i]=void 0,n.W.plane({n:"T"+e,t:i}),n.indexToArgs.get(e).texture=i,n.currentlyActiveIndices.delete(e)}(u.indexHotCurr,e,u.ccgxkObj),b(),w();const t=[...u.ccgxkObj.currTextData.entries()],n=JSON.stringify(t,null,2);localStorage.setItem("TGTOOL-backup",n)})),document.getElementById("textureEditorCancel").addEventListener("click",(function(){myHUDModal.hidden=!0,T(),b(),w()})),document.getElementById("textureEditorDownload").addEventListener("click",(function(){const e=[...u.ccgxkObj.currTextData.entries()],t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`TGTool-backup-${new Date(Date.now()).toLocaleString("sv-SE").replace(/[-:T\s]/g,"")}.json`,r.click(),URL.revokeObjectURL(i)})),document.getElementById("textureEditorReadfile").addEventListener("change",(function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{M(e.target.result)}catch(e){alert("研读失败！这可能是一份损坏或格式错误的存档。\n"+e.message)}},n.readAsText(t),e.target.value=""})),document.getElementById("textureEditorRcover").addEventListener("click",(function(){const e=localStorage.getItem("TGTOOL-backup");if(e)try{M(e),p.placeholder="",x.innerText=""}catch(e){alert("研读失败！这可能是一份损坏或格式错误的存档。\n"+e.message)}})),document.addEventListener("keydown",r),document.addEventListener("keyup",(function(){document.addEventListener("keydown",r)})),e.hooks.on("errorTexture_diy",(function(e,t,n,i,r){const o=i.index,s=i.id;if("T"+o!==s)return;const a=k.currTextData.get(s)?.content||"",l=k.currTextData.get(s)?.x||0,c=k.currTextData.get(s)?.y||0,d=k.currTextData.get(s)?.xr||0,u={};if(a){e.font=u.font||"25px Arial",e.fillStyle=u.fillStyle||"white",e.strokeStyle="transparent",e.textAlign=u.textAlign||"left",e.textBaseline=u.textBaseline||"top";var f=parseInt(e.font)||30;e.clearRect(0,0,t,n),e.fillStyle="white",function(t,n,i,r,o,s){const a=(n=n.split("/*")[0]).split("");let l="";for(let n=0;n<a.length;n++){if("\n"===a[n]){t.fillText(l,i,r),r+=s,l="";continue}"&"===a[n]&&(e.fillStyle="transparent",e.font="25px Arial",s=25,a[n]=""),"#"===a[n]&&(e.fillStyle="blue",e.font="40px serif",s=43,a[n]=""),"%"===a[n]&&(e.fillStyle="red",e.font="40px serif",s=43,a[n]=""),"@"===a[n]&&(e.fillStyle="white",e.font=u.font||"25px Arial",s=25,a[n]="");const c=l+a[n];t.measureText(c).width>o&&n>0?(t.fillText(l,i,r),l=a[n],r+=s):l=c}t.fillText(l,i,r)}(e,a,10+t*l,10+n*c,(t-20)*(1-l-d),f),r.W.next[s].hidden=!1,r.indexToArgs.get(o).isInvisible=!1}}))}(A),window.ccgxk=A;const S=A;return t})()));