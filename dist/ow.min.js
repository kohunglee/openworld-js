!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.openworld=e():t.openworld=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>d});const i={_hookQueues:new Map,on(t,e,i=100){if("function"!=typeof e)throw new TypeError("Callback must be function");const o=this._hookQueues.get(t)||[];o.push({func:e,priority:i}),o._isSorted=!1,this._hookQueues.set(t,o)},off(t,e){const i=this._hookQueues.get(t);if(!i)return;const o=i.filter(t=>t.func!==e);0===o.length?this._hookQueues.delete(t):o.length<i.length&&(o._isSorted=!1,this._hookQueues.set(t,o))},_getSortedCallbacks(t){let e=this._hookQueues.get(t);return e?(e._isSorted||(e.sort((t,e)=>e.priority-t.priority),e._isSorted=!0),[...e]):[]},async emit(t,...e){const i=this._getSortedCallbacks(t).map(t=>t.func).map(async t=>{try{return await t(...e)}catch(t){throw t}});return Promise.allSettled(i)},emitSync(t,...e){const i=[];for(const{func:o}of this._getSortedCallbacks(t))try{const t=o(...e);if(i.push({status:"fulfilled",value:t}),!1===t)break}catch(t){i.push({status:"rejected",reason:t})}return i}},o={quaternionToEuler:function(t){const{x:e,y:i,z:o,w:n}=t,s=Math.atan2(2*(n*e+i*o),1-2*(e*e+i*i)),r=2*(n*i-o*e),a=Math.asin(Math.max(-1,Math.min(1,r))),l=Math.atan2(2*(n*o+e*i),1-2*(i*i+o*o)),c=t=>t*(180/Math.PI);return{rX:c(s),rY:c(a),rZ:c(l)}},eulerToQuaternion:function(t){const{rX:e,rY:i,rZ:o}=t,n=t=>t*(Math.PI/180),s=.5*n(e),r=.5*n(i),a=.5*n(o),l=Math.sin(s),c=Math.cos(s),u=Math.sin(r),h=Math.cos(r),d=Math.sin(a),m=Math.cos(a);return{x:l*h*m-c*u*d,y:c*u*m+l*h*d,z:c*h*d-l*u*m,w:c*h*m+l*u*d}},genPR:function(t,e){let i=Math.abs(t)||1;i=1664525*i+1013904223|0;const o=new Float32Array(e),n=1/4294967296;for(let t=0;t<e;t++)i^=i<<13,i^=i>>17,i^=i<<5,o[t]=(i>>>0)*n;return o},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:100,restitution:.1}),audio:function(t){if(this?.offAudio)return;const e=window.A=window.A||new AudioContext,i=e=>t(e)||0;var o,n,s,r;for("suspended"==e.state&&(document.onclick=()=>e.resume()),n=(o=e.createBuffer(1,96e3,48e3)).getChannelData(0),r=96e3;r--;)n[r]=i(r);(s=e.createBufferSource()).buffer=o,s.connect(e.destination),s.start()},calYAngle:function(t,e,i){t=-t*Math.PI/180,e=-e*Math.PI/180,i=i*Math.PI/180;var o=Math.cos(t),n=(t=Math.sin(t),Math.cos(e));e=Math.sin(e),Math.cos(i),Math.sin(i),i=e*o,e=-t,t=n*o,n=[0,0,1],o=t,e=Math.sqrt(Math.pow(i,2)+Math.pow(e,2)+Math.pow(t,2));let s=Math.acos(Math.min(1,Math.max(-1,o/e)));return(s=i*n[2]-t*n[0]<0?-s:s)>-Math.PI/2&&s<Math.PI/2?2*Math.PI-s:s}},n={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i,reset:t=>{var e;n.canvas=t,n.objs=0,n.current={},n.next={},n.textures={},n.viewLimit=5e3,n.gl=t.getContext("webgl2"),n.gl.blendFunc(770,771),n.gl.activeTexture(33984),n.program=n.gl.createProgram(),n.gl.enable(2884),n.instanceColorBuffers={},n.lastFrame=0,n.drawTime=0,n.lastReportTime=0,n.gl.shaderSource(e=n.gl.createShader(35633),"#version 300 es\n          precision lowp float;                        \n          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...\n          in mat4 instanceModelMatrix;                  // 实例化模型的 模型\n          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵\n          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]\n          out vec4 v_pos, v_col, v_uv, v_normal;\n          uniform bool isInstanced;              // 是不是实例化绘制\n          void main() {\n            mat4 currentModelMatrix;             // 当前的模型矩阵\n            if (isInstanced) {\n              currentModelMatrix = instanceModelMatrix;\n            } else {\n              currentModelMatrix = m;\n            }\n            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos\n              v_pos = bb.z > 0.                         \n              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌\n              : currentModelMatrix * pos               \n            );\n            v_col = col;\n            v_uv = uv;\n            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵\n          }"),n.gl.compileShader(e),n.gl.attachShader(n.program,e),n.gl.shaderSource(e=n.gl.createShader(35632),"#version 300 es\n          precision lowp float;\n          in vec4 v_pos, v_col, v_uv, v_normal;\n          uniform vec3 light;\n          uniform vec2 tiling;\n          uniform vec4 o;\n          uniform sampler2D sampler;\n          out vec4 c;\n          void main() {\n            vec2 final_uv = v_uv.xy;  //+ 新增纹理面修正逻辑，修复纹理面翻转问题\n            if (!gl_FrontFacing) {\n              final_uv.x = 1.0 - final_uv.x;\n            }\n            c = mix(texture(sampler, final_uv * tiling), v_col, o[3]);\n            if(o[1] > 0.){\n              c = vec4(\n                c.rgb * (max(0., dot(light, -normalize(\n                  o[0] > 0.\n                  ? vec3(v_normal.xyz)\n                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))\n                )))\n                + o[2]),\n                c.a\n              );\n            }\n          }"),n.gl.compileShader(e),n.gl.attachShader(n.program,e),n.gl.linkProgram(n.program),n.gl.useProgram(n.program),n.clearColor=t=>n.gl.clearColor(...n.col(t)),n.wjsHooks.emitSync("reset_ok",n),n.uniformLocations={pv:n.gl.getUniformLocation(n.program,"pv"),eye:n.gl.getUniformLocation(n.program,"eye"),m:n.gl.getUniformLocation(n.program,"m"),im:n.gl.getUniformLocation(n.program,"im"),bb:n.gl.getUniformLocation(n.program,"bb"),isInstanced:n.gl.getUniformLocation(n.program,"isInstanced"),o:n.gl.getUniformLocation(n.program,"o"),light:n.gl.getUniformLocation(n.program,"light"),tiling:n.gl.getUniformLocation(n.program,"tiling"),sampler:n.gl.getUniformLocation(n.program,"sampler"),u_MvpMatrixFromLight:n.gl.getUniformLocation(n.program,"u_MvpMatrixFromLight"),u_ShadowMap:n.gl.getUniformLocation(n.program,"u_ShadowMap")},n.attribLocations={pos:n.gl.getAttribLocation(n.program,"pos"),col:n.gl.getAttribLocation(n.program,"col"),uv:n.gl.getAttribLocation(n.program,"uv"),normal:n.gl.getAttribLocation(n.program,"normal"),instanceModelMatrix:n.gl.getAttribLocation(n.program,"instanceModelMatrix")},n.clearColor("fff"),n.gl.enable(2929),n.light({y:-1}),n.camera({fov:30}),setTimeout(n.draw,16)},setState:(t,e,i,o,s=[],r,a,l,c,u,h,d,m)=>{if(t.n||="o"+n.objs++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!n.textures[t.t.id]&&(i=n.gl.createTexture(),n.gl.pixelStorei(37441,!1),n.gl.bindTexture(3553,i),n.gl.pixelStorei(37440,1),n.gl.texImage2D(3553,0,6408,6408,5121,t.t),n.gl.generateMipmap(3553),n.textures[t.t.id]=i),t.instances&&Array.isArray(t.instances)){t.isInstanced=!0,t.numInstances=t.instances.length;const e=[],i=[];for(const i of t.instances){const o=new DOMMatrix;o.translateSelf((i.x||0)+(t.x||0),(i.y||0)+(t.y||0),(i.z||0)+(t.z||0)).rotateSelf(i.rx||0,i.ry||0,i.rz||0).scaleSelf(i.w||1,i.h||1,i.d||1),e.push(...o.toFloat32Array())}for(const e of t.instances)i.push(...n.col(e.b||"888"));const o=new Float32Array(e),s=n.gl.createBuffer();n.gl.bindBuffer(n.gl.ARRAY_BUFFER,s),n.gl.bufferData(n.gl.ARRAY_BUFFER,o,n.gl.DYNAMIC_DRAW),n.instanceMatrixBuffers[t.n]=s,n.gl.bindBuffer(n.gl.ARRAY_BUFFER,n.instanceColorBuffers[t.n]=n.gl.createBuffer()),n.gl.bufferData(n.gl.ARRAY_BUFFER,new Float32Array(i),n.gl.DYNAMIC_DRAW)}else t.isInstanced=!1;if(t.fov){const e=n.canvas.width/n.canvas.height,i=.1,o=n.viewLimit,s=1/Math.tan(.5*t.fov*Math.PI/180);n.projection=new DOMMatrix([s/e,0,0,0,0,s,0,0,0,0,-(o+i)/(o-i),-1,0,0,-2*o*i/(o-i),0])}t={type:e,...n.current[t.n]=n.next[t.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0,hidden:!1,uncullface:0,smooth:0,t:t.t,texture:i,normal:s,A:r,B:a,C:l,Ai:c,Bi:u,Ci:h,AB:d,BC:m,...t},...t,f:0},n.models[t.type]?.vertices&&!n.models?.[t.type].verticesBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].verticesBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].vertices),35044),!n.models[t.type].normals&&n.smooth&&n.smooth(t),n.models[t.type].normals&&(n.gl.bindBuffer(34962,n.models[t.type].normalsBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].normals.flat()),35044))),n.models[t.type]?.uv&&!n.models[t.type].uvBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].uvBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].uv),35044)),n.models[t.type]?.indices&&!n.models[t.type].indicesBuffer&&(n.gl.bindBuffer(34963,n.models[t.type].indicesBuffer=n.gl.createBuffer()),n.gl.bufferData(34963,new Uint16Array(n.models[t.type].indices),35044)),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,n.next[t.n]=t},draw:(t,e,i,o,s=[])=>{const r=performance.now();if(e=t-n.lastFrame,n.lastFrame=t,requestAnimationFrame(n.draw),n.debugFBO)renderFBOToCanvas();else{for(o in n.next.camera.g&&n.render(n.next[n.next.camera.g],e,1),i=n.animation("camera"),n.next?.camera?.g&&i.preMultiplySelf(n.next[n.next.camera.g].M||n.next[n.next.camera.g].m),n.gl.uniformMatrix4fv(n.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(n.projection),n.gl.uniformMatrix4fv(n.uniformLocations.pv,!1,i.toFloat32Array()),n.wjsHooks.emitSync("shadow_draw",n),n.gl.clear(16640),n.next){const t=n.next[o];!0!==t.hidden&&(t.isInstanced||t.t||1!=n.col(t.b)[3]?s.push(t):n.render(t,e))}for(o of(s.sort((t,e)=>n.dist(e)-n.dist(t)),n.gl.enable(3042),n.gl.depthMask(1),s))o.isInstanced&&n.render(o,e);for(o of s)o.isInstanced||n.render(o,e);n.gl.depthMask(1),n.gl.disable(3042),n.gl.uniform3f(n.uniformLocations.light,n.lerp("light","x"),n.lerp("light","y"),n.lerp("light","z")),t-n.lastReportTime>=1e3&&(n.drawTime=(performance.now()-r).toFixed(2)+"ms",n.lastReportTime=t)}},render:(t,e,i=["camera","light","group"].includes(t.type),o)=>{if(t.t&&(n.gl.activeTexture(n.gl.TEXTURE0),n.gl.bindTexture(3553,n.textures[t.t.id]),n.gl.uniform1i(n.uniformLocations.sampler,0),n.gl.uniform2f(n.uniformLocations.tiling,t.tile?.[0]||1,t.tile?.[1]||1)),!t.isInstanced){function s(t,e,i){try{const o=i?.toFloat32Array?.()||[];if(!o.length||o.some(t=>!Number.isFinite(t)))throw new Error;t.uniformMatrix4fv(e,!1,o)}catch{t.uniformMatrix4fv(e,!1,(new DOMMatrix).toFloat32Array())}}if(t.f<t.a&&(t.f+=e),t.f>t.a&&(t.f=t.a),n.next[t.n].m=n.animation(t.n),n.next[t.g]&&n.next[t.n].m.preMultiplySelf(n.next[t.g].M||n.next[t.g].m),!i){let r,a;try{const l=n.next?.[t.n]?.M||n.next?.[t.n]?.m;r=new DOMMatrix(l).toFloat32Array().some(t=>!Number.isFinite(t))?new DOMMatrix:new DOMMatrix(l)}catch{r=new DOMMatrix}s(n.gl,n.uniformLocations.m,r);try{a=r.is2D?r.inverse():r.invertSelf()}catch{a=new DOMMatrix}s(n.gl,n.uniformLocations.im,a)}}if(!i){n.gl.disableVertexAttribArray(n.attribLocations.uv),n.gl.disableVertexAttribArray(n.attribLocations.normal),n.gl.disableVertexAttribArray(n.attribLocations.col);const c=n.attribLocations.instanceModelMatrix;for(let h=0;h<4;h++)n.gl.disableVertexAttribArray(c+h);if(!n.models[t.type]?.verticesBuffer)return 0;if(n.gl.bindBuffer(34962,n.models[t.type].verticesBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.pos,3,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0),n.models[t.type].uvBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].uvBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.uv,2,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0)),(t.s||n.models[t.type].customNormals)&&n.models[t.type].normalsBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].normalsBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.normal,3,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0)),n.gl.uniform1i(n.uniformLocations.isInstanced,t.isInstanced?1:0),t.isInstanced&&n.instanceMatrixBuffers[t.n]){const d=n.instanceMatrixBuffers[t.n];n.gl.bindBuffer(n.gl.ARRAY_BUFFER,d);const m=n.attribLocations.instanceModelMatrix,f=16*Float32Array.BYTES_PER_ELEMENT;for(let p=0;p<4;++p){const g=m+p;n.gl.enableVertexAttribArray(g),n.gl.vertexAttribPointer(g,4,n.gl.FLOAT,!1,f,4*p*Float32Array.BYTES_PER_ELEMENT),n.gl.vertexAttribDivisor(g,1)}}n.gl.uniform4f(n.uniformLocations.o,t.s,(t.mode>3||n.gl[t.mode]>3)&&!t.ns?1:0,n.ambientLight||.2,t.mix),n.gl.uniform4f(n.uniformLocations.bb,t.w,t.h,"billboard"==t.type,0);const u=n.attribLocations.col;if(t.isInstanced?(n.gl.enableVertexAttribArray(u),n.gl.bindBuffer(n.gl.ARRAY_BUFFER,n.instanceColorBuffers[t.n]),n.gl.vertexAttribPointer(u,4,n.gl.FLOAT,!1,0,0),n.gl.vertexAttribDivisor(u,1)):n.gl.vertexAttrib4fv(u,n.col(t.b||"888")),t.uncullface?(n.gl.disable(2884),n.cullface=!1):!0!==n.cullface&&(n.gl.enable(2884),n.cullface=!0),n.models[t.type].indicesBuffer?(n.gl.bindBuffer(34963,n.models[t.type].indicesBuffer),t.isInstanced?n.gl.drawElementsInstanced(+t.mode||n.gl[t.mode],n.models[t.type].indices.length,n.gl.UNSIGNED_SHORT,0,t.numInstances):n.gl.drawElements(+t.mode||n.gl[t.mode],n.models[t.type].indices.length,5123,0)):t.isInstanced?n.gl.drawArraysInstanced(+t.mode||n.gl[t.mode],0,n.models[t.type].vertices.length/3,t.numInstances):n.gl.drawArrays(+t.mode||n.gl[t.mode],0,n.models[t.type].vertices.length/3),t.isInstanced){const y=n.attribLocations.instanceModelMatrix;for(let v=0;v<4;++v)n.gl.vertexAttribDivisor(y+v,0),n.gl.disableVertexAttribArray(y+v);n.gl.vertexAttribDivisor(u,0),n.gl.disableVertexAttribArray(u)}}},lerp:(t,e)=>n.next[t]?.a?n.current[t][e]+(n.next[t][e]-n.current[t][e])*(n.next[t].f/n.next[t].a):n.next[t][e],animation:(t,e=new DOMMatrix)=>n.next[t]?e.translateSelf(n.lerp(t,"x"),n.lerp(t,"y"),n.lerp(t,"z")).rotateSelf(n.lerp(t,"rx"),n.lerp(t,"ry"),n.lerp(t,"rz")).scaleSelf(n.lerp(t,"w"),n.lerp(t,"h"),n.lerp(t,"d")):e,dist:(t,e=n.next.camera)=>t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0,ambient:t=>n.ambientLight=t,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{n.models[t]=e,e.normals&&(n.models[t].customNormals=1),n[t]=e=>n.setState(e,t)},resetView:(t=1)=>{n.gl.viewport(0,0,n.gl.canvas.width*t,n.gl.canvas.height*t),n.setState({n:"camera",fov:n.next.camera.fov})},group:t=>n.setState(t,"group"),move:(t,e)=>setTimeout(()=>{n.setState(t)},e||1),delete:(t,e)=>setTimeout(()=>{delete n.next[t]},e||1),camera:(t,e)=>setTimeout(()=>{n.setState(t,t.n="camera")},e||1),light:(t,e)=>e?setTimeout(()=>{n.setState(t,t.n="light")},e):n.setState(t,t.n="light"),cullface:!0,smooth:(t,e={},i=[],o,s,r,a,l,c,u,h,d,m,f)=>{for(n.models[t.type].normals=[],r=0;r<n.models[t.type].vertices.length;r+=3)i.push(n.models[t.type].vertices.slice(r,r+3));for((o=n.models[t.type].indices)?s=1:(o=i,s=0),r=0;r<2*o.length;r+=3){a=r%o.length,l=i[h=s?n.models[t.type].indices[a]:a],c=i[d=s?n.models[t.type].indices[a+1]:a+1],u=i[m=s?n.models[t.type].indices[a+2]:a+2];var p=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],g=[u[0]-c[0],u[1]-c[1],u[2]-c[2]];f=r>a?[0,0,0]:[p[1]*g[2]-p[2]*g[1],p[2]*g[0]-p[0]*g[2],p[0]*g[1]-p[1]*g[0]],e[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],e[c[0]+"_"+c[1]+"_"+c[2]]||=[0,0,0],e[u[0]+"_"+u[1]+"_"+u[2]]||=[0,0,0],n.models[t.type].normals[h]=e[l[0]+"_"+l[1]+"_"+l[2]]=e[l[0]+"_"+l[1]+"_"+l[2]].map((t,e)=>t+f[e]),n.models[t.type].normals[d]=e[c[0]+"_"+c[1]+"_"+c[2]]=e[c[0]+"_"+c[1]+"_"+c[2]].map((t,e)=>t+f[e]),n.models[t.type].normals[m]=e[u[0]+"_"+u[1]+"_"+u[2]]=e[u[0]+"_"+u[1]+"_"+u[2]].map((t,e)=>t+f[e])}}};n.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),n.add("billboard",n.models.plane),n.cubeData={vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:Array(12).fill([1,1,0,1,0,0,1,1,0,0,1,0]).flat()},n.add("cube",n.cubeData),n.cube=t=>n.setState(t,"cube"),n.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]}),((t,e,i,o,s,r,a=[],l=[],c=[],u=20)=>{for(i=0;i<=u;i++)for(o=i*Math.PI/u,t=0;t<=u;t++)e=2*t*Math.PI/u,a.push(+(Math.sin(e)*Math.sin(o)/2).toFixed(6),+(Math.cos(o)/2).toFixed(6),+(Math.cos(e)*Math.sin(o)/2).toFixed(6)),c.push(3.5*Math.sin(t/u),-Math.sin(i/u)),t<u&&i<u&&l.push(s=i*(u+1)+t,r=s+(u+1),s+1,s+1,r,r+1);n.add("sphere",{vertices:a,uv:c,indices:l})})();const s=n,r={speedH:20,speedL:10,speedAdd:.1,jumpYVel:5,fov:60,colorClear:"#7A4141",displayViewTime:1,world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(t){this.canvas=window.document.getElementById(t),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animatePhy(),this.animateRen()},initW:function(t){const e=this.W;t.width=window.innerWidth*this.displayViewTime,t.height=window.innerHeight*this.displayViewTime,e.reset(t),e.ambient(.7),e.light({x:.5,y:-.3,z:.5}),e.clearColor(this.colorClear),e.camera({n:"camera",fov:this.fov}),e.group({n:"posZero",x:0,y:1,z:0}),e.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),e.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),e.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),e.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),e.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),e.pyramid({g:"posZero",size:1,z:10,rx:90,b:"44f"}),e.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}},a={textureMap:new Map,loadTextureIndex:1,rasterizeCanvas:document.createElement("canvas"),loadTexture:function(t){const e=[];for(var i=0;i<t.length;i++){const o=t[i];if(!0===this.textureMap.has(o.id)){e.push(Promise.resolve(this.textureMap.get(o.id)));continue}const n=new Promise(t=>{if("svg-rasterize"===o.type){const e=new Image;e.onload=()=>{const i=this.rasterizeCanvas;i.width=o.width||400,i.height=o.height||400;const n=i.getContext("2d");n.clearRect(0,0,i.width,i.height),n.drawImage(e,0,0,i.width,i.height);const s=i.toDataURL("image/png"),r=new Image;r.onload=()=>{this.textureMap.set(o.id,r),t(r)},r.id=o.id,r.src=s};const i=new Blob([o.svgCode],{type:"image/svg+xml"});e.src=URL.createObjectURL(i)}else{const e=new Image;e.onload=()=>{this.textureMap.set(o.id,e),this.loadTextureIndex++,t(e)},e.id=o.id+"-"+this.loadTextureIndex,e.src=this.dToBase64(o)}});e.push(n)}return Promise.all(e)},canvasObj:document.createElement("canvas"),dToBase64:function(t){if("svg"===t.type){const e=t.svgCode;return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)}const e=this.canvasObj;e.width=t.width||400,e.height=t.height||400,e.style.webkitFontSmoothing="antialiased",e.style.mozOsxFontSmoothing="grayscale";const i=e.getContext("2d");if(i.font="32px Arial, Helvetica, sans-serif",i.textBaseline="top","png"===t.type)return t.func(i,e.width,e.height,t,this),e.toDataURL("image/png");if("jpg"===t.type){i.fillStyle="white",i.fillRect(0,0,e.width,e.height),t.func(i,e.width,e.height,t,this);var o=t.quality||.7;return e.toDataURL("image/jpeg",o)}},errorTexture:function(t,e,i,o,n){n.hooks.emitSync("errorTexture_diy",t,e,i,o,n)}},l={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"viewLeft",arrowright:"viewRight"},isShiftPress:0,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var t=this,e=!1;document.addEventListener("keydown",function(e){"s"===e.key&&(e.ctrlKey||e.metaKey)?(e.preventDefault(),t.hooks.emit("ctrlSEvent",this,this.keys)):t._handleKey(e,1)}),document.addEventListener("keyup",function(e){t._handleKey(e,0)}),document.addEventListener("mousemove",function(i){e&&(t.keys.turnRight-=.1*i.movementX,t.keys.turnUp-=.1*i.movementY,t.hooks.emit("mouseMove",this,this.keys))}),this.canvas.addEventListener("click",i=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),e=!0,document.pointerLockElement&&t.hooks.emitSync("pointer_lock_click",t,i)}),this.lockChangeAlert=function(){e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()})},_handleKey:function(t,e){if(this.isPointerLock()){var i=this.keyMap[t.key.toLowerCase()];i&&(this.keys[i]=e),32!==t.keyCode&&"e"!==t.key.toLowerCase()||null===this.mainVPlayer||(0===this.keys.jumping&&(this.mainVPlayer.body.velocity.y=this.jumpYVel,this.hooks.emit("jump",this)),this.keys.jumping=e),16!==t.keyCode&&"q"!==t.key.toLowerCase()||(this.isShiftPress=e),this.hooks.emit("handlekey",this,this.keys)}},displayPOS:function(){const t=document.getElementById("posInfo"),e=this.mainVPlayer?.body?.position;if(!t)return 0;null!==this.mainVPlayer&&(t.textContent="位置: X:"+e.x.toFixed(2)+", Y:"+e.y.toFixed(2)+", Z:"+e.z.toFixed(2)+", | ")},WALK_SPEED:1/8,SPRINT_MIN_SPEED:5,SPRINT_MAX_SPEED:35,ACCELERATION:.25,JUMP_STRENGTH:6,JUMP_HOLD_LIMIT:30,DEG_TO_RAD:Math.PI/180,calMovePara:function(t,e,i,o,n,s,r){const a=this.keys,l=this.mainVPlayer.body,c=(r/75).toFixed(2),u=this.WALK_SPEED/c;if(a.viewForward||a.viewBackward){const e=-a.viewForward+a.viewBackward;if(this.isShiftPress){this.currentSpeed<this.SPRINT_MIN_SPEED&&(this.currentSpeed=this.SPRINT_MIN_SPEED),this.currentSpeed<this.SPRINT_MAX_SPEED&&(this.currentSpeed+=this.ACCELERATION);const t=new CANNON.Vec3(0,0,e),i=l.quaternion.vmult(t).scale(this.currentSpeed);let o=0;a.jumping?(this.jumpHoldFrames<this.JUMP_HOLD_LIMIT&&(o=this.JUMP_STRENGTH),this.jumpHoldFrames++):this.jumpHoldFrames=0,l.velocity.set(i.x,o,i.z)}else{this.currentSpeed=0,this.jumpHoldFrames=0;const o=e*u;i+=o*Math.cos(n*this.DEG_TO_RAD),t+=o*Math.sin(n*this.DEG_TO_RAD)}this.displayPOS(),this.hooks.emit("forwardBackward",this)}return(a.viewLeft||a.viewRight)&&(i+=(-a.viewLeft+a.viewRight)*Math.cos((n+90)*Math.PI/180)/10*8*u,t+=(-a.viewLeft+a.viewRight)*Math.sin((n+90)*Math.PI/180)/10*8*u,this.displayPOS()),this.lastIsShiftPress!==this.isShiftPress&&this.lastIsShiftPress&&l.velocity.set(0,0,0),this.lastIsShiftPress=this.isShiftPress,n=this.keys.turnRight,{x:t,y:e,z:i,rx:this.keys.turnUp,ry:n,rz:s}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(t,e=75){if(null===t)return;const i=this.mainCamera;!1===this.isMVPInit&&(i.groupName=t.name,this.isMVPInit=!0);const o=t.body.position,n=t.body.quaternion,s=this.calMovePara(o.x,o.y,o.z,i.qua.rx,i.qua.ry,i.qua.rz,e);t.body.position.x=s.x,t.body.position.y=s.y,t.body.position.z=s.z,i.qua=s,n.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*s.ry),this.W.camera({g:t.name,x:i.pos.x,y:i.pos.y,z:i.pos.z,rx:i.qua.rx,rz:i.qua.rz});const r=t.body.position,a=t.body.quaternion,l=this.quaternionToEuler(a);return t.quat=a,t.rX=l.rX,t.rY=l.rY,t.rZ=l.rZ,t.X=r.x,t.Y=r.y,t.Z=r.z,this.W.move({n:t.name,x:t.X,y:t.Y,z:t.Z,rx:t.rX,ry:t.rY,rz:t.rZ}),t.posID=this.calPosID(t.X,t.Y,t.Z,2),0}},c={calPosID:function(t,e,i,o){const n={2:100,3:100,4:40}[o]||0;if(2===o&&(o=""),0===n)return 0;var s=-1===Math.sign(t)?"X":"D",r=-1===Math.sign(i)?"B":"N";return o+s+Math.ceil(t/n*Math.sign(t))+r+Math.ceil(i/n*Math.sign(i))},gridsize:new Uint16Array([1e4,1e3,100,20,5,1]),gridsizeY:new Float32Array([1e4,1e3,100,20,5,1]),currentlyActiveIndices:new Set,activationQueue:new Array,minY:null,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";const t=this.mainVPlayer,e=[];for(let i=0;i<this.gridsize.length;i++){const o=Math.floor(t.X/this.gridsize[i]),n=Math.floor(t.Z/this.gridsize[i]);for(let t=-1;t<=1;t++)for(let s=-1;s<=1;s++)e.push(`${i}_${o+t}_${n+s}`)}const i=new Set,o=new Set(this.currentlyActiveIndices);for(const o of e){const e=this.spatialGrid.get(o);if(e)for(const o of e){const e=this.gridsizeY[this.physicsProps[8*o+4]].toFixed(2);Math.abs(this.positionsStatus[8*o+1]-t.Y)<e&&i.add(o)}}for(const t of i)o.delete(t);for(const t of i)if(!this.currentlyActiveIndices.has(t)){const e=8*t;this.positionsStatus[e+7]=this.physicsProps[e],this.activeTABox(t)}for(const t of o){const e=8*t;this.positionsStatus[e+7]=-1,this.hiddenTABox(t)}this.currentlyActiveIndices=i,this.activationQueue.length>0&&!this.isActivationScheduled&&(this.isActivationScheduled=!0)}},u={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(t=1e6){this.positionsStatus=new Float32Array(8*t),this.physicsProps=new Float32Array(8*t),this.freeSlots=new Array(t).fill(0).map((e,i)=>t-1-i)},addTABox:function({DPZ:t=3,X:e=5,Y:i=5,Z:o=5,quat:n={x:0,y:0,z:0,w:1},mass:s=0,width:r=1,depth:a=1,height:l=1,size:c=1,rX:u=0,rY:h=0,rZ:d=0}={}){const m=Array.from(arguments)[0];if(m.deleteFunc=null,1!==c&&(r=a=l=c),(u||h||d)&&(n=this.eulerToQuaternion({rX:u,rY:h,rZ:d})),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;const f=this.freeSlots.pop(),p=8*f;this.positionsStatus[p]=e,this.positionsStatus[p+1]=i,this.positionsStatus[p+2]=o,this.positionsStatus[p+3]=n.x,this.positionsStatus[p+4]=n.y,this.positionsStatus[p+5]=n.z,this.positionsStatus[p+6]=n.w,this.positionsStatus[p+7]=s,this.physicsProps[p]=s,this.physicsProps[p+1]=r,this.physicsProps[p+2]=l,this.physicsProps[p+3]=a,this.physicsProps[p+4]=t;const g=`${t}_${Math.floor(e/this.gridsize[t])}_${Math.floor(o/this.gridsize[t])}`;let y=this.spatialGrid.get(g);return y||(y=[]),y.push(f),this.spatialGrid.set(g,y),this.indexToArgs.set(f,m),f},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1,isInvisible:!1,activeFunc:null,textureRatio:1},argsObj:{},activeTABox:function(t){const e=8*t,i=this.positionsStatus.subarray(e,e+8),o=this.physicsProps.subarray(e,e+4),n=this.indexToArgs.get(t);this.argsObj={...this.defaultBoxArgs,...n};const s=this.argsObj;if(s.isPhysical){const t=new CANNON.Body;var r;if(t.mass=o[0],t.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,"sphere"===s.shape)r=new CANNON.Sphere(o[1]/2);else{const t=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2);r=new CANNON.Box(t)}t.addShape(r),t.position.set(i[0],i[1],i[2]),t.material=this.cannonDefaultContactMaterial,t.updateMassProperties(),t.wakeUp(),t.collisionFilterGroup=s.colliGroup;const e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};t.collisionFilterMask=e[s.colliGroup],this.world.addBody(t),t.quaternion.set(i[3],i[4],i[5],i[6]),n.body=t}if(!1!==s.isVisualMode){var a=s.tiling;"number"==typeof a&&(a=[a,a]);const e=s.isFictBody?.1:0;var l,c=!1;if("string"==typeof s.texture?void 0!==window[s.texture]||this.textureMap.has(s.texture)?l=this.textureMap.has(s.texture)?this.textureMap.get(s.texture):window[s.texture]:(l=null,c=!0):l=s.texture,this.W[s.shape]({n:"T"+t,w:o[1]-e,d:o[3]-e,h:o[2]-e,x:i[0],y:i[1],z:i[2],t:l,s:s.smooth,tile:a,rx:s.rX,ry:s.rY,rz:s.rZ,b:s.background,mix:s.mixValue,shadow:s.isShadow,hidden:s.isInvisible}),null!==s.activeFunc&&s.activeFunc(t),c){const i=this.errExpRatio*s.textureRatio,n=(o[1]-e)*i,r=(o[2]-e)*i;this.loadTexture([{func:this.errorTexture,id:s.texture,type:"png",width:n,height:r,index:t}]).then(e=>{this.W[s.shape]({n:"T"+t,t:this.textureMap.get(s.texture),mix:s.mixValue})})}}},errExpRatio:40,hiddenTABox:function(t){const e=this.indexToArgs.get(t);!1!==e.isPhysical&&void 0!==e.body&&this.world.removeBody(e.body),!1!==e.isVisualMode&&this.W.delete("T"+t),null!==e.deleteFunc&&e.deleteFunc(t)},addMVP:function({colliGroup:t=2,name:e="k"+this.bodyObjName++,X:i=5,Y:o=5,Z:n=5,quat:s=null,mass:r=0,width:a=1,depth:l=1,height:c=1,size:u=1,rX:h=0,rY:d=0,rZ:m=0}={}){a=l=c=u;const f=new CANNON.Vec3(a/2,c/2,l/2);var p=new CANNON.Box(f),g=new CANNON.Body({mass:r,shape:p,position:new CANNON.Vec3(i,o,n),material:this.cannonDefaultCantactMaterial});g.collisionFilterGroup=t;const y={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};return g.collisionFilterMask=y[t],this.world.addBody(g),s&&g.quaternion.set(s.x,s.y,s.z,s.w),s=g.quaternion,{name:e,body:g,X:i,Y:o,Z:n,rX:h,rY:d,rZ:m}}},h={hooks:i,W:s,...o,...r,...a,...l,...c,...u,gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const i of this.currentlyActiveIndices){const o=8*i;if(this.positionsStatus[o+7]>0){const n=this.indexToArgs.get(i),s=n.body;if(!s)continue;const r=s.position.x-this.positionsStatus[o],a=s.position.y-this.positionsStatus[o+1],l=s.position.z-this.positionsStatus[o+2],c=Math.sqrt(r*r+a*a+l*l);if(this.positionsStatus[o]=s.position.x,this.positionsStatus[o+1]=s.position.y,this.positionsStatus[o+2]=s.position.z,this.positionsStatus[o+3]=s.quaternion.x,this.positionsStatus[o+4]=s.quaternion.y,this.positionsStatus[o+5]=s.quaternion.z,this.positionsStatus[o+6]=s.quaternion.w,!1!==n.isVisualMode&&this.W.next["T"+i]&&c>1e-4){const r=this.quaternionToEuler(s.quaternion);if(this.W.move({n:"T"+i,x:this.positionsStatus[o],y:this.positionsStatus[o+1],z:this.positionsStatus[o+2],rx:r.rX,ry:r.rY,rz:r.rZ}),c>.01&&performance.now()-this.gridKeyCurrentTime>500){const s=n.gridkey||0,r=this.physicsProps[o+4],a=`${r}_${Math.floor(this.positionsStatus[o]/this.gridsize[r])}_${Math.floor(this.positionsStatus[o+2]/this.gridsize[r])}`;if(s&&a!==s){var t=this.spatialGrid.get(s);if(t){const e=t.indexOf(i);e>-1&&(t.splice(e,1),this.spatialGrid.set(s,t))}var e=this.spatialGrid.get(a);e||(e=[]),e.push(i),this.spatialGrid.set(a,e)}n.gridkey=a,this.gridKeyCurrentTime=performance.now()}}}}},cannonAni:function(){this.world.step(1/60)},targetFps:75,animatePhy:function(){const t=this;let e=performance.now();const i=1e3/t.targetFps;!function o(){const n=performance.now(),s=n-e;s>=i&&(e=n-s%i,t.cannonAni()),setTimeout(o,0)}()},fps:0,animateRen:function(){var t=this;let e=performance.now(),i=75;const o=function(){const n=performance.now();i=1e3/(n-e),e=n,t.updataBodylist(),t.mainVPlayerMove(t.mainVPlayer,i),t.hooks.emit("animatePreFrame",t),requestAnimationFrame(o)};o()}};!function(t){const e=t.W;e.dynimicIns=!0,e.updateInstance=function(t,i,o){const n=e.next[t];if(!n?.isInstanced||!n.instances?.[i])return;const s=n.instances[i];Object.assign(s,o);const r=new DOMMatrix;r.translateSelf((s.x||0)+(n.x||0),(s.y||0)+(n.y||0),(s.z||0)+(n.z||0)).rotateSelf(s.rx||0,s.ry||0,s.rz||0).scaleSelf(s.w||1,s.h||1,s.d||1);const a=e.instanceMatrixBuffers[t];if(e.gl.bindBuffer(e.gl.ARRAY_BUFFER,a),e.gl.bufferSubData(e.gl.ARRAY_BUFFER,16*i*4,r.toFloat32Array()),o.b){const n=e.instanceColorBuffers[t];e.gl.bindBuffer(e.gl.ARRAY_BUFFER,n),e.gl.bufferSubData(e.gl.ARRAY_BUFFER,4*i*4,new Float32Array(e.col(o.b)))}},e.deleteInstance=function(t,i){e.updateInstance(t,i,{w:.001,h:.001,d:.001})}}(h),window.openworld=h;const d=h;return e})());