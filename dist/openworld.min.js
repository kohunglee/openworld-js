!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.openworld=e():t.openworld=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>h});const i={_hookQueues:new Map,on(t,e,i=100){if("function"!=typeof e)throw new TypeError("Callback must be function");const o=this._hookQueues.get(t)||[];o.push({func:e,priority:i}),o._isSorted=!1,this._hookQueues.set(t,o)},off(t,e){const i=this._hookQueues.get(t);if(!i)return;const o=i.filter(t=>t.func!==e);0===o.length?this._hookQueues.delete(t):o.length<i.length&&(o._isSorted=!1,this._hookQueues.set(t,o))},_getSortedCallbacks(t){let e=this._hookQueues.get(t);return e?(e._isSorted||(e.sort((t,e)=>e.priority-t.priority),e._isSorted=!0),[...e]):[]},async emit(t,...e){const i=this._getSortedCallbacks(t).map(t=>t.func).map(async t=>{try{return await t(...e)}catch(t){throw t}});return Promise.allSettled(i)},emitSync(t,...e){const i=[];for(const{func:o}of this._getSortedCallbacks(t))try{const t=o(...e);if(i.push({status:"fulfilled",value:t}),!1===t)break}catch(t){i.push({status:"rejected",reason:t})}return i}},o={quaternionToEuler:function(t){const{x:e,y:i,z:o,w:r}=t,n=Math.atan2(2*(r*e+i*o),1-2*(e*e+i*i)),s=2*(r*i-o*e),a=Math.asin(Math.max(-1,Math.min(1,s))),l=Math.atan2(2*(r*o+e*i),1-2*(i*i+o*o)),c=t=>t*(180/Math.PI);return{rX:c(n),rY:c(a),rZ:c(l)}},eulerToQuaternion:function(t){const{rX:e,rY:i,rZ:o}=t,r=t=>t*(Math.PI/180),n=.5*r(e),s=.5*r(i),a=.5*r(o),l=Math.sin(n),c=Math.cos(n),d=Math.sin(s),u=Math.cos(s),h=Math.sin(a),m=Math.cos(a);return{x:l*u*m-c*d*h,y:c*d*m+l*u*h,z:c*u*h-l*d*m,w:c*u*m+l*d*h}},genPR:function(t,e){let i=Math.abs(t)||1;i=1664525*i+1013904223|0;const o=new Float32Array(e),r=1/4294967296;for(let t=0;t<e;t++)i^=i<<13,i^=i>>17,i^=i<<5,o[t]=(i>>>0)*r;return o},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})},r={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i,reset:t=>{var e;r.canvas=t,r.objs=0,r.current={},r.next={},r.textures={},r.viewLimit=5e3,r.gl=t.getContext("webgl2"),r.gl.blendFunc(770,771),r.gl.activeTexture(33984),r.program=r.gl.createProgram(),r.gl.enable(2884),r.instanceColorBuffers={},r.lastFrame=0,r.drawTime=0,r.lastReportTime=0,r.gl.shaderSource(e=r.gl.createShader(35633),"#version 300 es\n          precision lowp float;                        \n          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...\n          in mat4 instanceModelMatrix;                  // 实例化模型的 模型\n          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵\n          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]\n          out vec4 v_pos, v_col, v_uv, v_normal;\n          uniform bool isInstanced;              // 是不是实例化绘制\n          void main() {\n            mat4 currentModelMatrix;             // 当前的模型矩阵\n            if (isInstanced) {\n              currentModelMatrix = instanceModelMatrix;\n            } else {\n              currentModelMatrix = m;\n            }\n            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos\n              v_pos = bb.z > 0.                         \n              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌\n              : currentModelMatrix * pos               \n            );\n            v_col = col;\n            v_uv = uv;\n            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵\n          }"),r.gl.compileShader(e),r.gl.attachShader(r.program,e),r.gl.shaderSource(e=r.gl.createShader(35632),"#version 300 es\n          precision lowp float;\n          in vec4 v_pos, v_col, v_uv, v_normal;\n          uniform vec3 light;\n          uniform vec2 tiling;\n          uniform vec4 o;\n          uniform sampler2D sampler;\n          out vec4 c;\n          void main() {\n            vec2 final_uv = v_uv.xy;  //+ 新增纹理面修正逻辑，修复纹理面翻转问题\n            if (!gl_FrontFacing) {\n              final_uv.x = 1.0 - final_uv.x;\n            }\n            c = mix(texture(sampler, final_uv * tiling), v_col, o[3]);\n            if(o[1] > 0.){\n              c = vec4(\n                c.rgb * (max(0., dot(light, -normalize(\n                  o[0] > 0.\n                  ? vec3(v_normal.xyz)\n                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))\n                )))\n                + o[2]),\n                c.a\n              );\n            }\n          }"),r.gl.compileShader(e),r.gl.attachShader(r.program,e),r.gl.linkProgram(r.program),r.gl.useProgram(r.program),r.clearColor=t=>r.gl.clearColor(...r.col(t)),r.wjsHooks.emitSync("reset_ok",r),r.uniformLocations={pv:r.gl.getUniformLocation(r.program,"pv"),eye:r.gl.getUniformLocation(r.program,"eye"),m:r.gl.getUniformLocation(r.program,"m"),im:r.gl.getUniformLocation(r.program,"im"),bb:r.gl.getUniformLocation(r.program,"bb"),isInstanced:r.gl.getUniformLocation(r.program,"isInstanced"),o:r.gl.getUniformLocation(r.program,"o"),light:r.gl.getUniformLocation(r.program,"light"),tiling:r.gl.getUniformLocation(r.program,"tiling"),sampler:r.gl.getUniformLocation(r.program,"sampler"),u_MvpMatrixFromLight:r.gl.getUniformLocation(r.program,"u_MvpMatrixFromLight"),u_ShadowMap:r.gl.getUniformLocation(r.program,"u_ShadowMap")},r.attribLocations={pos:r.gl.getAttribLocation(r.program,"pos"),col:r.gl.getAttribLocation(r.program,"col"),uv:r.gl.getAttribLocation(r.program,"uv"),normal:r.gl.getAttribLocation(r.program,"normal"),instanceModelMatrix:r.gl.getAttribLocation(r.program,"instanceModelMatrix")},r.clearColor("fff"),r.gl.enable(2929),r.light({y:-1}),r.camera({fov:30}),setTimeout(r.draw,16)},setState:(t,e,i,o,n=[],s,a,l,c,d,u,h,m)=>{if(t.n||="o"+r.objs++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!r.textures[t.t.id]&&(i=r.gl.createTexture(),r.gl.pixelStorei(37441,!1),r.gl.bindTexture(3553,i),r.gl.pixelStorei(37440,1),r.gl.texImage2D(3553,0,6408,6408,5121,t.t),r.gl.generateMipmap(3553),r.textures[t.t.id]=i),t.instances&&Array.isArray(t.instances)){t.isInstanced=!0,t.numInstances=t.instances.length;const e=[],i=[];for(const i of t.instances){const o=new DOMMatrix;o.translateSelf((i.x||0)+(t.x||0),(i.y||0)+(t.y||0),(i.z||0)+(t.z||0)).rotateSelf(i.rx||0,i.ry||0,i.rz||0).scaleSelf(i.w||1,i.h||1,i.d||1),e.push(...o.toFloat32Array())}for(const e of t.instances)i.push(...r.col(e.b||"888"));const o=new Float32Array(e),n=r.gl.createBuffer();r.gl.bindBuffer(r.gl.ARRAY_BUFFER,n),r.gl.bufferData(r.gl.ARRAY_BUFFER,o,r.gl.DYNAMIC_DRAW),r.instanceMatrixBuffers[t.n]=n,r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.instanceColorBuffers[t.n]=r.gl.createBuffer()),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(i),r.gl.DYNAMIC_DRAW)}else t.isInstanced=!1;if(t.fov){var p=r.viewLimit;r.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(r.canvas.width/r.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-(p+.1)/(p-.1),-1,0,0,-2*p*.1/(p-.1),0])}t={type:e,...r.current[t.n]=r.next[t.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0,hidden:!1,uncullface:0,smooth:0,t:t.t,texture:i,normal:n,A:s,B:a,C:l,Ai:c,Bi:d,Ci:u,AB:h,BC:m,...t},...t,f:0},r.models[t.type]?.vertices&&!r.models?.[t.type].verticesBuffer&&(r.gl.bindBuffer(34962,r.models[t.type].verticesBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[t.type].vertices),35044),!r.models[t.type].normals&&r.smooth&&r.smooth(t),r.models[t.type].normals&&(r.gl.bindBuffer(34962,r.models[t.type].normalsBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[t.type].normals.flat()),35044))),r.models[t.type]?.uv&&!r.models[t.type].uvBuffer&&(r.gl.bindBuffer(34962,r.models[t.type].uvBuffer=r.gl.createBuffer()),r.gl.bufferData(34962,new Float32Array(r.models[t.type].uv),35044)),r.models[t.type]?.indices&&!r.models[t.type].indicesBuffer&&(r.gl.bindBuffer(34963,r.models[t.type].indicesBuffer=r.gl.createBuffer()),r.gl.bufferData(34963,new Uint16Array(r.models[t.type].indices),35044)),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,r.next[t.n]=t},draw:(t,e,i,o,n=[])=>{const s=performance.now();if(e=t-r.lastFrame,r.lastFrame=t,requestAnimationFrame(r.draw),r.debugFBO)renderFBOToCanvas();else{for(o in r.next.camera.g&&r.render(r.next[r.next.camera.g],e,1),i=r.animation("camera"),r.next?.camera?.g&&i.preMultiplySelf(r.next[r.next.camera.g].M||r.next[r.next.camera.g].m),r.gl.uniformMatrix4fv(r.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(r.projection),r.gl.uniformMatrix4fv(r.uniformLocations.pv,!1,i.toFloat32Array()),r.wjsHooks.emitSync("shadow_draw",r),r.gl.clear(16640),r.next){const t=r.next[o];!0!==t.hidden&&(t.isInstanced||t.t||1!=r.col(t.b)[3]?n.push(t):r.render(t,e))}for(o of(n.sort((t,e)=>r.dist(e)-r.dist(t)),r.gl.enable(3042),r.gl.depthMask(1),n))o.isInstanced&&r.render(o,e);for(o of n)o.isInstanced||r.render(o,e);r.gl.depthMask(1),r.gl.disable(3042),r.gl.uniform3f(r.uniformLocations.light,r.lerp("light","x"),r.lerp("light","y"),r.lerp("light","z")),t-r.lastReportTime>=1e3&&(r.drawTime=(performance.now()-s).toFixed(2)+"ms",r.lastReportTime=t)}},render:(t,e,i=["camera","light","group"].includes(t.type),o)=>{if(t.t&&(r.gl.activeTexture(r.gl.TEXTURE0),r.gl.bindTexture(3553,r.textures[t.t.id]),r.gl.uniform1i(r.uniformLocations.sampler,0),r.gl.uniform2f(r.uniformLocations.tiling,t.tile?.[0]||1,t.tile?.[1]||1)),t.isInstanced||(t.f<t.a&&(t.f+=e),t.f>t.a&&(t.f=t.a),r.next[t.n].m=r.animation(t.n),r.next[t.g]&&r.next[t.n].m.preMultiplySelf(r.next[t.g].M||r.next[t.g].m),i||(r.gl.uniformMatrix4fv(r.uniformLocations.m,!1,(r.next[t.n].M||r.next[t.n].m).toFloat32Array()),r.gl.uniformMatrix4fv(r.uniformLocations.im,!1,new DOMMatrix(r.next[t.n].M||r.next[t.n].m).invertSelf().toFloat32Array()))),!i){if(!r.models[t.type]?.verticesBuffer)return 0;if(r.gl.bindBuffer(34962,r.models[t.type].verticesBuffer),r.gl.vertexAttribPointer(o=r.attribLocations.pos,3,5126,!1,0,0),r.gl.enableVertexAttribArray(o),r.gl.vertexAttribDivisor(o,0),r.models[t.type].uvBuffer&&(r.gl.bindBuffer(34962,r.models[t.type].uvBuffer),r.gl.vertexAttribPointer(o=r.attribLocations.uv,2,5126,!1,0,0),r.gl.enableVertexAttribArray(o),r.gl.vertexAttribDivisor(o,0)),(t.s||r.models[t.type].customNormals)&&r.models[t.type].normalsBuffer&&(r.gl.bindBuffer(34962,r.models[t.type].normalsBuffer),r.gl.vertexAttribPointer(o=r.attribLocations.normal,3,5126,!1,0,0),r.gl.enableVertexAttribArray(o),r.gl.vertexAttribDivisor(o,0)),r.gl.uniform1i(r.uniformLocations.isInstanced,t.isInstanced?1:0),t.isInstanced&&r.instanceMatrixBuffers[t.n]){const e=r.instanceMatrixBuffers[t.n];r.gl.bindBuffer(r.gl.ARRAY_BUFFER,e);const i=r.attribLocations.instanceModelMatrix,o=16*Float32Array.BYTES_PER_ELEMENT;for(let t=0;t<4;++t){const e=i+t;r.gl.enableVertexAttribArray(e),r.gl.vertexAttribPointer(e,4,r.gl.FLOAT,!1,o,4*t*Float32Array.BYTES_PER_ELEMENT),r.gl.vertexAttribDivisor(e,1)}}r.gl.uniform4f(r.uniformLocations.o,t.s,(t.mode>3||r.gl[t.mode]>3)&&!t.ns?1:0,r.ambientLight||.2,t.mix),r.gl.uniform4f(r.uniformLocations.bb,t.w,t.h,"billboard"==t.type,0);const e=r.attribLocations.col;if(t.isInstanced?(r.gl.enableVertexAttribArray(e),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,r.instanceColorBuffers[t.n]),r.gl.vertexAttribPointer(e,4,r.gl.FLOAT,!1,0,0),r.gl.vertexAttribDivisor(e,1)):r.gl.vertexAttrib4fv(e,r.col(t.b||"888")),t.uncullface?(r.gl.disable(2884),r.cullface=!1):!0!==r.cullface&&(r.gl.enable(2884),r.cullface=!0),r.models[t.type].indicesBuffer?(r.gl.bindBuffer(34963,r.models[t.type].indicesBuffer),t.isInstanced?r.gl.drawElementsInstanced(+t.mode||r.gl[t.mode],r.models[t.type].indices.length,r.gl.UNSIGNED_SHORT,0,t.numInstances):r.gl.drawElements(+t.mode||r.gl[t.mode],r.models[t.type].indices.length,5123,0)):t.isInstanced?r.gl.drawArraysInstanced(+t.mode||r.gl[t.mode],0,r.models[t.type].vertices.length/3,t.numInstances):r.gl.drawArrays(+t.mode||r.gl[t.mode],0,r.models[t.type].vertices.length/3),t.isInstanced){const t=r.attribLocations.instanceModelMatrix;for(let e=0;e<4;++e)r.gl.vertexAttribDivisor(t+e,0),r.gl.disableVertexAttribArray(t+e);r.gl.vertexAttribDivisor(e,0),r.gl.disableVertexAttribArray(e)}}},lerp:(t,e)=>r.next[t]?.a?r.current[t][e]+(r.next[t][e]-r.current[t][e])*(r.next[t].f/r.next[t].a):r.next[t][e],animation:(t,e=new DOMMatrix)=>r.next[t]?e.translateSelf(r.lerp(t,"x"),r.lerp(t,"y"),r.lerp(t,"z")).rotateSelf(r.lerp(t,"rx"),r.lerp(t,"ry"),r.lerp(t,"rz")).scaleSelf(r.lerp(t,"w"),r.lerp(t,"h"),r.lerp(t,"d")):e,dist:(t,e=r.next.camera)=>t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0,ambient:t=>r.ambientLight=t,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{r.models[t]=e,e.normals&&(r.models[t].customNormals=1),r[t]=e=>r.setState(e,t)},resetView:(t=1)=>{r.gl.viewport(0,0,r.gl.canvas.width*t,r.gl.canvas.height*t),r.setState({n:"camera",fov:r.next.camera.fov})},group:t=>r.setState(t,"group"),move:(t,e)=>setTimeout(()=>{r.setState(t)},e||1),delete:(t,e)=>setTimeout(()=>{delete r.next[t]},e||1),camera:(t,e)=>setTimeout(()=>{r.setState(t,t.n="camera")},e||1),light:(t,e)=>e?setTimeout(()=>{r.setState(t,t.n="light")},e):r.setState(t,t.n="light"),cullface:!0,smooth:(t,e={},i=[],o,n,s,a,l,c,d,u,h,m,p)=>{for(r.models[t.type].normals=[],s=0;s<r.models[t.type].vertices.length;s+=3)i.push(r.models[t.type].vertices.slice(s,s+3));for((o=r.models[t.type].indices)?n=1:(o=i,n=0),s=0;s<2*o.length;s+=3){a=s%o.length,l=i[u=n?r.models[t.type].indices[a]:a],c=i[h=n?r.models[t.type].indices[a+1]:a+1],d=i[m=n?r.models[t.type].indices[a+2]:a+2];var f=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],g=[d[0]-c[0],d[1]-c[1],d[2]-c[2]];p=s>a?[0,0,0]:[f[1]*g[2]-f[2]*g[1],f[2]*g[0]-f[0]*g[2],f[0]*g[1]-f[1]*g[0]],e[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],e[c[0]+"_"+c[1]+"_"+c[2]]||=[0,0,0],e[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],r.models[t.type].normals[u]=e[l[0]+"_"+l[1]+"_"+l[2]]=e[l[0]+"_"+l[1]+"_"+l[2]].map((t,e)=>t+p[e]),r.models[t.type].normals[h]=e[c[0]+"_"+c[1]+"_"+c[2]]=e[c[0]+"_"+c[1]+"_"+c[2]].map((t,e)=>t+p[e]),r.models[t.type].normals[m]=e[d[0]+"_"+d[1]+"_"+d[2]]=e[d[0]+"_"+d[1]+"_"+d[2]].map((t,e)=>t+p[e])}}};r.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),r.add("billboard",r.models.plane),r.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),r.cube=t=>r.setState(t,"cube"),r.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]}),((t,e,i,o,n,s,a=[],l=[],c=[],d=20)=>{for(i=0;i<=d;i++)for(o=i*Math.PI/d,t=0;t<=d;t++)e=2*t*Math.PI/d,a.push(+(Math.sin(e)*Math.sin(o)/2).toFixed(6),+(Math.cos(o)/2).toFixed(6),+(Math.cos(e)*Math.sin(o)/2).toFixed(6)),c.push(3.5*Math.sin(t/d),-Math.sin(i/d)),t<d&&i<d&&l.push(n=i*(d+1)+t,s=n+(d+1),n+1,n+1,s,s+1);r.add("sphere",{vertices:a,uv:c,indices:l})})();const n=r,s={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",displayViewTime:.9,world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(t){this.canvas=window.document.getElementById(t),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate()},initW:function(t){const e=this.W;t.width=window.innerWidth*this.displayViewTime,t.height=window.innerHeight*this.displayViewTime,e.reset(t),e.ambient(.7),e.light({x:.5,y:-.3,z:.5}),e.clearColor(this.colorClear),e.camera({n:"camera",fov:this.fov}),e.group({n:"posZero",x:0,y:1,z:0}),e.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),e.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),e.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),e.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),e.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),e.pyramid({g:"posZero",size:1,z:10,rx:90,b:"44f"}),e.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}},a={textureMap:new Map,loadTextureIndex:1,rasterizeCanvas:document.createElement("canvas"),loadTexture:function(t){const e=[];for(var i=0;i<t.length;i++){const o=t[i];if(!0===this.textureMap.has(o.id)){e.push(Promise.resolve(this.textureMap.get(o.id)));continue}const r=new Promise(t=>{if("svg-rasterize"===o.type){const e=new Image;e.onload=()=>{const i=this.rasterizeCanvas;i.width=o.width||400,i.height=o.height||400;const r=i.getContext("2d");r.clearRect(0,0,i.width,i.height),r.drawImage(e,0,0,i.width,i.height);const n=i.toDataURL("image/png"),s=new Image;s.onload=()=>{this.textureMap.set(o.id,s),t(s)},s.id=o.id,s.src=n};const i=new Blob([o.svgCode],{type:"image/svg+xml"});e.src=URL.createObjectURL(i)}else{const e=new Image;e.onload=()=>{this.textureMap.set(o.id,e),this.loadTextureIndex++,t(e)},e.id=o.id+"-"+this.loadTextureIndex,e.src=this.dToBase64(o)}});e.push(r)}return Promise.all(e)},canvasObj:document.createElement("canvas"),dToBase64:function(t){if("svg"===t.type){const e=t.svgCode.replace(/#/g,"%23");return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)}const e=this.canvasObj;e.width=t.width||400,e.height=t.height||400,e.style.webkitFontSmoothing="antialiased",e.style.mozOsxFontSmoothing="grayscale";const i=e.getContext("2d");if("png"===t.type)return t.func(i,e.width,e.height,t,this),e.toDataURL("image/png");if("jpg"===t.type){i.fillStyle="white",i.fillRect(0,0,e.width,e.height),t.func(i,e.width,e.height,t,this);var o=t.quality||.7;return e.toDataURL("image/jpeg",o)}},errorTexture:function(t,e,i,o,r){r.hooks.emitSync("errorTexture_diy",t,e,i,o,r)}},l={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var t=this,e=!1;document.addEventListener("keydown",function(e){t._handleKey(e,1)}),document.addEventListener("keyup",function(e){t._handleKey(e,0)}),document.addEventListener("mousemove",function(i){e&&(t.keys.turnRight-=.1*i.movementX,t.keys.turnUp-=.1*i.movementY)}),this.canvas.addEventListener("click",i=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),e=!0,document.pointerLockElement&&t.hooks.emitSync("pointer_lock_click",t,i)}),this.lockChangeAlert=function(){e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()})},_handleKey:function(t,e){if(this.isPointerLock()){var i=this.keyMap[t.key.toLowerCase()];i&&(this.keys[i]=e),32!==t.keyCode&&"e"!==t.key.toLowerCase()||null===this.mainVPlayer||(0===this.keys.jumping&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=e),16!==t.keyCode&&"q"!==t.key.toLowerCase()||(this.isShiftPress=e)}},forwardAcc:0,displayPOS:function(){var t=document.getElementById("posInfo");if(!t)return 0;null!==this.mainVPlayer&&(t.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(t,e,i,o,r,n){const s=this.keys;if(s.viewForward||s.viewBackward){var a=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01);this.hooks.emit("forwardBackward",this,a),i+=(-s.viewForward+s.viewBackward)*Math.cos(r*Math.PI/180)/a,t+=(-s.viewForward+s.viewBackward)*Math.sin(r*Math.PI/180)/a,this.displayPOS()}return(s.viewLeft||s.viewRight)&&(i+=(-s.viewLeft+s.viewRight)*Math.cos((r+90)*Math.PI/180)/10,t+=(-s.viewLeft+s.viewRight)*Math.sin((r+90)*Math.PI/180)/10,this.displayPOS()),r=this.keys.turnRight,{x:t,y:e,z:i,rx:this.keys.turnUp,ry:r,rz:n}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(t){if(null===t)return;const e=this.mainCamera;!1===this.isMVPInit&&(e.groupName=t.name,this.isMVPInit=!0);const i=t.body.position,o=t.body.quaternion,r=this.calMovePara(i.x,i.y,i.z,e.qua.rx,e.qua.ry,e.qua.rz);t.body.position.x=r.x,t.body.position.y=r.y,t.body.position.z=r.z,e.qua=r,o.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*r.ry),this.W.camera({g:t.name,x:e.pos.x,y:e.pos.y,z:e.pos.z,rx:e.qua.rx,rz:e.qua.rz});const n=t.body.position,s=t.body.quaternion,a=this.quaternionToEuler(s);return t.quat=s,t.rX=a.rX,t.rY=a.rY,t.rZ=a.rZ,t.X=n.x,t.Y=n.y,t.Z=n.z,this.W.move({n:t.name,x:t.X,y:t.Y,z:t.Z,rx:t.rX,ry:t.rY,rz:t.rZ}),t.posID=this.calPosID(t.X,t.Y,t.Z,2),0}},c={calPosID:function(t,e,i,o){const r={2:100,3:100,4:40}[o]||0;if(2===o&&(o=""),0===r)return 0;var n=-1===Math.sign(t)?"X":"D",s=-1===Math.sign(i)?"B":"N";return o+n+Math.ceil(t/r*Math.sign(t))+s+Math.ceil(i/r*Math.sign(i))},gridsize:new Uint16Array([1e4,1e3,100,20,5]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";const t=this.mainVPlayer,e=[];for(let i=0;i<this.gridsize.length;i++){const o=Math.floor(t.X/this.gridsize[i]),r=Math.floor(t.Z/this.gridsize[i]);for(let t=-1;t<=1;t++)for(let n=-1;n<=1;n++)e.push(`${i}_${o+t}_${r+n}`)}const i=new Set,o=new Set(this.currentlyActiveIndices);for(const o of e){const e=this.spatialGrid.get(o);if(e)for(const o of e)Math.abs(this.positionsStatus[8*o+1]-t.Y)<this.gridsize[this.physicsProps[8*o+4]]&&i.add(o)}for(const t of i)o.delete(t);for(const t of i)if(!this.currentlyActiveIndices.has(t)){const e=8*t;this.positionsStatus[e+7]=this.physicsProps[e],this.activeTABox(t)}for(const t of o){const e=8*t;this.positionsStatus[e+7]=-1,this.hiddenTABox(t)}this.currentlyActiveIndices=i,this.activationQueue.length>0&&!this.isActivationScheduled&&(this.isActivationScheduled=!0)}},d={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(t=1e6){this.positionsStatus=new Float32Array(8*t),this.physicsProps=new Float32Array(8*t),this.freeSlots=new Array(t).fill(0).map((e,i)=>t-1-i)},addTABox:function({DPZ:t=3,X:e=5,Y:i=5,Z:o=5,quat:r={x:0,y:0,z:0,w:1},mass:n=0,width:s=1,depth:a=1,height:l=1,size:c=1,rX:d=0,rY:u=0,rZ:h=0}={}){const m=Array.from(arguments)[0];if(1!==c&&(s=a=l=c),(d||u||h)&&(r=this.eulerToQuaternion({rX:d,rY:u,rZ:h})),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;const p=this.freeSlots.pop(),f=8*p;this.positionsStatus[f]=e,this.positionsStatus[f+1]=i,this.positionsStatus[f+2]=o,this.positionsStatus[f+3]=r.x,this.positionsStatus[f+4]=r.y,this.positionsStatus[f+5]=r.z,this.positionsStatus[f+6]=r.w,this.positionsStatus[f+7]=n,this.physicsProps[f]=n,this.physicsProps[f+1]=s,this.physicsProps[f+2]=l,this.physicsProps[f+3]=a,this.physicsProps[f+4]=t;const g=`${t}_${Math.floor(e/this.gridsize[t])}_${Math.floor(o/this.gridsize[t])}`;let y=this.spatialGrid.get(g);y||(y=[]),y.push(p),this.spatialGrid.set(g,y),this.indexToArgs.set(p,m)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1,isInvisible:!1},argsObj:{},activeTABox:function(t){const e=8*t,i=this.positionsStatus.subarray(e,e+8),o=this.physicsProps.subarray(e,e+4),r=this.indexToArgs.get(t);this.argsObj={...this.defaultBoxArgs,...r};const n=this.argsObj;if(n.isPhysical){const t=new CANNON.Body;var s;if(t.mass=o[0],t.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,"sphere"===n.shape)s=new CANNON.Sphere(o[1]/2);else{const t=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2);s=new CANNON.Box(t)}t.addShape(s),t.position.set(i[0],i[1],i[2]),t.material=this.cannonDefaultContactMaterial,t.updateMassProperties(),t.wakeUp(),t.collisionFilterGroup=n.colliGroup;const e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};t.collisionFilterMask=e[n.colliGroup],this.world.addBody(t),t.quaternion.set(i[3],i[4],i[5],i[6]),r.cannonBody=t}if(!1!==n.isVisualMode){var a=n.tiling;if(0!==i[3]){var l=this.quaternionToEuler({x:i[3],y:i[4],z:i[5],w:i[6]});n.rX=l.x,n.rY=l.y,n.rZ=l.z}"number"==typeof a&&(a=[a,a]);const e=n.isFictBody?.1:0;var c,d=!1;if("string"==typeof n.texture?void 0!==window[n.texture]||this.textureMap.has(n.texture)?c=this.textureMap.has(n.texture)?this.textureMap.get(n.texture):window[n.texture]:(c=null,d=!0):c=n.texture,this.W[n.shape]({n:"T"+t,w:o[1]-e,d:o[3]-e,h:o[2]-e,x:i[0],y:i[1],z:i[2],t:c,s:n.smooth,tile:a,rx:n.rX,ry:n.rY,rz:n.rZ,b:n.background,mix:n.mixValue,shadow:n.isShadow,hidden:n.isInvisible}),d){const i=40,r=(o[1]-e)*i,s=(o[2]-e)*i;this.loadTexture([{func:this.errorTexture,id:n.texture,type:"png",width:r,height:s,index:t}]).then(e=>{this.W[n.shape]({n:"T"+t,t:this.textureMap.get(n.texture),mix:n.mixValue})})}}},hiddenTABox:function(t){const e=this.indexToArgs.get(t);!1!==e.isPhysical&&void 0!==e.cannonBody&&this.world.removeBody(e.cannonBody),!1!==e.isVisualMode&&this.W.delete("T"+t)},addBox:function({DPZ:t=2,isPhysical:e=!0,isVisualMode:i=!0,kk:o=0,colliGroup:r=2,name:n="k"+this.bodyObjName++,X:s=5,Y:a=5,Z:l=5,quat:c=null,isShadow:d=0,tiling:u=[1,1],shape:h="cube",mass:m=0,width:p=1,depth:f=1,height:g=1,size:y=1,texture:v=null,smooth:x=0,background:w="#888",mixValue:b=.71,rX:M=0,rY:A=0,rZ:S=0}={}){var B=Array.from(arguments),_=this.calPosID(s,a,l,t);1!==y&&(p=f=g=y);var P=null;if(e){var k;if("sphere"===h)k=new CANNON.Sphere(p/2);else{const t=new CANNON.Vec3(p/2,g/2,f/2);k=new CANNON.Box(t)}(P=new CANNON.Body({mass:m,shape:k,position:new CANNON.Vec3(s,a,l),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=r;const t={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};P.collisionFilterMask=t[r],this.world.addBody(P),c&&P.quaternion.set(c.x,c.y,c.z,c.w),c=P.quaternion}i&&("number"==typeof u&&(u=[u,u]),this.W[h]({n,w:p,d:f,h:g,x:s,y:a,z:l,t:v,s:x,tile:u,rx:M,ry:A,rz:S,b:w,mix:b,shadow:d}));var L={name:n,body:P,X:s,Y:a,Z:l,rX:M,rY:A,rZ:S,isVisualMode:i,myargs:B,posID:_,DPZ:t,quat:c};switch(!0){case!1===e:this.bodylistNotPys.push(L);break;case 0===m:this.bodylistMass0.push(L);break;default:this.bodylist.push(L)}return L}},u={hooks:i,W:n,...o,...s,...a,...l,...c,...d,gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const i of this.currentlyActiveIndices){const o=8*i;if(this.positionsStatus[o+7]>0){const r=this.indexToArgs.get(i),n=r.cannonBody;if(!n)continue;const s=n.position.x-this.positionsStatus[o],a=n.position.y-this.positionsStatus[o+1],l=n.position.z-this.positionsStatus[o+2],c=Math.sqrt(s*s+a*a+l*l);if(this.positionsStatus[o]=n.position.x,this.positionsStatus[o+1]=n.position.y,this.positionsStatus[o+2]=n.position.z,this.positionsStatus[o+3]=n.quaternion.x,this.positionsStatus[o+4]=n.quaternion.y,this.positionsStatus[o+5]=n.quaternion.z,this.positionsStatus[o+6]=n.quaternion.w,!1!==r.isVisualMode&&this.W.next["T"+i]&&c>1e-4){const s=this.quaternionToEuler(n.quaternion);if(this.W.move({n:"T"+i,x:this.positionsStatus[o],y:this.positionsStatus[o+1],z:this.positionsStatus[o+2],rx:s.rX,ry:s.rY,rz:s.rZ}),c>.01&&performance.now()-this.gridKeyCurrentTime>500){const n=r.gridkey||0,s=this.physicsProps[o+4],a=`${s}_${Math.floor(this.positionsStatus[o]/this.gridsize[s])}_${Math.floor(this.positionsStatus[o+2]/this.gridsize[s])}`;if(n&&a!==n){var t=this.spatialGrid.get(n);if(t){const e=t.indexOf(i);e>-1&&(t.splice(e,1),this.spatialGrid.set(n,t))}var e=this.spatialGrid.get(a);e||(e=[]),e.push(i),this.spatialGrid.set(a,e)}r.gridkey=a,this.gridKeyCurrentTime=performance.now()}}}}},cannonAni:function(){this.world.step(1/60)},animate:function(){var t=this;const e=function(){t.cannonAni(),t.updataBodylist(),t.mainVPlayerMove(t.mainVPlayer),t.hooks.emit("animatePreFrame",t),requestAnimationFrame(e)};e()}};dynamicIns(u),window.openworld=u;const h=u;return e})());