!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.vista=e():t.vista=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>h});const i={_hookQueues:new Map,on(t,e,i=100){if("function"!=typeof e)throw new TypeError("Callback must be function");const o=this._hookQueues.get(t)||[];o.push({func:e,priority:i}),o._isSorted=!1,this._hookQueues.set(t,o)},off(t,e){const i=this._hookQueues.get(t);if(!i)return;const o=i.filter(t=>t.func!==e);0===o.length?this._hookQueues.delete(t):o.length<i.length&&(o._isSorted=!1,this._hookQueues.set(t,o))},_getSortedCallbacks(t){let e=this._hookQueues.get(t);return e?(e._isSorted||(e.sort((t,e)=>e.priority-t.priority),e._isSorted=!0),[...e]):[]},async emit(t,...e){const i=this._getSortedCallbacks(t).map(t=>t.func).map(async t=>{try{return await t(...e)}catch(t){throw t}});return Promise.allSettled(i)},emitSync(t,...e){const i=[];for(const{func:o}of this._getSortedCallbacks(t))try{const t=o(...e);if(i.push({status:"fulfilled",value:t}),!1===t)break}catch(t){i.push({status:"rejected",reason:t})}return i}},o={quaternionToEuler:function(t){const{x:e,y:i,z:o,w:n}=t,r=Math.atan2(2*(n*e+i*o),1-2*(e*e+i*i)),s=2*(n*i-o*e),a=Math.asin(Math.max(-1,Math.min(1,s))),l=Math.atan2(2*(n*o+e*i),1-2*(i*i+o*o)),c=t=>t*(180/Math.PI);return{rX:c(r),rY:c(a),rZ:c(l)}},eulerToQuaternion:function(t){const{rX:e,rY:i,rZ:o}=t,n=t=>t*(Math.PI/180),r=.5*n(e),s=.5*n(i),a=.5*n(o),l=Math.sin(r),c=Math.cos(r),d=Math.sin(s),u=Math.cos(s),h=Math.sin(a),m=Math.cos(a);return{x:l*u*m-c*d*h,y:c*d*m+l*u*h,z:c*u*h-l*d*m,w:c*u*m+l*d*h}},genPR:function(t,e){let i=Math.abs(t)||1;i=1664525*i+1013904223|0;const o=new Float32Array(e),n=1/4294967296;for(let t=0;t<e;t++)i^=i<<13,i^=i>>17,i^=i<<5,o[t]=(i>>>0)*n;return o},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})},n={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i,reset:t=>{var e;n.canvas=t,n.objs=0,n.current={},n.next={},n.textures={},n.viewLimit=5e3,n.gl=t.getContext("webgl2"),n.gl.blendFunc(770,771),n.gl.activeTexture(33984),n.program=n.gl.createProgram(),n.gl.enable(2884),n.instanceColorBuffers={},n.lastFrame=0,n.drawTime=0,n.lastReportTime=0,n.gl.shaderSource(e=n.gl.createShader(35633),"#version 300 es\n          precision lowp float;                        \n          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...\n          in mat4 instanceModelMatrix;                  // 实例化模型的 模型\n          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵\n          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]\n          out vec4 v_pos, v_col, v_uv, v_normal;\n          uniform bool isInstanced;              // 是不是实例化绘制\n          void main() {\n            mat4 currentModelMatrix;             // 当前的模型矩阵\n            if (isInstanced) {\n              currentModelMatrix = instanceModelMatrix;\n            } else {\n              currentModelMatrix = m;\n            }\n            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos\n              v_pos = bb.z > 0.                         \n              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌\n              : currentModelMatrix * pos               \n            );\n            v_col = col;\n            v_uv = uv;\n            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵\n          }"),n.gl.compileShader(e),n.gl.attachShader(n.program,e),n.gl.shaderSource(e=n.gl.createShader(35632),"#version 300 es\n          precision lowp float;\n          in vec4 v_pos, v_col, v_uv, v_normal;\n          uniform vec3 light;\n          uniform vec2 tiling;\n          uniform vec4 o;\n          uniform sampler2D sampler;\n          out vec4 c;\n          void main() {\n            vec2 final_uv = v_uv.xy;  //+ 新增纹理面修正逻辑，修复纹理面翻转问题\n            if (!gl_FrontFacing) {\n              final_uv.x = 1.0 - final_uv.x;\n            }\n            c = mix(texture(sampler, final_uv * tiling), v_col, o[3]);\n            if(o[1] > 0.){\n              c = vec4(\n                c.rgb * (max(0., dot(light, -normalize(\n                  o[0] > 0.\n                  ? vec3(v_normal.xyz)\n                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))\n                )))\n                + o[2]),\n                c.a\n              );\n            }\n          }"),n.gl.compileShader(e),n.gl.attachShader(n.program,e),n.gl.linkProgram(n.program),n.gl.useProgram(n.program),n.clearColor=t=>n.gl.clearColor(...n.col(t)),n.wjsHooks.emitSync("reset_ok",n),n.uniformLocations={pv:n.gl.getUniformLocation(n.program,"pv"),eye:n.gl.getUniformLocation(n.program,"eye"),m:n.gl.getUniformLocation(n.program,"m"),im:n.gl.getUniformLocation(n.program,"im"),bb:n.gl.getUniformLocation(n.program,"bb"),isInstanced:n.gl.getUniformLocation(n.program,"isInstanced"),o:n.gl.getUniformLocation(n.program,"o"),light:n.gl.getUniformLocation(n.program,"light"),tiling:n.gl.getUniformLocation(n.program,"tiling"),sampler:n.gl.getUniformLocation(n.program,"sampler"),u_MvpMatrixFromLight:n.gl.getUniformLocation(n.program,"u_MvpMatrixFromLight"),u_ShadowMap:n.gl.getUniformLocation(n.program,"u_ShadowMap")},n.attribLocations={pos:n.gl.getAttribLocation(n.program,"pos"),col:n.gl.getAttribLocation(n.program,"col"),uv:n.gl.getAttribLocation(n.program,"uv"),normal:n.gl.getAttribLocation(n.program,"normal"),instanceModelMatrix:n.gl.getAttribLocation(n.program,"instanceModelMatrix")},n.clearColor("fff"),n.gl.enable(2929),n.light({y:-1}),n.camera({fov:30}),setTimeout(n.draw,16)},setState:(t,e,i,o,r=[],s,a,l,c,d,u,h,m)=>{if(t.n||="o"+n.objs++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!n.textures[t.t.id]&&(i=n.gl.createTexture(),n.gl.pixelStorei(37441,!1),n.gl.bindTexture(3553,i),n.gl.pixelStorei(37440,1),n.gl.texImage2D(3553,0,6408,6408,5121,t.t),n.gl.generateMipmap(3553),n.textures[t.t.id]=i),t.instances&&Array.isArray(t.instances)){t.isInstanced=!0,t.numInstances=t.instances.length;const e=[],i=[];for(const i of t.instances){const o=new DOMMatrix;o.translateSelf((i.x||0)+(t.x||0),(i.y||0)+(t.y||0),(i.z||0)+(t.z||0)).rotateSelf(i.rx||0,i.ry||0,i.rz||0).scaleSelf(i.w||1,i.h||1,i.d||1),e.push(...o.toFloat32Array())}for(const e of t.instances)i.push(...n.col(e.b||"888"));const o=new Float32Array(e),r=n.gl.createBuffer();n.gl.bindBuffer(n.gl.ARRAY_BUFFER,r),n.gl.bufferData(n.gl.ARRAY_BUFFER,o,n.gl.DYNAMIC_DRAW),n.instanceMatrixBuffers[t.n]=r,n.gl.bindBuffer(n.gl.ARRAY_BUFFER,n.instanceColorBuffers[t.n]=n.gl.createBuffer()),n.gl.bufferData(n.gl.ARRAY_BUFFER,new Float32Array(i),n.gl.DYNAMIC_DRAW)}else t.isInstanced=!1;if(t.fov){var p=n.viewLimit;n.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(n.canvas.width/n.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-(p+.1)/(p-.1),-1,0,0,-2*p*.1/(p-.1),0])}t={type:e,...n.current[t.n]=n.next[t.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0,hidden:!1,uncullface:0,smooth:0,t:t.t,texture:i,normal:r,A:s,B:a,C:l,Ai:c,Bi:d,Ci:u,AB:h,BC:m,...t},...t,f:0},n.models[t.type]?.vertices&&!n.models?.[t.type].verticesBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].verticesBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].vertices),35044),!n.models[t.type].normals&&n.smooth&&n.smooth(t),n.models[t.type].normals&&(n.gl.bindBuffer(34962,n.models[t.type].normalsBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].normals.flat()),35044))),n.models[t.type]?.uv&&!n.models[t.type].uvBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].uvBuffer=n.gl.createBuffer()),n.gl.bufferData(34962,new Float32Array(n.models[t.type].uv),35044)),n.models[t.type]?.indices&&!n.models[t.type].indicesBuffer&&(n.gl.bindBuffer(34963,n.models[t.type].indicesBuffer=n.gl.createBuffer()),n.gl.bufferData(34963,new Uint16Array(n.models[t.type].indices),35044)),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,n.next[t.n]=t},draw:(t,e,i,o,r=[])=>{const s=performance.now();if(e=t-n.lastFrame,n.lastFrame=t,requestAnimationFrame(n.draw),n.debugFBO)renderFBOToCanvas();else{for(o in n.next.camera.g&&n.render(n.next[n.next.camera.g],e,1),i=n.animation("camera"),n.next?.camera?.g&&i.preMultiplySelf(n.next[n.next.camera.g].M||n.next[n.next.camera.g].m),n.gl.uniformMatrix4fv(n.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(n.projection),n.gl.uniformMatrix4fv(n.uniformLocations.pv,!1,i.toFloat32Array()),n.wjsHooks.emitSync("shadow_draw",n),n.gl.clear(16640),n.next){const t=n.next[o];!0!==t.hidden&&(t.isInstanced||t.t||1!=n.col(t.b)[3]?r.push(t):n.render(t,e))}for(o of(r.sort((t,e)=>n.dist(e)-n.dist(t)),n.gl.enable(3042),n.gl.depthMask(1),r))o.isInstanced&&n.render(o,e);for(o of r)o.isInstanced||n.render(o,e);n.gl.depthMask(1),n.gl.disable(3042),n.gl.uniform3f(n.uniformLocations.light,n.lerp("light","x"),n.lerp("light","y"),n.lerp("light","z")),t-n.lastReportTime>=1e3&&(n.drawTime=(performance.now()-s).toFixed(2)+"ms",n.lastReportTime=t)}},render:(t,e,i=["camera","light","group"].includes(t.type),o)=>{if(t.t&&(n.gl.activeTexture(n.gl.TEXTURE0),n.gl.bindTexture(3553,n.textures[t.t.id]),n.gl.uniform1i(n.uniformLocations.sampler,0),n.gl.uniform2f(n.uniformLocations.tiling,t.tile?.[0]||1,t.tile?.[1]||1)),t.isInstanced||(t.f<t.a&&(t.f+=e),t.f>t.a&&(t.f=t.a),n.next[t.n].m=n.animation(t.n),n.next[t.g]&&n.next[t.n].m.preMultiplySelf(n.next[t.g].M||n.next[t.g].m),i||(n.gl.uniformMatrix4fv(n.uniformLocations.m,!1,(n.next[t.n].M||n.next[t.n].m).toFloat32Array()),n.gl.uniformMatrix4fv(n.uniformLocations.im,!1,new DOMMatrix(n.next[t.n].M||n.next[t.n].m).invertSelf().toFloat32Array()))),!i){if(!n.models[t.type]?.verticesBuffer)return 0;if(n.gl.bindBuffer(34962,n.models[t.type].verticesBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.pos,3,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0),n.models[t.type].uvBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].uvBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.uv,2,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0)),(t.s||n.models[t.type].customNormals)&&n.models[t.type].normalsBuffer&&(n.gl.bindBuffer(34962,n.models[t.type].normalsBuffer),n.gl.vertexAttribPointer(o=n.attribLocations.normal,3,5126,!1,0,0),n.gl.enableVertexAttribArray(o),n.gl.vertexAttribDivisor(o,0)),n.gl.uniform1i(n.uniformLocations.isInstanced,t.isInstanced?1:0),t.isInstanced&&n.instanceMatrixBuffers[t.n]){const e=n.instanceMatrixBuffers[t.n];n.gl.bindBuffer(n.gl.ARRAY_BUFFER,e);const i=n.attribLocations.instanceModelMatrix,o=16*Float32Array.BYTES_PER_ELEMENT;for(let t=0;t<4;++t){const e=i+t;n.gl.enableVertexAttribArray(e),n.gl.vertexAttribPointer(e,4,n.gl.FLOAT,!1,o,4*t*Float32Array.BYTES_PER_ELEMENT),n.gl.vertexAttribDivisor(e,1)}}n.gl.uniform4f(n.uniformLocations.o,t.s,(t.mode>3||n.gl[t.mode]>3)&&!t.ns?1:0,n.ambientLight||.2,t.mix),n.gl.uniform4f(n.uniformLocations.bb,t.w,t.h,"billboard"==t.type,0);const e=n.attribLocations.col;if(t.isInstanced?(n.gl.enableVertexAttribArray(e),n.gl.bindBuffer(n.gl.ARRAY_BUFFER,n.instanceColorBuffers[t.n]),n.gl.vertexAttribPointer(e,4,n.gl.FLOAT,!1,0,0),n.gl.vertexAttribDivisor(e,1)):n.gl.vertexAttrib4fv(e,n.col(t.b||"888")),t.uncullface?(n.gl.disable(2884),n.cullface=!1):!0!==n.cullface&&(n.gl.enable(2884),n.cullface=!0),n.models[t.type].indicesBuffer?(n.gl.bindBuffer(34963,n.models[t.type].indicesBuffer),t.isInstanced?n.gl.drawElementsInstanced(+t.mode||n.gl[t.mode],n.models[t.type].indices.length,n.gl.UNSIGNED_SHORT,0,t.numInstances):n.gl.drawElements(+t.mode||n.gl[t.mode],n.models[t.type].indices.length,5123,0)):t.isInstanced?n.gl.drawArraysInstanced(+t.mode||n.gl[t.mode],0,n.models[t.type].vertices.length/3,t.numInstances):n.gl.drawArrays(+t.mode||n.gl[t.mode],0,n.models[t.type].vertices.length/3),t.isInstanced){const t=n.attribLocations.instanceModelMatrix;for(let e=0;e<4;++e)n.gl.vertexAttribDivisor(t+e,0),n.gl.disableVertexAttribArray(t+e);n.gl.vertexAttribDivisor(e,0),n.gl.disableVertexAttribArray(e)}}},lerp:(t,e)=>n.next[t]?.a?n.current[t][e]+(n.next[t][e]-n.current[t][e])*(n.next[t].f/n.next[t].a):n.next[t][e],animation:(t,e=new DOMMatrix)=>n.next[t]?e.translateSelf(n.lerp(t,"x"),n.lerp(t,"y"),n.lerp(t,"z")).rotateSelf(n.lerp(t,"rx"),n.lerp(t,"ry"),n.lerp(t,"rz")).scaleSelf(n.lerp(t,"w"),n.lerp(t,"h"),n.lerp(t,"d")):e,dist:(t,e=n.next.camera)=>t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0,ambient:t=>n.ambientLight=t,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map(e=>("0x"+e)/(t.length<5?15:255)),1],add:(t,e)=>{n.models[t]=e,e.normals&&(n.models[t].customNormals=1),n[t]=e=>n.setState(e,t)},resetView:(t=1)=>{n.gl.viewport(0,0,n.gl.canvas.width*t,n.gl.canvas.height*t),n.setState({n:"camera",fov:n.next.camera.fov})},group:t=>n.setState(t,"group"),move:(t,e)=>setTimeout(()=>{n.setState(t)},e||1),delete:(t,e)=>setTimeout(()=>{delete n.next[t]},e||1),camera:(t,e)=>setTimeout(()=>{n.setState(t,t.n="camera")},e||1),light:(t,e)=>e?setTimeout(()=>{n.setState(t,t.n="light")},e):n.setState(t,t.n="light"),cullface:!0,smooth:(t,e={},i=[],o,r,s,a,l,c,d,u,h,m,p)=>{for(n.models[t.type].normals=[],s=0;s<n.models[t.type].vertices.length;s+=3)i.push(n.models[t.type].vertices.slice(s,s+3));for((o=n.models[t.type].indices)?r=1:(o=i,r=0),s=0;s<2*o.length;s+=3){a=s%o.length,l=i[u=r?n.models[t.type].indices[a]:a],c=i[h=r?n.models[t.type].indices[a+1]:a+1],d=i[m=r?n.models[t.type].indices[a+2]:a+2];var f=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],g=[d[0]-c[0],d[1]-c[1],d[2]-c[2]];p=s>a?[0,0,0]:[f[1]*g[2]-f[2]*g[1],f[2]*g[0]-f[0]*g[2],f[0]*g[1]-f[1]*g[0]],e[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],e[c[0]+"_"+c[1]+"_"+c[2]]||=[0,0,0],e[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],n.models[t.type].normals[u]=e[l[0]+"_"+l[1]+"_"+l[2]]=e[l[0]+"_"+l[1]+"_"+l[2]].map((t,e)=>t+p[e]),n.models[t.type].normals[h]=e[c[0]+"_"+c[1]+"_"+c[2]]=e[c[0]+"_"+c[1]+"_"+c[2]].map((t,e)=>t+p[e]),n.models[t.type].normals[m]=e[d[0]+"_"+d[1]+"_"+d[2]]=e[d[0]+"_"+d[1]+"_"+d[2]].map((t,e)=>t+p[e])}}};n.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),n.add("billboard",n.models.plane),n.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),n.cube=t=>n.setState(t,"cube"),n.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]}),((t,e,i,o,r,s,a=[],l=[],c=[],d=20)=>{for(i=0;i<=d;i++)for(o=i*Math.PI/d,t=0;t<=d;t++)e=2*t*Math.PI/d,a.push(+(Math.sin(e)*Math.sin(o)/2).toFixed(6),+(Math.cos(o)/2).toFixed(6),+(Math.cos(e)*Math.sin(o)/2).toFixed(6)),c.push(3.5*Math.sin(t/d),-Math.sin(i/d)),t<d&&i<d&&l.push(r=i*(d+1)+t,s=r+(d+1),r+1,r+1,s,s+1);n.add("sphere",{vertices:a,uv:c,indices:l})})();const r=n,s={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",displayViewTime:.9,world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(t){this.canvas=window.document.getElementById(t),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate()},initW:function(t){const e=this.W;t.width=window.innerWidth*this.displayViewTime,t.height=window.innerHeight*this.displayViewTime,e.reset(t),e.ambient(.7),e.light({x:.5,y:-.3,z:.5}),e.clearColor(this.colorClear),e.camera({n:"camera",fov:this.fov}),e.group({n:"posZero",x:0,y:1,z:0}),e.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),e.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),e.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),e.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),e.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),e.pyramid({g:"posZero",size:1,z:10,rx:90,b:"44f"}),e.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}},a={textureMap:new Map,loadTextureIndex:1,rasterizeCanvas:document.createElement("canvas"),loadTexture:function(t){const e=[];for(var i=0;i<t.length;i++){const o=t[i];if(!0===this.textureMap.has(o.id)){e.push(Promise.resolve(this.textureMap.get(o.id)));continue}const n=new Promise(t=>{if("svg-rasterize"===o.type){const e=new Image;e.onload=()=>{const i=this.rasterizeCanvas;i.width=o.width||400,i.height=o.height||400;const n=i.getContext("2d");n.clearRect(0,0,i.width,i.height),n.drawImage(e,0,0,i.width,i.height);const r=i.toDataURL("image/png"),s=new Image;s.onload=()=>{this.textureMap.set(o.id,s),t(s)},s.id=o.id,s.src=r};const i=new Blob([o.svgCode],{type:"image/svg+xml"});e.src=URL.createObjectURL(i)}else{const e=new Image;e.onload=()=>{this.textureMap.set(o.id,e),this.loadTextureIndex++,t(e)},e.id=o.id+"-"+this.loadTextureIndex,e.src=this.dToBase64(o)}});e.push(n)}return Promise.all(e)},canvasObj:document.createElement("canvas"),dToBase64:function(t){if("svg"===t.type){const e=t.svgCode.replace(/#/g,"%23");return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)}const e=this.canvasObj;e.width=t.width||400,e.height=t.height||400,e.style.webkitFontSmoothing="antialiased",e.style.mozOsxFontSmoothing="grayscale";const i=e.getContext("2d");if("png"===t.type)return t.func(i,e.width,e.height,t,this),e.toDataURL("image/png");if("jpg"===t.type){i.fillStyle="white",i.fillRect(0,0,e.width,e.height),t.func(i,e.width,e.height,t,this);var o=t.quality||.7;return e.toDataURL("image/jpeg",o)}},errorTexture:function(t,e,i,o,n){n.hooks.emitSync("errorTexture_diy",t,e,i,o,n)}},l={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var t=this,e=!1;document.addEventListener("keydown",function(e){t._handleKey(e,1)}),document.addEventListener("keyup",function(e){t._handleKey(e,0)}),document.addEventListener("mousemove",function(i){e&&(t.keys.turnRight-=.1*i.movementX,t.keys.turnUp-=.1*i.movementY)}),this.canvas.addEventListener("click",i=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),e=!0,document.pointerLockElement&&t.hooks.emitSync("pointer_lock_click",t,i)}),this.lockChangeAlert=function(){e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()})},_handleKey:function(t,e){if(this.isPointerLock()){var i=this.keyMap[t.key.toLowerCase()];i&&(this.keys[i]=e),32!==t.keyCode&&"e"!==t.key.toLowerCase()||null===this.mainVPlayer||(0===this.keys.jumping&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=e),16!==t.keyCode&&"q"!==t.key.toLowerCase()||(this.isShiftPress=e)}},forwardAcc:0,displayPOS:function(){var t=document.getElementById("posInfo");if(!t)return 0;null!==this.mainVPlayer&&(t.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(t,e,i,o,n,r){const s=this.keys;if(s.viewForward||s.viewBackward){var a=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01);this.hooks.emit("forwardBackward",this,a),i+=(-s.viewForward+s.viewBackward)*Math.cos(n*Math.PI/180)/a,t+=(-s.viewForward+s.viewBackward)*Math.sin(n*Math.PI/180)/a,this.displayPOS()}return(s.viewLeft||s.viewRight)&&(i+=(-s.viewLeft+s.viewRight)*Math.cos((n+90)*Math.PI/180)/10,t+=(-s.viewLeft+s.viewRight)*Math.sin((n+90)*Math.PI/180)/10,this.displayPOS()),n=this.keys.turnRight,{x:t,y:e,z:i,rx:this.keys.turnUp,ry:n,rz:r}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(t){if(null===t)return;const e=this.mainCamera;!1===this.isMVPInit&&(e.groupName=t.name,this.isMVPInit=!0);const i=t.body.position,o=t.body.quaternion,n=this.calMovePara(i.x,i.y,i.z,e.qua.rx,e.qua.ry,e.qua.rz);t.body.position.x=n.x,t.body.position.y=n.y,t.body.position.z=n.z,e.qua=n,o.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*n.ry),this.W.camera({g:t.name,x:e.pos.x,y:e.pos.y,z:e.pos.z,rx:e.qua.rx,rz:e.qua.rz});const r=t.body.position,s=t.body.quaternion,a=this.quaternionToEuler(s);return t.quat=s,t.rX=a.rX,t.rY=a.rY,t.rZ=a.rZ,t.X=r.x,t.Y=r.y,t.Z=r.z,this.W.move({n:t.name,x:t.X,y:t.Y,z:t.Z,rx:t.rX,ry:t.rY,rz:t.rZ}),t.posID=this.calPosID(t.X,t.Y,t.Z,2),0}},c={calPosID:function(t,e,i,o){const n={2:100,3:100,4:40}[o]||0;if(2===o&&(o=""),0===n)return 0;var r=-1===Math.sign(t)?"X":"D",s=-1===Math.sign(i)?"B":"N";return o+r+Math.ceil(t/n*Math.sign(t))+s+Math.ceil(i/n*Math.sign(i))},gridsize:new Uint16Array([1e4,1e3,100,20,5]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";const t=this.mainVPlayer,e=[];for(let i=0;i<this.gridsize.length;i++){const o=Math.floor(t.X/this.gridsize[i]),n=Math.floor(t.Z/this.gridsize[i]);for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++)e.push(`${i}_${o+t}_${n+r}`)}const i=new Set,o=new Set(this.currentlyActiveIndices);for(const o of e){const e=this.spatialGrid.get(o);if(e)for(const o of e)Math.abs(this.positionsStatus[8*o+1]-t.Y)<this.gridsize[this.physicsProps[8*o+4]]&&i.add(o)}for(const t of i)o.delete(t);for(const t of i)if(!this.currentlyActiveIndices.has(t)){const e=8*t;this.positionsStatus[e+7]=this.physicsProps[e],this.activeTABox(t)}for(const t of o){const e=8*t;this.positionsStatus[e+7]=-1,this.hiddenTABox(t)}this.currentlyActiveIndices=i,this.activationQueue.length>0&&!this.isActivationScheduled&&(this.isActivationScheduled=!0)}},d={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(t=1e6){this.positionsStatus=new Float32Array(8*t),this.physicsProps=new Float32Array(8*t),this.freeSlots=new Array(t).fill(0).map((e,i)=>t-1-i)},addTABox:function({DPZ:t=3,X:e=5,Y:i=5,Z:o=5,quat:n={x:0,y:0,z:0,w:1},mass:r=0,width:s=1,depth:a=1,height:l=1,size:c=1,rX:d=0,rY:u=0,rZ:h=0}={}){const m=Array.from(arguments)[0];if(1!==c&&(s=a=l=c),(d||u||h)&&(n=this.eulerToQuaternion({rX:d,rY:u,rZ:h})),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;const p=this.freeSlots.pop(),f=8*p;this.positionsStatus[f]=e,this.positionsStatus[f+1]=i,this.positionsStatus[f+2]=o,this.positionsStatus[f+3]=n.x,this.positionsStatus[f+4]=n.y,this.positionsStatus[f+5]=n.z,this.positionsStatus[f+6]=n.w,this.positionsStatus[f+7]=r,this.physicsProps[f]=r,this.physicsProps[f+1]=s,this.physicsProps[f+2]=l,this.physicsProps[f+3]=a,this.physicsProps[f+4]=t;const g=`${t}_${Math.floor(e/this.gridsize[t])}_${Math.floor(o/this.gridsize[t])}`;let y=this.spatialGrid.get(g);y||(y=[]),y.push(p),this.spatialGrid.set(g,y),this.indexToArgs.set(p,m)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1,isInvisible:!1},argsObj:{},activeTABox:function(t){const e=8*t,i=this.positionsStatus.subarray(e,e+8),o=this.physicsProps.subarray(e,e+4),n=this.indexToArgs.get(t);this.argsObj={...this.defaultBoxArgs,...n};const r=this.argsObj;if(r.isPhysical){const t=new CANNON.Body;var s;if(t.mass=o[0],t.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,"sphere"===r.shape)s=new CANNON.Sphere(o[1]/2);else{const t=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2);s=new CANNON.Box(t)}t.addShape(s),t.position.set(i[0],i[1],i[2]),t.material=this.cannonDefaultContactMaterial,t.updateMassProperties(),t.wakeUp(),t.collisionFilterGroup=r.colliGroup;const e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};t.collisionFilterMask=e[r.colliGroup],this.world.addBody(t),t.quaternion.set(i[3],i[4],i[5],i[6]),n.cannonBody=t}if(!1!==r.isVisualMode){var a=r.tiling;if(0!==i[3]){var l=this.quaternionToEuler({x:i[3],y:i[4],z:i[5],w:i[6]});r.rX=l.x,r.rY=l.y,r.rZ=l.z}"number"==typeof a&&(a=[a,a]);const e=r.isFictBody?.1:0;var c,d=!1;if("string"==typeof r.texture?void 0!==window[r.texture]||this.textureMap.has(r.texture)?c=this.textureMap.has(r.texture)?this.textureMap.get(r.texture):window[r.texture]:(c=null,d=!0):c=r.texture,this.W[r.shape]({n:"T"+t,w:o[1]-e,d:o[3]-e,h:o[2]-e,x:i[0],y:i[1],z:i[2],t:c,s:r.smooth,tile:a,rx:r.rX,ry:r.rY,rz:r.rZ,b:r.background,mix:r.mixValue,shadow:r.isShadow,hidden:r.isInvisible}),d){const i=40,n=(o[1]-e)*i,s=(o[2]-e)*i;this.loadTexture([{func:this.errorTexture,id:r.texture,type:"png",width:n,height:s,index:t}]).then(e=>{this.W[r.shape]({n:"T"+t,t:this.textureMap.get(r.texture),mix:r.mixValue})})}}},hiddenTABox:function(t){const e=this.indexToArgs.get(t);!1!==e.isPhysical&&void 0!==e.cannonBody&&this.world.removeBody(e.cannonBody),!1!==e.isVisualMode&&this.W.delete("T"+t)},addBox:function({DPZ:t=2,isPhysical:e=!0,isVisualMode:i=!0,kk:o=0,colliGroup:n=2,name:r="k"+this.bodyObjName++,X:s=5,Y:a=5,Z:l=5,quat:c=null,isShadow:d=0,tiling:u=[1,1],shape:h="cube",mass:m=0,width:p=1,depth:f=1,height:g=1,size:y=1,texture:v=null,smooth:x=0,background:w="#888",mixValue:b=.71,rX:M=0,rY:A=0,rZ:S=0}={}){var B=Array.from(arguments),_=this.calPosID(s,a,l,t);1!==y&&(p=f=g=y);var P=null;if(e){var k;if("sphere"===h)k=new CANNON.Sphere(p/2);else{const t=new CANNON.Vec3(p/2,g/2,f/2);k=new CANNON.Box(t)}(P=new CANNON.Body({mass:m,shape:k,position:new CANNON.Vec3(s,a,l),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=n;const t={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};P.collisionFilterMask=t[n],this.world.addBody(P),c&&P.quaternion.set(c.x,c.y,c.z,c.w),c=P.quaternion}i&&("number"==typeof u&&(u=[u,u]),this.W[h]({n:r,w:p,d:f,h:g,x:s,y:a,z:l,t:v,s:x,tile:u,rx:M,ry:A,rz:S,b:w,mix:b,shadow:d}));var L={name:r,body:P,X:s,Y:a,Z:l,rX:M,rY:A,rZ:S,isVisualMode:i,myargs:B,posID:_,DPZ:t,quat:c};switch(!0){case!1===e:this.bodylistNotPys.push(L);break;case 0===m:this.bodylistMass0.push(L);break;default:this.bodylist.push(L)}return L}},u={hooks:i,W:r,...o,...s,...a,...l,...c,...d,gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const i of this.currentlyActiveIndices){const o=8*i;if(this.positionsStatus[o+7]>0){const n=this.indexToArgs.get(i),r=n.cannonBody;if(!r)continue;const s=r.position.x-this.positionsStatus[o],a=r.position.y-this.positionsStatus[o+1],l=r.position.z-this.positionsStatus[o+2],c=Math.sqrt(s*s+a*a+l*l);if(this.positionsStatus[o]=r.position.x,this.positionsStatus[o+1]=r.position.y,this.positionsStatus[o+2]=r.position.z,this.positionsStatus[o+3]=r.quaternion.x,this.positionsStatus[o+4]=r.quaternion.y,this.positionsStatus[o+5]=r.quaternion.z,this.positionsStatus[o+6]=r.quaternion.w,!1!==n.isVisualMode&&this.W.next["T"+i]&&c>1e-4){const s=this.quaternionToEuler(r.quaternion);if(this.W.move({n:"T"+i,x:this.positionsStatus[o],y:this.positionsStatus[o+1],z:this.positionsStatus[o+2],rx:s.rX,ry:s.rY,rz:s.rZ}),c>.01&&performance.now()-this.gridKeyCurrentTime>500){const r=n.gridkey||0,s=this.physicsProps[o+4],a=`${s}_${Math.floor(this.positionsStatus[o]/this.gridsize[s])}_${Math.floor(this.positionsStatus[o+2]/this.gridsize[s])}`;if(r&&a!==r){var t=this.spatialGrid.get(r);if(t){const e=t.indexOf(i);e>-1&&(t.splice(e,1),this.spatialGrid.set(r,t))}var e=this.spatialGrid.get(a);e||(e=[]),e.push(i),this.spatialGrid.set(a,e)}n.gridkey=a,this.gridKeyCurrentTime=performance.now()}}}}},cannonAni:function(){this.world.step(1/60)},animate:function(){var t=this;const e=function(){t.cannonAni(),t.updataBodylist(),t.mainVPlayerMove(t.mainVPlayer),t.hooks.emit("animatePreFrame",t),requestAnimationFrame(e)};e()}};!function(t){const e=t.W;e.dynimicIns=!0,e.updateInstance=function(t,i,o){const n=e.next[t];if(!n?.isInstanced||!n.instances?.[i])return;const r=n.instances[i];Object.assign(r,o);const s=new DOMMatrix;s.translateSelf((r.x||0)+(n.x||0),(r.y||0)+(n.y||0),(r.z||0)+(n.z||0)).rotateSelf(r.rx||0,r.ry||0,r.rz||0).scaleSelf(r.w||1,r.h||1,r.d||1);const a=e.instanceMatrixBuffers[t];if(e.gl.bindBuffer(e.gl.ARRAY_BUFFER,a),e.gl.bufferSubData(e.gl.ARRAY_BUFFER,16*i*4,s.toFloat32Array()),o.b){const n=e.instanceColorBuffers[t];e.gl.bindBuffer(e.gl.ARRAY_BUFFER,n),e.gl.bufferSubData(e.gl.ARRAY_BUFFER,4*i*4,new Float32Array(e.col(o.b)))}},e.deleteInstance=function(t,i){e.updateInstance(t,i,{w:.001,h:.001,d:.001})}}(u),window.openworld=u;const h=u;return e})());