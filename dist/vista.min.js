!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.vista=e():t.vista=e()}(this,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>u});const i={_hookQueues:new Map,on(t,e,i=100){if("function"!=typeof e)throw new TypeError("Callback must be function");const o=this._hookQueues.get(t)||[];o.push({func:e,priority:i}),o._isSorted=!1,this._hookQueues.set(t,o)},off(t,e){const i=this._hookQueues.get(t);if(!i)return;const o=i.filter((t=>t.func!==e));0===o.length?this._hookQueues.delete(t):o.length<i.length&&(o._isSorted=!1,this._hookQueues.set(t,o))},_getSortedCallbacks(t){let e=this._hookQueues.get(t);return e?(e._isSorted||(e.sort(((t,e)=>e.priority-t.priority)),e._isSorted=!0),[...e]):[]},async emit(t,...e){const i=this._getSortedCallbacks(t).map((t=>t.func)).map((async t=>{try{return await t(...e)}catch(t){throw t}}));return Promise.allSettled(i)},emitSync(t,...e){const i=[];for(const{func:o}of this._getSortedCallbacks(t))try{const t=o(...e);if(i.push({status:"fulfilled",value:t}),!1===t)break}catch(t){i.push({status:"rejected",reason:t})}return i}},o={quaternionToEuler:function(t){const{x:e,y:i,z:o,w:s}=t,r=Math.atan2(2*(s*e+i*o),1-2*(e*e+i*i)),n=2*(s*i-o*e),a=Math.asin(Math.max(-1,Math.min(1,n))),l=Math.atan2(2*(s*o+e*i),1-2*(i*i+o*o)),c=t=>t*(180/Math.PI);return{rX:c(r),rY:c(a),rZ:c(l)}},genPR:function(t,e){let i=Math.abs(t)||1;i=1664525*i+1013904223|0;const o=new Float32Array(e),s=1/4294967296;for(let t=0;t<e;t++)i^=i<<13,i^=i>>17,i^=i<<5,o[t]=(i>>>0)*s;return o},cannonDefaultCantactMaterial:new CANNON.ContactMaterial(new CANNON.Material,new CANNON.Material,{friction:.1,restitution:0})},s={models:{},instanceMatrixBuffers:{},instanceColorBuffers:{},wjsHooks:i,reset:t=>{var e;s.canvas=t,s.objs=0,s.current={},s.next={},s.textures={},s.viewLimit=5e3,s.gl=t.getContext("webgl2"),s.gl.blendFunc(770,771),s.gl.activeTexture(33984),s.program=s.gl.createProgram(),s.gl.enable(2884),s.instanceColorBuffers={},s.lastFrame=0,s.drawTime=0,s.lastReportTime=0,s.gl.shaderSource(e=s.gl.createShader(35633),"#version 300 es\n          precision lowp float;                        \n          in vec4 pos, col, uv, normal;                 // 普通模型的 位置、颜色、纹理坐标、法线...\n          in mat4 instanceModelMatrix;                  // 实例化模型的 模型\n          uniform mat4 pv, eye, m, im;                  // 矩阵：投影 * 视图、视线、模型、模型逆矩阵\n          uniform vec4 bb;                              // 广告牌：bb = [w, h, 1.0, 0.0]\n          out vec4 v_pos, v_col, v_uv, v_normal;\n          uniform bool isInstanced;              // 是不是实例化绘制\n          void main() {\n            mat4 currentModelMatrix;             // 当前的模型矩阵\n            if (isInstanced) {\n              currentModelMatrix = instanceModelMatrix;\n            } else {\n              currentModelMatrix = m;\n            }\n            gl_Position = pv * (                        // 设置顶点位置：p * v * v_pos\n              v_pos = bb.z > 0.                         \n              ? currentModelMatrix[3] + eye * (pos * bb) // 广告牌\n              : currentModelMatrix * pos               \n            );\n            v_col = col;\n            v_uv = uv;\n            v_normal = transpose(isInstanced ? inverse(currentModelMatrix) : im) * normal;  // 必要时使用实例矩阵\n          }"),s.gl.compileShader(e),s.gl.attachShader(s.program,e),s.gl.shaderSource(e=s.gl.createShader(35632),"#version 300 es\n          precision lowp float;\n          in vec4 v_pos, v_col, v_uv, v_normal;\n          uniform vec3 light;\n          uniform vec2 tiling;\n          uniform vec4 o;\n          uniform sampler2D sampler;\n          out vec4 c;\n          void main() {\n            c = mix(texture(sampler, v_uv.xy * tiling), v_col, o[3]);\n            if(o[1] > 0.){\n              c = vec4(\n                c.rgb * (max(0., dot(light, -normalize(\n                  o[0] > 0.\n                  ? vec3(v_normal.xyz)\n                  : cross(dFdx(v_pos.xyz), dFdy(v_pos.xyz))\n                )))\n                + o[2]),\n                c.a\n              );\n            }\n          }"),s.gl.compileShader(e),s.gl.attachShader(s.program,e),s.gl.linkProgram(s.program),s.gl.useProgram(s.program),s.clearColor=t=>s.gl.clearColor(...s.col(t)),s.wjsHooks.emitSync("reset_ok",s),s.uniformLocations={pv:s.gl.getUniformLocation(s.program,"pv"),eye:s.gl.getUniformLocation(s.program,"eye"),m:s.gl.getUniformLocation(s.program,"m"),im:s.gl.getUniformLocation(s.program,"im"),bb:s.gl.getUniformLocation(s.program,"bb"),isInstanced:s.gl.getUniformLocation(s.program,"isInstanced"),o:s.gl.getUniformLocation(s.program,"o"),light:s.gl.getUniformLocation(s.program,"light"),tiling:s.gl.getUniformLocation(s.program,"tiling"),sampler:s.gl.getUniformLocation(s.program,"sampler"),u_MvpMatrixFromLight:s.gl.getUniformLocation(s.program,"u_MvpMatrixFromLight"),u_ShadowMap:s.gl.getUniformLocation(s.program,"u_ShadowMap")},s.attribLocations={pos:s.gl.getAttribLocation(s.program,"pos"),col:s.gl.getAttribLocation(s.program,"col"),uv:s.gl.getAttribLocation(s.program,"uv"),normal:s.gl.getAttribLocation(s.program,"normal"),instanceModelMatrix:s.gl.getAttribLocation(s.program,"instanceModelMatrix")},s.clearColor("fff"),s.gl.enable(2929),s.light({y:-1}),s.camera({fov:30}),setTimeout(s.draw,16)},setState:(t,e,i,o,r=[],n,a,l,c,d,h,u,m)=>{if(t.n||="o"+s.objs++,t.size&&(t.w=t.h=t.d=t.size),t.t&&t.t.width&&!s.textures[t.t.id]&&(i=s.gl.createTexture(),s.gl.pixelStorei(37441,!0),s.gl.bindTexture(3553,i),s.gl.pixelStorei(37440,1),s.gl.texImage2D(3553,0,6408,6408,5121,t.t),s.gl.generateMipmap(3553),s.textures[t.t.id]=i),t.instances&&Array.isArray(t.instances)){t.isInstanced=!0,t.numInstances=t.instances.length;const e=[],i=[];for(const i of t.instances){const o=new DOMMatrix;o.translateSelf(i.x+(0|t.x)|0,i.y+(0|t.y)|0,i.z+(0|t.z)|0).rotateSelf(i.rx||0,i.ry||0,i.rz||0).scaleSelf(i.w||1,i.h||1,i.d||1),e.push(...o.toFloat32Array())}for(const e of t.instances)i.push(...s.col(e.b||"888"));const o=new Float32Array(e),r=s.gl.createBuffer();s.gl.bindBuffer(s.gl.ARRAY_BUFFER,r),s.gl.bufferData(s.gl.ARRAY_BUFFER,o,s.gl.STATIC_DRAW),s.instanceMatrixBuffers[t.n]=r,s.gl.bindBuffer(s.gl.ARRAY_BUFFER,s.instanceColorBuffers[t.n]=s.gl.createBuffer()),s.gl.bufferData(s.gl.ARRAY_BUFFER,new Float32Array(i),s.gl.STATIC_DRAW),t.instances=null}else t.isInstanced=!1;if(t.fov){var p=s.viewLimit;s.projection=new DOMMatrix([1/Math.tan(t.fov*Math.PI/180)/(s.canvas.width/s.canvas.height),0,0,0,0,1/Math.tan(t.fov*Math.PI/180),0,0,0,0,-(p+.1)/(p-.1),-1,0,0,-2*p*.1/(p-.1),0])}t={type:e,...s.current[t.n]=s.next[t.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...t,f:0},s.models[t.type]?.vertices&&!s.models?.[t.type].verticesBuffer&&(s.gl.bindBuffer(34962,s.models[t.type].verticesBuffer=s.gl.createBuffer()),s.gl.bufferData(34962,new Float32Array(s.models[t.type].vertices),35044),!s.models[t.type].normals&&s.smooth&&s.smooth(t),s.models[t.type].normals&&(s.gl.bindBuffer(34962,s.models[t.type].normalsBuffer=s.gl.createBuffer()),s.gl.bufferData(34962,new Float32Array(s.models[t.type].normals.flat()),35044))),s.models[t.type]?.uv&&!s.models[t.type].uvBuffer&&(s.gl.bindBuffer(34962,s.models[t.type].uvBuffer=s.gl.createBuffer()),s.gl.bufferData(34962,new Float32Array(s.models[t.type].uv),35044)),s.models[t.type]?.indices&&!s.models[t.type].indicesBuffer&&(s.gl.bindBuffer(34963,s.models[t.type].indicesBuffer=s.gl.createBuffer()),s.gl.bufferData(34963,new Uint16Array(s.models[t.type].indices),35044)),t.t?t.t&&!t.mix&&(t.mix=0):t.mix=1,s.next[t.n]=t},draw:(t,e,i,o,r=[])=>{const n=performance.now();if(e=t-s.lastFrame,s.lastFrame=t,requestAnimationFrame(s.draw),s.debugFBO)renderFBOToCanvas();else{for(o in s.next.camera.g&&s.render(s.next[s.next.camera.g],e,1),i=s.animation("camera"),s.next?.camera?.g&&i.preMultiplySelf(s.next[s.next.camera.g].M||s.next[s.next.camera.g].m),s.gl.uniformMatrix4fv(s.uniformLocations.eye,!1,i.toFloat32Array()),i.invertSelf(),i.preMultiplySelf(s.projection),s.gl.uniformMatrix4fv(s.uniformLocations.pv,!1,i.toFloat32Array()),s.wjsHooks.emitSync("shadow_draw",s),s.gl.clear(16640),s.next){const t=s.next[o];t.isInstanced||t.t||1!=s.col(t.b)[3]?r.push(t):s.render(t,e)}for(o of(r.sort(((t,e)=>s.dist(e)-s.dist(t))),s.gl.enable(3042),s.gl.depthMask(1),r))o.isInstanced&&s.render(o,e);for(o of r)o.isInstanced||s.render(o,e);s.gl.depthMask(1),s.gl.disable(3042),s.gl.uniform3f(s.uniformLocations.light,s.lerp("light","x"),s.lerp("light","y"),s.lerp("light","z")),t-s.lastReportTime>=1e3&&(s.drawTime=(performance.now()-n).toFixed(2)+"ms",s.lastReportTime=t)}},render:(t,e,i=["camera","light","group"].includes(t.type),o)=>{if(t.t&&(s.gl.activeTexture(s.gl.TEXTURE0),s.gl.bindTexture(3553,s.textures[t.t.id]),s.gl.uniform1i(s.uniformLocations.sampler,0),s.gl.uniform2f(s.uniformLocations.tiling,t.tile?.[0]||1,t.tile?.[1]||1)),t.isInstanced||(t.f<t.a&&(t.f+=e),t.f>t.a&&(t.f=t.a),s.next[t.n].m=s.animation(t.n),s.next[t.g]&&s.next[t.n].m.preMultiplySelf(s.next[t.g].M||s.next[t.g].m),i||(s.gl.uniformMatrix4fv(s.uniformLocations.m,!1,(s.next[t.n].M||s.next[t.n].m).toFloat32Array()),s.gl.uniformMatrix4fv(s.uniformLocations.im,!1,new DOMMatrix(s.next[t.n].M||s.next[t.n].m).invertSelf().toFloat32Array()))),!i){if(s.gl.bindBuffer(34962,s.models[t.type].verticesBuffer),s.gl.vertexAttribPointer(o=s.attribLocations.pos,3,5126,!1,0,0),s.gl.enableVertexAttribArray(o),s.gl.vertexAttribDivisor(o,0),s.models[t.type].uvBuffer&&(s.gl.bindBuffer(34962,s.models[t.type].uvBuffer),s.gl.vertexAttribPointer(o=s.attribLocations.uv,2,5126,!1,0,0),s.gl.enableVertexAttribArray(o),s.gl.vertexAttribDivisor(o,0)),(t.s||s.models[t.type].customNormals)&&s.models[t.type].normalsBuffer&&(s.gl.bindBuffer(34962,s.models[t.type].normalsBuffer),s.gl.vertexAttribPointer(o=s.attribLocations.normal,3,5126,!1,0,0),s.gl.enableVertexAttribArray(o),s.gl.vertexAttribDivisor(o,0)),s.gl.uniform1i(s.uniformLocations.isInstanced,t.isInstanced?1:0),t.isInstanced&&s.instanceMatrixBuffers[t.n]){const e=s.instanceMatrixBuffers[t.n];s.gl.bindBuffer(s.gl.ARRAY_BUFFER,e);const i=s.attribLocations.instanceModelMatrix,o=16*Float32Array.BYTES_PER_ELEMENT;for(let t=0;t<4;++t){const e=i+t;s.gl.enableVertexAttribArray(e),s.gl.vertexAttribPointer(e,4,s.gl.FLOAT,!1,o,4*t*Float32Array.BYTES_PER_ELEMENT),s.gl.vertexAttribDivisor(e,1)}}s.gl.uniform4f(s.uniformLocations.o,t.s,(t.mode>3||s.gl[t.mode]>3)&&!t.ns?1:0,s.ambientLight||.2,t.mix),s.gl.uniform4f(s.uniformLocations.bb,t.w,t.h,"billboard"==t.type,0);const e=s.attribLocations.col;if(t.isInstanced?(s.gl.enableVertexAttribArray(e),s.gl.bindBuffer(s.gl.ARRAY_BUFFER,s.instanceColorBuffers[t.n]),s.gl.vertexAttribPointer(e,4,s.gl.FLOAT,!1,0,0),s.gl.vertexAttribDivisor(e,1)):s.gl.vertexAttrib4fv(e,s.col(t.b||"888")),s.models[t.type].indicesBuffer?(s.gl.bindBuffer(34963,s.models[t.type].indicesBuffer),t.isInstanced?s.gl.drawElementsInstanced(+t.mode||s.gl[t.mode],s.models[t.type].indices.length,s.gl.UNSIGNED_SHORT,0,t.numInstances):s.gl.drawElements(+t.mode||s.gl[t.mode],s.models[t.type].indices.length,5123,0)):t.isInstanced?s.gl.drawArraysInstanced(+t.mode||s.gl[t.mode],0,s.models[t.type].vertices.length/3,t.numInstances):s.gl.drawArrays(+t.mode||s.gl[t.mode],0,s.models[t.type].vertices.length/3),t.isInstanced){const t=s.attribLocations.instanceModelMatrix;for(let e=0;e<4;++e)s.gl.vertexAttribDivisor(t+e,0),s.gl.disableVertexAttribArray(t+e);s.gl.vertexAttribDivisor(e,0),s.gl.disableVertexAttribArray(e)}}},lerp:(t,e)=>s.next[t]?.a?s.current[t][e]+(s.next[t][e]-s.current[t][e])*(s.next[t].f/s.next[t].a):s.next[t][e],animation:(t,e=new DOMMatrix)=>s.next[t]?e.translateSelf(s.lerp(t,"x"),s.lerp(t,"y"),s.lerp(t,"z")).rotateSelf(s.lerp(t,"rx"),s.lerp(t,"ry"),s.lerp(t,"rz")).scaleSelf(s.lerp(t,"w"),s.lerp(t,"h"),s.lerp(t,"d")):e,dist:(t,e=s.next.camera)=>t?.m&&e?.m?(e.m.m41-t.m.m41)**2+(e.m.m42-t.m.m42)**2+(e.m.m43-t.m.m43)**2:0,ambient:t=>s.ambientLight=t,col:t=>[...t.replace("#","").match(t.length<5?/./g:/../g).map((e=>("0x"+e)/(t.length<5?15:255))),1],add:(t,e)=>{s.models[t]=e,e.normals&&(s.models[t].customNormals=1),s[t]=e=>s.setState(e,t)},resetView:()=>{s.gl.viewport(0,0,s.gl.canvas.width,s.gl.canvas.height),s.setState({n:"camera",fov:s.next.camera.fov})},group:t=>s.setState(t,"group"),move:(t,e)=>setTimeout((()=>{s.setState(t)}),e||1),delete:(t,e)=>setTimeout((()=>{delete s.next[t]}),e||1),camera:(t,e)=>setTimeout((()=>{s.setState(t,t.n="camera")}),e||1),light:(t,e)=>e?setTimeout((()=>{s.setState(t,t.n="light")}),e):s.setState(t,t.n="light"),smooth:(t,e={},i=[],o,r,n,a,l,c,d,h,u,m,p)=>{for(s.models[t.type].normals=[],n=0;n<s.models[t.type].vertices.length;n+=3)i.push(s.models[t.type].vertices.slice(n,n+3));for((o=s.models[t.type].indices)?r=1:(o=i,r=0),n=0;n<2*o.length;n+=3){a=n%o.length,l=i[h=r?s.models[t.type].indices[a]:a],c=i[u=r?s.models[t.type].indices[a+1]:a+1],d=i[m=r?s.models[t.type].indices[a+2]:a+2];var f=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],g=[d[0]-c[0],d[1]-c[1],d[2]-c[2]];p=n>a?[0,0,0]:[f[1]*g[2]-f[2]*g[1],f[2]*g[0]-f[0]*g[2],f[0]*g[1]-f[1]*g[0]],e[l[0]+"_"+l[1]+"_"+l[2]]||=[0,0,0],e[c[0]+"_"+c[1]+"_"+c[2]]||=[0,0,0],e[d[0]+"_"+d[1]+"_"+d[2]]||=[0,0,0],s.models[t.type].normals[h]=e[l[0]+"_"+l[1]+"_"+l[2]]=e[l[0]+"_"+l[1]+"_"+l[2]].map(((t,e)=>t+p[e])),s.models[t.type].normals[u]=e[c[0]+"_"+c[1]+"_"+c[2]]=e[c[0]+"_"+c[1]+"_"+c[2]].map(((t,e)=>t+p[e])),s.models[t.type].normals[m]=e[d[0]+"_"+d[1]+"_"+d[2]]=e[d[0]+"_"+d[1]+"_"+d[2]].map(((t,e)=>t+p[e]))}}};s.add("plane",{vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]}),s.add("billboard",s.models.plane),s.add("cube",{vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]}),s.cube=t=>s.setState(t,"cube"),s.add("pyramid",{vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]}),((t,e,i,o,r,n,a=[],l=[],c=[],d=20)=>{for(i=0;i<=d;i++)for(o=i*Math.PI/d,t=0;t<=d;t++)e=2*t*Math.PI/d,a.push(+(Math.sin(e)*Math.sin(o)/2).toFixed(6),+(Math.cos(o)/2).toFixed(6),+(Math.cos(e)*Math.sin(o)/2).toFixed(6)),c.push(3.5*Math.sin(t/d),-Math.sin(i/d)),t<d&&i<d&&l.push(r=i*(d+1)+t,n=r+(d+1),r+1,r+1,n,n+1);s.add("sphere",{vertices:a,uv:c,indices:l})})();const r=s,n={speedH:3,speedL:8,speedAdd:.1,jumpYVel:5,fov:35,colorClear:"#7A4141",world:null,bodylist:new Array,bodylistNotPys:new Array,bodylistMass0:new Array,canvas:null,initWorld:function(t){this.canvas=window.document.getElementById(t),this.initW(this.canvas),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.SAPBroadphase(this.world),this.world.solver.iterations=10,this.world.addContactMaterial(this.cannonDefaultCantactMaterial),this.initBodyTypeArray(1e6),this.eventListener(),this.animate(),shiftInfo.textContent="速度:0 | "},initW:function(t){const e=this.W;t.width=window.innerWidth/1,t.height=window.innerHeight/1,e.reset(t),e.ambient(.7),e.light({x:.5,y:-.3,z:.5}),e.clearColor(this.colorClear),e.camera({n:"camera",fov:this.fov}),e.group({n:"posZero",x:0,y:1,z:0}),e.cube({g:"posZero",x:5,w:10,h:.5,d:.5,b:"f44"}),e.cube({g:"posZero",y:5,h:10,w:.5,d:.5,b:"4f4"}),e.cube({g:"posZero",z:5,d:10,w:.5,h:.5,b:"44f"}),e.pyramid({g:"posZero",size:1,x:10,rz:-90,b:"f44"}),e.pyramid({g:"posZero",size:1,y:10,b:"4f4"}),e.pyramid({g:"posZero",n:"test0001",size:1,z:10,rx:90,b:"44f"}),e.sphere({n:"posZeroSphere",x:0,y:0,z:0,size:5,s:1,b:"#FF145B"})}},a={textureMap:new Map,loadTextureIndex:1,loadTexture:function(t){return new Promise((e=>{for(var i=!0,o=0;o<t.length;o++)if(!1===this.textureMap.has(t[o].id)){i=!1;const s=new Image;s.onload=()=>e(s),s.id=t[o].id+"-"+this.loadTextureIndex,s.src=this.dToBase64(t[o]),this.textureMap.set(t[o].id,s),this.loadTextureIndex++}i&&e(null)}))},canvasObj:document.createElement("canvas"),dToBase64:function(t){const e=this.canvasObj;e.width=t.width||400,e.height=t.height||400;const i=e.getContext("2d");if("png"===t.type)return t.func(i,e.width,e.height,t,this),e.toDataURL("image/png");i.fillStyle="white",i.fillRect(0,0,e.width,e.height),t.func(i,e.width,e.height,t,this);var o=t.quality||.7;return e.toDataURL("image/jpeg",o)},errorTexture:function(t,e,i,o,s){s.hooks.emitSync("errorTexture_diy",t,e,i,o,s)}},l={keys:{viewForward:0,viewBackward:0,turnRight:0,turnLeft:0,turnUp:0,turnDown:0,viewUp:0,viewDown:0,viewLeft:0,viewRight:0,shiftKeyvalue:0,jumping:0,frozen:0},keyMap:{w:"viewForward",s:"viewBackward",a:"viewLeft",d:"viewRight",i:"viewUp",v:"viewDown",o:"turnUp",p:"turnDown",k:"viewLeft",l:"viewRight",b:"frozen",arrowup:"viewForward",arrowdown:"viewBackward",arrowleft:"turnLeft",arrowright:"turnRight"},isShiftPress:0,antiDizzyMode:!1,isPointerLock:function(){return document.pointerLockElement===this.canvas||document.mozPointerLockElement===this.canvas||document.webkitPointerLockElement===this.canvas},eventListener:function(){var t=this,e=!1;document.addEventListener("keydown",(function(e){t._handleKey(e,1)})),document.addEventListener("keyup",(function(e){t._handleKey(e,0)})),document.addEventListener("mousemove",(function(i){e&&(t.keys.turnRight-=.1*i.movementX,t.keys.turnUp-=.1*i.movementY)})),this.canvas.addEventListener("click",(i=>{this.canvas.requestPointerLock=this.canvas.requestPointerLock||this.canvas.mozRequestPointerLock||this.canvas.webkitRequestPointerLock,this.canvas.requestPointerLock(),e=!0,document.pointerLockElement&&t.hooks.emitSync("pointer_lock_click",t,i)})),this.lockChangeAlert=function(){e=document.pointerLockElement===t.canvas||document.mozPointerLockElement===t.canvas||document.webkitPointerLockElement===t.canvas},document.addEventListener("pointerlockchange",this.lockChangeAlert,!1),document.addEventListener("mozpointerlockchange",this.lockChangeAlert,!1),document.addEventListener("webkitpointerlockchange",this.lockChangeAlert,!1),window.addEventListener("resize",(()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.W.resetView()}))},_handleKey:function(t,e){if(this.isPointerLock()){var i=this.keyMap[t.key.toLowerCase()];if(i&&(this.keys[i]=e),(32===t.keyCode||"e"===t.key.toLowerCase())&&null!==this.mainVPlayer){var o=this.mainVPlayer.body.position.y<=1e4;0===this.keys.jumping&&o&&(this.mainVPlayer.body.velocity.y=this.jumpYVel),this.keys.jumping=e}16!==t.keyCode&&"q"!==t.key.toLowerCase()||(this.isShiftPress=e)}},forwardAcc:0,displayPOS:function(){var t=document.getElementById("posInfo");null!==this.mainVPlayer&&(t.textContent="位置: X:"+this.mainVPlayer.body.position.x.toFixed(2)+", Y:"+this.mainVPlayer.body.position.y.toFixed(2)+", Z:"+this.mainVPlayer.body.position.z.toFixed(2)+", | ")},calMovePara:function(t,e,i,o,s,r){const n=this.keys;if(n.viewForward||n.viewBackward){var a=this.isShiftPress?Math.max(this.speedH,this.speedL-(this.forwardAcc+=this.speedAdd)):this.speedL+0*(this.forwardAcc=.01);shiftInfo.textContent="速度:"+Math.round(100/a)+" | ",i+=(-n.viewForward+n.viewBackward)*Math.cos(s*Math.PI/180)/a,t+=(-n.viewForward+n.viewBackward)*Math.sin(s*Math.PI/180)/a,this.displayPOS()}return(n.viewLeft||n.viewRight)&&(i+=(-n.viewLeft+n.viewRight)*Math.cos((s+90)*Math.PI/180)/10,t+=(-n.viewLeft+n.viewRight)*Math.sin((s+90)*Math.PI/180)/10,this.displayPOS()),(n.viewUp||n.viewDown)&&(e=150),s=this.keys.turnRight,{x:t,y:e,z:i,rx:this.keys.turnUp,ry:s,rz:r}},mainVPlayer:null,mainCamera:{groupName:null,pos:{x:0,y:2,z:4},qua:{rx:0,ry:0,rz:0}},isMVPInit:!1,Y_AXIS:new CANNON.Vec3(0,1,0),DEG_TO_RAD:Math.PI/180,mainVPlayerMove:function(t){if(null===t)return;var e=this.mainCamera;!1===this.isMVPInit&&(e.groupName=t.name,this.isMVPInit=!0);var i=t.body.position,o=t.body.quaternion,s=this.calMovePara(i.x,i.y,i.z,e.qua.rx,e.qua.ry,e.qua.rz);t.body.position.x=s.x,t.body.position.y=s.y,t.body.position.z=s.z,e.qua=s,o.setFromAxisAngle(this.Y_AXIS,this.DEG_TO_RAD*s.ry),this.W.camera({g:t.name,x:e.pos.x,y:e.pos.y,z:e.pos.z,rx:e.qua.rx,rz:e.qua.rz});let r=t.body.position,n=t.body.quaternion,a=this.quaternionToEuler(n);return t.quat=n,t.rX=a.rX,t.rY=a.rY,t.rZ=a.rZ,t.X=r.x,t.Y=r.y,t.Z=r.z,this.W.move({n:t.name,x:t.X,y:t.Y,z:t.Z,rx:t.rX,ry:t.rY,rz:t.rZ}),t.posID=this.calPosID(t.X,t.Y,t.Z,2),0}},c={calPosID:function(t,e,i,o){const s={2:100,3:100,4:40}[o]||0;if(2===o&&(o=""),0===s)return 0;var r=-1===Math.sign(t)?"X":"D",n=-1===Math.sign(i)?"B":"N";return o+r+Math.ceil(t/s*Math.sign(t))+n+Math.ceil(i/s*Math.sign(i))},gridsize:new Uint16Array([1e4,1e3,100,20]),currentlyActiveIndices:new Set,activationQueue:new Array,dynaNodes_lab:function(){if(null===this.mainVPlayer||this.stopDynaNodes)return"";const t=this.mainVPlayer,e=[];for(let i=0;i<this.gridsize.length;i++){const o=Math.floor(t.X/this.gridsize[i]),s=Math.floor(t.Z/this.gridsize[i]);for(let t=-1;t<=1;t++)for(let r=-1;r<=1;r++)e.push(`${i}_${o+t}_${s+r}`)}const i=new Set,o=new Set(this.currentlyActiveIndices);for(const o of e){const e=this.spatialGrid.get(o);if(e)for(const o of e)Math.abs(this.positionsStatus[8*o+1]-t.Y)<this.gridsize[this.physicsProps[8*o+4]]&&i.add(o)}for(const t of i)o.delete(t);for(const t of i)if(!this.currentlyActiveIndices.has(t)){const e=8*t;this.positionsStatus[e+7]=this.physicsProps[e],this.activeTABox(t)}for(const t of o){const e=8*t;this.positionsStatus[e+7]=-1,this.hiddenTABox(t)}this.currentlyActiveIndices=i,this.activationQueue.length>0&&!this.isActivationScheduled&&(this.isActivationScheduled=!0,requestIdleCallback(this._processActivationQueue.bind(this)))}},d={allGroupNum:1,stoneGroupNum:2,bodyObjName:0,positionsStatusTA:null,bodyProp:null,physicsPropsTA:null,freeSlots:null,indexToArgs:new Map,spatialGrid:new Map,initBodyTypeArray:function(t=1e6){this.positionsStatus=new Float32Array(8*t),this.physicsProps=new Float32Array(8*t),this.freeSlots=new Array(t).fill(0).map(((e,i)=>t-1-i))},addTABox:function({DPZ:t=3,X:e=5,Y:i=5,Z:o=5,quat:s={x:0,y:0,z:0,w:1},mass:r=0,width:n=1,depth:a=1,height:l=1,size:c=1}={}){const d=Array.from(arguments)[0];if(1!==c&&(n=a=l=c),0===this.freeSlots.length)return alert("BodyTypeArray 容量已达上限，需要扩容！"),!1;const h=this.freeSlots.pop(),u=8*h;this.positionsStatus[u]=e,this.positionsStatus[u+1]=i,this.positionsStatus[u+2]=o,this.positionsStatus[u+3]=s.x,this.positionsStatus[u+4]=s.y,this.positionsStatus[u+5]=s.z,this.positionsStatus[u+6]=s.w,this.positionsStatus[u+7]=r,this.physicsProps[u]=r,this.physicsProps[u+1]=n,this.physicsProps[u+2]=l,this.physicsProps[u+3]=a,this.physicsProps[u+4]=t;const m=`${t}_${Math.floor(e/this.gridsize[t])}_${Math.floor(o/this.gridsize[t])}`;let p=this.spatialGrid.get(m);p||(p=[]),p.push(h),this.spatialGrid.set(m,p),this.indexToArgs.set(h,d)},defaultBoxArgs:{isPhysical:!0,isVisualMode:!0,DPZ:3,colliGroup:2,texture:null,smooth:0,background:"#888",mixValue:.71,rX:0,rY:0,rZ:0,isShadow:0,tiling:[1,1],shape:"cube",isFictBody:!1},activeTABox:function(t){const e=8*t,i=this.positionsStatus.subarray(e,e+8),o=this.physicsProps.subarray(e,e+4),s=this.indexToArgs.get(t),r={...this.defaultBoxArgs,...s};if(r.isPhysical){const t=new CANNON.Body;var n;if(t.mass=o[0],t.type=0===o[0]?CANNON.Body.STATIC:CANNON.Body.DYNAMIC,"sphere"===r.shape)n=new CANNON.Sphere(o[1]/2);else{const t=new CANNON.Vec3(o[1]/2,o[2]/2,o[3]/2);n=new CANNON.Box(t)}t.addShape(n),t.position.set(i[0],i[1],i[2]),t.material=this.cannonDefaultContactMaterial,t.updateMassProperties(),t.wakeUp(),t.collisionFilterGroup=r.colliGroup;const e={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};t.collisionFilterMask=e[r.colliGroup],this.world.addBody(t),t.quaternion.set(i[3],i[4],i[5],i[6]),s.cannonBody=t}if(!1!==r.isVisualMode){var a=r.tiling;if(0!==i[3]){var l=this.quaternionToEuler({x:i[3],y:i[4],z:i[5],w:i[6]});r.rX=l.x,r.rY=l.y,r.rZ=l.z}"number"==typeof a&&(a=[a,a]);const e=r.isFictBody?.1:0;var c,d=!1;if("string"==typeof r.texture?void 0!==window[r.texture]||this.textureMap.has(r.texture)?c=this.textureMap.has(r.texture)?this.textureMap.get(r.texture):window[r.texture]:(c=null,d=!0):c=r.texture,this.W[r.shape]({n:"T"+t,w:o[1]-e,d:o[3]-e,h:o[2]-e,x:i[0],y:i[1],z:i[2],t:c,s:r.smooth,tile:a,rx:r.rX,ry:r.rY,rz:r.rZ,b:r.background,mix:r.mixValue,shadow:r.isShadow}),d){const i=40,s=(o[1]-e)*i,n=(o[2]-e)*i;this.loadTexture([{func:this.errorTexture,id:r.texture,type:"png",width:s,height:n,index:t}]).then((e=>{this.W[r.shape]({n:"T"+t,t:this.textureMap.get(r.texture),mix:r.mixValue})}))}}},hiddenTABox:function(t){const e=this.indexToArgs.get(t);!1!==e.isPhysical&&void 0!==e.cannonBody&&this.world.removeBody(e.cannonBody),!1!==e.isVisualMode&&this.W.delete("T"+t)},addBox:function({DPZ:t=2,isPhysical:e=!0,isVisualMode:i=!0,kk:o=0,colliGroup:s=2,name:r="k"+this.bodyObjName++,X:n=5,Y:a=5,Z:l=5,quat:c=null,isShadow:d=0,tiling:h=[1,1],shape:u="cube",mass:m=0,width:p=1,depth:f=1,height:g=1,size:y=1,texture:v=null,smooth:x=0,background:w="#888",mixValue:b=.71,rX:M=0,rY:A=0,rZ:S=0}={}){var P=Array.from(arguments),B=this.calPosID(n,a,l,t);1!==y&&(p=f=g=y);var _=null;if(e){var k;if("sphere"===u)k=new CANNON.Sphere(p/2);else{const t=new CANNON.Vec3(p/2,g/2,f/2);k=new CANNON.Box(t)}(_=new CANNON.Body({mass:m,shape:k,position:new CANNON.Vec3(n,a,l),material:this.cannonDefaultCantactMaterial})).collisionFilterGroup=s;const t={1:this.stoneGroupNum|this.allGroupNum,2:this.allGroupNum};_.collisionFilterMask=t[s],this.world.addBody(_),c&&_.quaternion.set(c.x,c.y,c.z,c.w),c=_.quaternion}i&&("number"==typeof h&&(h=[h,h]),this.W[u]({n:r,w:p,d:f,h:g,x:n,y:a,z:l,t:v,s:x,tile:h,rx:M,ry:A,rz:S,b:w,mix:b,shadow:d}));var L={name:r,body:_,X:n,Y:a,Z:l,rX:M,rY:A,rZ:S,isVisualMode:i,myargs:P,posID:B,DPZ:t,quat:c};switch(!0){case!1===e:this.bodylistNotPys.push(L);break;case 0===m:this.bodylistMass0.push(L);break;default:this.bodylist.push(L)}return L}},h={hooks:i,W:r,...o,...n,...a,...l,...c,...d,gridKeyCurrentTime:0,updataBodylist:function(){this.dynaNodes_lab();for(const i of this.currentlyActiveIndices){const o=8*i;if(this.positionsStatus[o+7]>0){const s=this.indexToArgs.get(i),r=s.cannonBody;if(!r)continue;const n=r.position.x-this.positionsStatus[o],a=r.position.y-this.positionsStatus[o+1],l=r.position.z-this.positionsStatus[o+2],c=Math.sqrt(n*n+a*a+l*l);if(this.positionsStatus[o]=r.position.x,this.positionsStatus[o+1]=r.position.y,this.positionsStatus[o+2]=r.position.z,this.positionsStatus[o+3]=r.quaternion.x,this.positionsStatus[o+4]=r.quaternion.y,this.positionsStatus[o+5]=r.quaternion.z,this.positionsStatus[o+6]=r.quaternion.w,!1!==s.isVisualMode&&this.W.next["T"+i]&&c>1e-4){const n=this.quaternionToEuler(r.quaternion);if(this.W.move({n:"T"+i,x:this.positionsStatus[o],y:this.positionsStatus[o+1],z:this.positionsStatus[o+2],rx:n.rX,ry:n.rY,rz:n.rZ}),c>.01&&performance.now()-this.gridKeyCurrentTime>500){const r=s.gridkey||0,n=this.physicsProps[o+4],a=`${n}_${Math.floor(this.positionsStatus[o]/this.gridsize[n])}_${Math.floor(this.positionsStatus[o+2]/this.gridsize[n])}`;if(r&&a!==r){var t=this.spatialGrid.get(r);if(t){const e=t.indexOf(i);e>-1&&(t.splice(e,1),this.spatialGrid.set(r,t))}var e=this.spatialGrid.get(a);e||(e=[]),e.push(i),this.spatialGrid.set(a,e)}s.gridkey=a,this.gridKeyCurrentTime=performance.now()}}}}},cannonAni:function(){this.world.step(1/60)},fpsFrameCount:0,lastTime:performance.now(),isFirstShowFPS:!0,showFPS1S:function(){var t=performance.now(),e=t-this.lastTime;if(this.fpsFrameCount++,e>1e3||this.isFirstShowFPS){this.isFirstShowFPS=!1;var i=this.fpsFrameCount/(e/1e3);this.fpsFrameCount=0,this.lastTime=t,this._showMemory(),this.displayPOS();const s=this.mainVPlayer;var o=this.calPosID(s?.X,s?.Y,s?.Z,2);posIDMVP.textContent=o.replace(/[Dd]/g,"东").replace(/[Xx]/g,"西").replace(/[Nn]/g,"南").replace(/[Bb]/g,"北"),fpsInfo.textContent="FPS："+i.toFixed(1)+"  ，渲染："+this.W.drawTime,modListCount.textContent="当前模型数："+this.bodylist.length+" - ❀"+this.bodylistNotPys.length+" - 口"+this.bodylistMass0.length+" - ⚡️ "+this.currentlyActiveIndices.size+`（can ${this.world.bodies.length}）`+`（${this.indexToArgs.size}）`+`（纹理：${this.textureMap.size}） |`}},_showMemory:function(){var t=document.getElementById("metrics");if(performance.memory){const e=performance.memory;t.textContent=`内存: ${(e.usedJSHeapSize/1048576).toFixed(1)}MB/${(e.jsHeapSizeLimit/1048576).toFixed(1)}MB | `}},animate:function(){var t=this;const e=function(){t.showFPS1S(),t.cannonAni(),t.updataBodylist(),t.mainVPlayerMove(t.mainVPlayer),requestAnimationFrame(e)};e()}};window.ccgxk=h;const u=h;return e})()));