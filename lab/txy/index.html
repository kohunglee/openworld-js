<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="UTF-8">
    <title>极简 WebSocket 聊天室</title>
</head>
<body>

    <h1>WebSocket 聊天室</h1>

    <p><b>状态:</b> <span id="status">正在连接...</span> | <b>在线人数:</b> <span id="user-count">0</span></p>

    <!-- 聊天消息将显示在这里 -->
    <div id="chat-box" style="border: 1px solid black; width: 600px; height: 300px; overflow-y: scroll; padding: 5px; margin-bottom: 10px;">
    </div>

    <!-- 输入框和发送按钮 -->
    <input type="text" id="message-input" size="60" placeholder="在这里输入消息...">
    <button id="send-button">发送</button>


    <script>
        // const WEBSOCKET_URI = 'wss://1251631157-k3oer1a0l3.ap-hongkong.tencentscf.com';
        const WEBSOCKET_URI = 'ws://wsslib.ccgxk.com';

        // --- 获取页面元素 ---
        const statusElem = document.getElementById('status');
        const userCountElem = document.getElementById('user-count');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        let ws = new WebSocket(WEBSOCKET_URI);  // 创建连接


        // 添加信息到框里
        function addMessageToBox(message, prefix = '') {
            const messageElem = document.createElement('div');
            messageElem.textContent = prefix + message;
            chatBox.appendChild(messageElem);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 连接
        ws.onopen = function() {
            statusElem.textContent = '已连接';
            statusElem.style.color = 'green';
            addMessageToBox('成功连接到服务器！', '系统消息: ');
        };

        // 断开
        ws.onclose = function() {
            statusElem.textContent = '已断开';
            statusElem.style.color = 'red';
            addMessageToBox('与服务器的连接已断开。', '系统消息: ');
        };

        // 出错
        ws.onerror = function(error) {
            statusElem.textContent = '连接错误';
            statusElem.style.color = 'red';
            addMessageToBox('连接发生错误，请查看浏览器控制台获取详情。', '系统消息: ');
            console.error('WebSocket Error:', error);
        };

        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'count':
                        userCountElem.textContent = data.count;
                        break;
                    case 'message':
                        addMessageToBox(data.content, '收到消息: ');
                        break;
                    default:
                        addMessageToBox(event.data, '收到未知类型消息: ');
                }
            } catch (e) {
                // 如果不是 JSON 格式，就当成普通消息（比如之前的ECHO）
                addMessageToBox(event.data, '收到非JSON消息: ');
            }
        };


        // --- 发送消息的逻辑 ---

        function sendMessage() {
            const message = messageInput.value.trim() + '-';
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                addMessageToBox(message, '你发送了: ');
                messageInput.value = ''; // 清空输入框
            }
        }

        // 点击按钮发送
        sendButton.addEventListener('click', sendMessage);

        // 按下 Enter 键发送
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

    </script>

</body>
</html>